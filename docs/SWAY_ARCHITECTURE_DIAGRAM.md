# Sway Configuration Architecture Diagram

## Configuration Layer Stack

```
┌─────────────────────────────────────────────────────────────────────┐
│  Layer 1: Runtime User Configuration (Hot-Reloadable, NO rebuild)   │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  ~/.config/sway/                                              │  │
│  │  ├── keybindings.toml           (User keybindings)            │  │
│  │  ├── window-rules.json          (Floating, sizing rules)      │  │
│  │  ├── workspace-assignments.json (Workspace/output assignments)│  │
│  │  └── appearance.json            (Colors, gaps, borders)       │  │
│  │                                                               │  │
│  │  Edited by: User (manual) or sway-config-manager             │  │
│  │  Reloaded by: swaymsg reload (instant, <100ms)              │  │
│  │  Managed by: sway-config-manager daemon                      │  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                                    ▲
                                    │ (includes)
                                    │
┌─────────────────────────────────────────────────────────────────────┐
│  Layer 2: Generated Configuration (Auto-Generated, Hot-Reloadable)   │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  ~/.config/sway/                                              │  │
│  │  ├── keybindings-generated.conf (Compiled from TOML)          │  │
│  │  ├── appearance-generated.conf  (Compiled from JSON)          │  │
│  │  └── modes.conf                 (Workspace navigation modes)  │  │
│  │                                                               │  │
│  │  Generated by: sway-config-manager daemon                     │  │
│  │  Validation by: JSON schema validation                        │  │
│  │  Git tracking: Auto-commit on successful reload              │  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                                    ▲
                                    │ (includes)
                                    │
┌─────────────────────────────────────────────────────────────────────┐
│  Layer 3: Home-Manager Sway Config (Static, Requires rebuild)        │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  home-modules/desktop/sway.nix                                │  │
│  │  ┌─────────────────────────────────────────────────────────┐  │  │
│  │  │  let isHeadless = detect_platform()                     │  │  │
│  │  │  in {                                                   │  │  │
│  │  │    output = if isHeadless then {                        │  │  │
│  │  │      HEADLESS-1/2/3 with 1920x1200@60Hz                │  │  │
│  │  │    } else {                                             │  │  │
│  │  │      eDP-1 (2560x1600@60Hz, 2.0x)                       │  │  │
│  │  │      HDMI-A-1 (1920x1080@60Hz, 1.0x)                   │  │  │
│  │  │    };                                                   │  │  │
│  │  │                                                         │  │  │
│  │  │    input = {                                            │  │  │
│  │  │      type:touchpad (M1 only)                            │  │  │
│  │  │      type:keyboard (M1 only)                            │  │  │
│  │  │    };                                                   │  │  │
│  │  │                                                         │  │  │
│  │  │    workspaceOutputAssign = if isHeadless then [         │  │  │
│  │  │      1,2 → HEADLESS-1                                   │  │  │
│  │  │      3,4,5 → HEADLESS-2                                 │  │  │
│  │  │      6-9 → HEADLESS-3                                   │  │  │
│  │  │    ] else [                                             │  │  │
│  │  │      1,2 → eDP-1                                        │  │  │
│  │  │      3+ → HDMI-A-1                                      │  │  │
│  │  │    ];                                                   │  │  │
│  │  │  }                                                       │  │  │
│  │  └─────────────────────────────────────────────────────────┘  │  │
│  │                                                               │  │
│  │  + window.commands (system UI: walker, fzf, floating)         │  │
│  │  + startup commands (dbus, i3pm daemon, workspace reassign)   │  │
│  │  + extraConfig (focus behavior, mouse handling)               │  │
│  │  + VNC services (headless only)                               │  │
│  │  + Tailscale audio service (headless only)                    │  │
│  │  + Wayland packages (wl-clipboard, grim, etc.)                │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  home-modules/desktop/swaybar.nix                                   │
│  ├── 6 bars (headless: 2 per output × 3)                           │
│  └── 4 bars (M1: 2 per output × 2)                                 │
└─────────────────────────────────────────────────────────────────────┘
                                    ▲
                                    │ (sets)
                                    │
┌─────────────────────────────────────────────────────────────────────┐
│  Layer 4: System Sway Config (System-wide, Requires rebuild)         │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  modules/desktop/sway.nix                                     │  │
│  │  ├── Enable Sway compositor                                  │  │
│  │  ├── XWayland support                                        │  │
│  │  ├── Polkit security                                         │  │
│  │  ├── D-Bus service                                           │  │
│  │  ├── PipeWire audio                                          │  │
│  │  ├── Seatd for DRM access                                    │  │
│  │  └── Default session setup                                   │  │
│  │                                                               │  │
│  │  modules/desktop/wayvnc.nix                                   │  │
│  │  └── VNC server dependencies (headless only)                 │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  configurations/hetzner-sway.nix                                    │
│  ├── WLR_BACKENDS=headless                                         │
│  ├── WLR_HEADLESS_OUTPUTS=3                                        │
│  ├── WLR_LIBINPUT_NO_DEVICES=1                                     │
│  ├── WLR_RENDERER=pixman (cloud VM)                                │
│  ├── GSK_RENDERER=cairo (Walker GTK4)                              │
│  ├── greetd auto-login with env vars (shell wrapper)               │
│  ├── wayvnc firewall rules                                         │
│  └── i3pm daemon system service                                    │
│                                                                     │
│  configurations/m1.nix                                              │
│  ├── greetd with tuigreet UI                                       │
│  ├── XCURSOR_SIZE=48 (HiDPI)                                       │
│  ├── Asahi GPU support (optional)                                  │
│  ├── Display scaling for Retina                                    │
│  ├── libinput touchpad config                                      │
│  └── WiFi BCM4378 workarounds                                      │
│                                                                     │
│  modules/services/keyd.nix                                          │
│  └── CapsLock → F9 remapping (disabled, but available)             │
│                                                                     │
│  modules/services/i3-project-daemon.nix                             │
│  └── i3pm daemon for project management (system service)           │
└─────────────────────────────────────────────────────────────────────┘
```

## Configuration Decision Tree

```
Sway Starts (greetd login)
    ↓
Load Environment Variables
├── Headless mode:
│   ├── WLR_BACKENDS=headless
│   ├── WLR_HEADLESS_OUTPUTS=3
│   ├── WLR_LIBINPUT_NO_DEVICES=1
│   ├── WLR_RENDERER=pixman
│   ├── GSK_RENDERER=cairo ◄─ CRITICAL for Walker
│   └── All other Wayland vars
│
└── M1 mode:
    ├── QT_QPA_PLATFORM=wayland
    ├── GDK_BACKEND=wayland
    └── All other Wayland vars

    ↓

Load Nix-managed configuration (home-modules/desktop/sway.nix)
    ├── Detect platform: isHeadless = hostname == "nixos-hetzner-sway"
    │
    ├── If Headless:
    │   ├── Output config: HEADLESS-1/2/3 (1920x1200@60Hz, 1.0x)
    │   ├── Workspace dist: 1-2→H1, 3-5→H2, 6-9→H3
    │   ├── Input config: SKIPPED (WLR_LIBINPUT_NO_DEVICES=1)
    │   ├── Start VNC services: wayvnc on ports 5900/5901/5902
    │   └── No touchpad/keyboard config
    │
    └── Else (M1):
        ├── Output config: eDP-1 (2560x1600@60Hz, 2.0x) + HDMI-A-1
        ├── Workspace dist: 1-2→eDP, 3+→HDMI
        ├── Input config: ENABLED
        │   ├── Touchpad: natural scroll, tap-to-click, 3-finger middle
        │   └── Keyboard: US layout, 300ms repeat delay
        ├── No VNC services
        └── Intel GPU rendering

    ↓

Load sway-config-manager daemon
    ├── Create ~/.config/sway/ if missing
    ├── Copy templates from ~/.local/share/sway-config-manager/templates/
    │   ├── keybindings.toml
    │   ├── window-rules.json
    │   ├── workspace-assignments.json
    │   └── appearance.json
    │
    ├── Load user config: ~/.config/sway/*.{toml,json}
    ├── Validate against JSON schema
    ├── Merge user + Nix defaults
    ├── Generate .conf files:
    │   ├── keybindings-generated.conf
    │   ├── appearance-generated.conf
    │   └── modes.conf ◄─ PROBLEM: Hardcoded for HEADLESS-1/2/3
    │
    ├── Include in main Sway config:
    │   include ~/.config/sway/keybindings-generated.conf
    │   include ~/.config/sway/appearance-generated.conf
    │   include ~/.config/sway/modes.conf
    │
    └── Git commit changes (version control)

    ↓

Load Status Bars (swaybar)
    ├── If Headless: 6 bars (2 per output)
    │   ├── Each output has top bar (system monitor)
    │   └── Each output has bottom bar (project context)
    │
    └── Else (M1): 4 bars (2 per output)
        ├── eDP-1: top (monitor) + bottom (project + tray)
        └── HDMI-A-1: top (monitor) + bottom (project)

    ↓

Start Project Management Daemon (i3pm)
    ├── System service: /etc/systemd/user/i3-project-event-listener.service
    ├── Listen for i3/Sway window events
    ├── Manage window-to-project mapping
    └── Auto-hide/show windows on project switch

    ↓

Ready for User Input
```

## Platform-Specific Flows

### Headless (Hetzner-Sway) Initialization

```
greetd login (user: vpittamp)
    ↓
Shell wrapper exports WLR_* and GSK_RENDERER
    ↓
sway starts with 3 virtual outputs
    ↓
WayVNC creates 3 VNC servers:
├── HEADLESS-1 → port 5900
├── HEADLESS-2 → port 5901
└── HEADLESS-3 → port 5902
    ↓
Workspaces distributed:
├── HEADLESS-1: workspaces 1-2
├── HEADLESS-2: workspaces 3-5
└── HEADLESS-3: workspaces 6-9
    ↓
Status bars:
├── 3 × top bar (system monitor)
└── 3 × bottom bar (project context)
    ↓
Walker launcher uses GTK4 Cairo rendering (GSK_RENDERER=cairo)
    ↓
VNC client connects from another machine
```

### M1 (Physical Display) Initialization

```
greetd login (user: greeter) → tuigreet UI
    ↓
sway starts with physical displays
    ↓
libinput detects:
├── eDP-1 (Retina builtin)
├── HDMI-A-1 (external monitor if connected)
└── Touchpad configuration applied
    ↓
Workspaces distributed:
├── eDP-1: workspaces 1-2
└── HDMI-A-1: workspaces 3+
    ↓
Status bars:
├── eDP-1: top (monitor) + bottom (project + system tray)
└── HDMI-A-1: top (monitor) + bottom (project)
    ↓
Walker launcher uses GPU rendering (default)
    ↓
User interacts with physical keyboard and touchpad
```

## Template File Dependencies

```
home-modules/desktop/sway-config-manager.nix
    ├── Defines:
    │   ├── defaultKeybindingsPath → sway-default-keybindings.toml
    │   ├── defaultAppearancePath → sway-default-appearance.json
    │   ├── defaultWindowRules (inline JSON)
    │   ├── defaultWorkspaceAssignments (inline JSON)
    │   ├── workspaceModeHandlerScript ◄─ HARDCODED for Hetzner
    │   └── modesConfContents ◄─ HARDCODED for Hetzner
    │
    └── Installs templates to ~/.local/share/sway-config-manager/templates/
        ├── keybindings.toml
        ├── window-rules.json
        ├── workspace-assignments.json
        └── appearance.json

    ↓

sway-config-manager daemon (on first run)
    ├── Checks ~/.config/sway/ (writable, user-editable)
    ├── If missing, copies from templates
    └── Creates placeholder generated files

    ↓

User edits:
    ~/.config/sway/keybindings.toml
    ~/.config/sway/window-rules.json
    ~/.config/sway/workspace-assignments.json
    ~/.config/sway/appearance.json

    ↓

sway-config-manager daemon (on file change or manual reload)
    ├── Load user config files
    ├── Validate against schema
    ├── Generate .conf files:
    │   ├── keybindings-generated.conf
    │   ├── appearance-generated.conf
    │   └── modes.conf
    └── Git commit (version control)

    ↓

Sway includes generated files:
    include ~/.config/sway/keybindings-generated.conf
    include ~/.config/sway/appearance-generated.conf
    include ~/.config/sway/modes.conf
```

## Platform Detection Pattern

```
osConfig (system configuration)
    ├── networking.hostName = "nixos-hetzner-sway" OR "nixos-m1"
    │
    └── Checked in multiple files:
        ├── home-modules/desktop/sway.nix
        │   let isHeadless = (osConfig.networking.hostName or "") == "nixos-hetzner-sway"
        │
        ├── home-modules/desktop/swaybar.nix
        │   let isHeadless = (osConfig.networking.hostName or "") == "nixos-hetzner-sway"
        │
        └── home-modules/desktop/i3bar/status-system-monitor.sh
            # Uses I3PM environment variables for detection
```

## Problem Areas (Needs Fixing)

```
1. workspace-mode-handler.sh
   Location: home-modules/desktop/sway-config-manager.nix:44-147
   Problem: Hardcoded HEADLESS-1/2/3 output names
   Impact: M1 workspace modes would fail (non-existent outputs)
   Severity: HIGH (breaks M1 multi-output workflow)
   
2. modes.conf generation
   Location: home-modules/desktop/sway-config-manager.nix:149-198
   Problem: Hardcoded for 3 outputs, references HEADLESS-1/2/3
   Impact: M1 with 2 outputs would have incorrect bindings
   Severity: HIGH (architectural issue)
   
3. Platform detection mechanism
   Pattern: hostname == "nixos-hetzner-sway"
   Problem: Fragile, duplicated, not decoupled from config intent
   Impact: Breaking on hostname change, hard to test
   Severity: MEDIUM (works but fragile)
   
4. Environment variables scattered
   Locations: hetzner-sway.nix, modules/desktop/sway.nix, greetd script
   Problem: No single source of truth, duplicated in greetd script
   Impact: Harder to maintain, inconsistencies possible
   Severity: LOW (works but scattered)
```
