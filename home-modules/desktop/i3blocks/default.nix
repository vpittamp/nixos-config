# i3blocks Status Command Configuration
# Feature 013: Migrated from polybar to i3bar with i3blocks
# Feature 014: Converted to declarative script generation (T017-T021)
{ config, lib, pkgs, ... }:

let
  # T017: Project indicator script (signal-based)
  projectScript = pkgs.writeShellScript "i3blocks-project" ''
    #!${pkgs.bash}/bin/bash
    # Project context indicator for i3blocks
    # Declaratively generated by home-manager

    PROJECT_FILE="$HOME/.config/i3/active-project"

    if [ -f "$PROJECT_FILE" ]; then
      NAME=$(${pkgs.jq}/bin/jq -r '.display_name // .name // empty' "$PROJECT_FILE" 2>/dev/null)
      ICON=$(${pkgs.jq}/bin/jq -r '.icon // ""' "$PROJECT_FILE" 2>/dev/null)

      if [ -n "$NAME" ] && [ "$NAME" != "null" ]; then
        if [ ! -z "$ICON" ] && [ "$ICON" != "null" ] && [ "$ICON" != '""' ]; then
          TEXT="$ICON  $NAME"
        else
          TEXT=" $NAME"
        fi
        COLOR="#b4befe"  # Lavender (Catppuccin Mocha - active project)
      else
        TEXT="∅ No Project"
        COLOR="#6c7086"  # Overlay0 (Catppuccin Mocha - dimmed)
      fi
    else
      TEXT="∅ No Project"
      COLOR="#6c7086"  # Overlay0 (Catppuccin Mocha - dimmed)
    fi

    ${pkgs.coreutils}/bin/echo "<span foreground='$COLOR'>$TEXT</span>"
  '';

  # T018: CPU usage script
  cpuScript = pkgs.writeShellScript "i3blocks-cpu" ''
    #!${pkgs.bash}/bin/bash
    # CPU usage script for i3blocks
    # Declaratively generated by home-manager

    CPU=$(${pkgs.procps}/bin/top -bn1 | ${pkgs.gnugrep}/bin/grep "Cpu(s)" | ${pkgs.gawk}/bin/awk '{print $2}' | ${pkgs.coreutils}/bin/cut -d'%' -f1 | ${pkgs.coreutils}/bin/cut -d'.' -f1)

    if [ -z "$CPU" ]; then
      CPU=0
    fi

    if [ "$CPU" -gt 95 ]; then
      COLOR="#f38ba8"  # Red (urgent)
    elif [ "$CPU" -gt 80 ]; then
      COLOR="#f9e2af"  # Yellow (warning)
    else
      COLOR="#a6e3a1"  # Green (normal)
    fi

    ${pkgs.coreutils}/bin/echo "<span foreground='$COLOR'> CPU: ''${CPU}%</span>"
  '';

  # T019: Memory usage script
  memoryScript = pkgs.writeShellScript "i3blocks-memory" ''
    #!${pkgs.bash}/bin/bash
    # Memory usage script for i3blocks
    # Declaratively generated by home-manager

    MEM_TOTAL=$(${pkgs.gnugrep}/bin/grep MemTotal /proc/meminfo | ${pkgs.gawk}/bin/awk '{print $2}')
    MEM_AVAIL=$(${pkgs.gnugrep}/bin/grep MemAvailable /proc/meminfo | ${pkgs.gawk}/bin/awk '{print $2}')

    MEM_USED=$((MEM_TOTAL - MEM_AVAIL))

    if [ "$MEM_TOTAL" -eq 0 ]; then
      MEM_PERCENT=0
    else
      MEM_PERCENT=$((MEM_USED * 100 / MEM_TOTAL))
    fi

    if [ "$MEM_PERCENT" -gt 95 ]; then
      COLOR="#f38ba8"  # Red (urgent)
    elif [ "$MEM_PERCENT" -gt 80 ]; then
      COLOR="#f9e2af"  # Yellow (warning)
    else
      COLOR="#89dceb"  # Sky blue (normal)
    fi

    ${pkgs.coreutils}/bin/echo "<span foreground='$COLOR'> MEM: ''${MEM_PERCENT}%</span>"
  '';

  # T020: Network status script
  networkScript = pkgs.writeShellScript "i3blocks-network" ''
    #!${pkgs.bash}/bin/bash
    # Network status script for i3blocks
    # Declaratively generated by home-manager

    INTERFACE=$(${pkgs.iproute2}/bin/ip route | ${pkgs.gnugrep}/bin/grep default | ${pkgs.gawk}/bin/awk '{print $5}' | ${pkgs.coreutils}/bin/head -n1)

    if [ -z "$INTERFACE" ]; then
      STATUS=" disconnected"
      COLOR="#f38ba8"  # Red
    else
      if ${pkgs.iproute2}/bin/ip link show "$INTERFACE" | ${pkgs.gnugrep}/bin/grep -q "state UP"; then
        STATUS=" $INTERFACE"
        COLOR="#a6e3a1"  # Green
      else
        STATUS=" $INTERFACE: down"
        COLOR="#f38ba8"  # Red
      fi
    fi

    ${pkgs.coreutils}/bin/echo "<span foreground='$COLOR'>$STATUS</span>"
  '';

  # T021: Date/time script
  datetimeScript = pkgs.writeShellScript "i3blocks-datetime" ''
    #!${pkgs.bash}/bin/bash
    # Date/time script for i3blocks
    # Declaratively generated by home-manager

    DATETIME=$(${pkgs.coreutils}/bin/date '+%Y-%m-%d %H:%M')

    ${pkgs.coreutils}/bin/echo "<span foreground='#cdd6f4'> $DATETIME</span>"
  '';
in
{
  # Install i3blocks package
  home.packages = [ pkgs.i3blocks ];

  # Generate i3blocks configuration file with proper nix store script paths
  xdg.configFile."i3blocks/config".text = ''
    # i3blocks configuration for i3bar
    # Generated by home-manager

    # Global properties
    separator_block_width=15
    markup=pango

    # Left side: System information blocks
    [cpu]
    command=${cpuScript}
    interval=5

    [memory]
    command=${memoryScript}
    interval=5

    # Center: Project indicator (prominent, signal-based)
    [project]
    command=${projectScript}
    interval=once
    signal=10

    # Right side: Network and DateTime
    [network]
    command=${networkScript}
    interval=10

    [datetime]
    command=${datetimeScript}
    interval=60
  '';
}
