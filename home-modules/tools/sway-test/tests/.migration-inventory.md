# Migration Inventory: Timeout-Based → Sync-Based Tests

**Purpose**: Track all tests requiring migration from arbitrary timeout waits to synchronization-based patterns
**Date Created**: 2025-11-08
**Feature**: 069-sync-test-framework
**Phase**: Phase 8 - Migration & Legacy Code Removal (T090)

## Summary

**Total Tests Using wait_event**: 11 files
**Event-Driven (Keep)**: 3 files (already using sync patterns or proper event-driven waits)
**Timeout-Based (Migrate)**: 8 files (arbitrary timeout waits - must migrate)

## Migration Categories

### Category A: Tests Already Migrated (Keep - Reference Only)

These tests already use sync patterns and are examples of the target state:

1. `test_focus_sync.json` - Uses `send_ipc_sync`
2. `test_launch_app_sync.json` - Uses `launch_app_sync`
3. `test_window_move_sync.json` - Uses `send_ipc_sync`

**Status**: ✅ Complete - these demonstrate the target pattern

### Category B: Tests Requiring Migration (8 files)

These tests use `wait_event` with arbitrary timeout values and must be migrated:

#### 1. `tests/sway-tests/basic/test_app_workspace_launch.json`
- **Current Pattern**: `wait_event` with `timeout_ms: 8000`
- **Event Type**: `window::new`
- **Migration Target**: Replace with `launch_app_sync`
- **Complexity**: Low - simple app launch pattern
- **App**: Generic (no app_id specified)

#### 2. `tests/sway-tests/basic/test_walker_app_launch.json`
- **Current Pattern**: `wait_event` with `timeout: 8000`
- **Event Type**: `window` (change: new, app_id: firefox)
- **Migration Target**: Replace with `launch_app_sync` for Firefox
- **Complexity**: Low - firefox launch pattern
- **App**: Firefox

#### 3. `tests/sway-tests/integration/test_env_validation.json`
- **Current Pattern**: `wait_event` with `timeout: 8000`
- **Event Type**: `window` (change: new, app_id: Alacritty)
- **Migration Target**: Replace with `launch_app_sync` for Alacritty
- **Complexity**: Low - alacritty launch pattern
- **App**: Alacritty

#### 4. `tests/sway-tests/integration/test_firefox_simple.json`
- **Current Pattern**: `wait_event` with `timeout: 10000`
- **Event Type**: `window` (change: new, app_id: firefox)
- **Migration Target**: Replace with `launch_app_sync` for Firefox
- **Complexity**: Low - firefox launch pattern (duplicate of test_walker_app_launch)
- **App**: Firefox

#### 5. `tests/sway-tests/integration/test_firefox_workspace.json`
- **Current Pattern**: `wait_event` with `timeout: 10000`
- **Event Type**: `window` (change: new, app_id: firefox)
- **Migration Target**: Already migrated to `test_firefox_workspace_sync.json`
- **Complexity**: Low - DELETE this file (duplicate)
- **App**: Firefox
- **Action**: DELETE - superseded by sync version

#### 6. `tests/sway-tests/integration/test_multi_app_workspaces.json`
- **Current Pattern**: Multiple `wait_event` calls with varying timeouts
  - Firefox: `timeout: 10000`
  - VS Code: `timeout: 15000`
  - Thunar: `timeout: 8000`
- **Event Type**: `window` (change: new) for each app
- **Migration Target**: Replace all with `launch_app_sync` for each app
- **Complexity**: Medium - multiple apps, different timeouts
- **Apps**: Firefox, VS Code, Thunar

#### 7. `tests/sway-tests/integration/test_pwa_workspace.json`
- **Current Pattern**: `wait_event` with `timeout: 15000`
- **Event Type**: `window` (change: new, no app_id specified)
- **Migration Target**: Replace with `launch_app_sync` (may need to identify PWA app_id)
- **Complexity**: Medium - PWA launch, long timeout suggests slow app
- **App**: PWA (unspecified)

#### 8. `tests/sway-tests/integration/test_vscode_scoped.json`
- **Current Pattern**: `wait_event` with `timeout: 15000`
- **Event Type**: `window` (change: new, window_class: Code)
- **Migration Target**: Replace with `launch_app_sync` for VS Code
- **Complexity**: Low - VS Code launch pattern
- **App**: VS Code

## Migration Patterns

### Pattern 1: Simple App Launch (6 tests)

**Before** (timeout-based):
```json
{
  "type": "launch_app",
  "params": { "app_name": "firefox" }
},
{
  "type": "wait_event",
  "params": {
    "event_type": "window",
    "timeout": 10000,
    "criteria": {
      "change": "new",
      "app_id": "firefox"
    }
  }
}
```

**After** (sync-based):
```json
{
  "type": "launch_app_sync",
  "params": { "app_name": "firefox" }
}
```

**Benefits**:
- 90% faster (from 10s timeout to ~100ms sync)
- 100% reliable (no race conditions)
- Simpler test code (1 action vs 2)

**Applies to**:
- test_walker_app_launch.json
- test_env_validation.json
- test_firefox_simple.json
- test_vscode_scoped.json
- test_pwa_workspace.json

### Pattern 2: Multi-App Launch (1 test)

**Before** (timeout-based):
```json
{
  "type": "launch_app",
  "params": { "app_name": "firefox" }
},
{ "type": "wait_event", "params": { "timeout": 10000 } },
{
  "type": "launch_app",
  "params": { "app_name": "code" }
},
{ "type": "wait_event", "params": { "timeout": 15000 } },
...
```

**After** (sync-based):
```json
{
  "type": "launch_app_sync",
  "params": { "app_name": "firefox" }
},
{
  "type": "launch_app_sync",
  "params": { "app_name": "code" }
},
...
```

**Benefits**:
- 95% faster (from 33s cumulative timeouts to ~300ms)
- Sequential launches with guaranteed state synchronization

**Applies to**:
- test_multi_app_workspaces.json

### Pattern 3: Duplicate Tests (DELETE)

**Action**: DELETE file entirely - superseded by sync version

**Applies to**:
- test_firefox_workspace.json (superseded by test_firefox_workspace_sync.json)

## Migration Strategy

### Phase 1: Safe Deletion (T095 partial)
1. DELETE `test_firefox_workspace.json` - already superseded by `test_firefox_workspace_sync.json`
2. Verify sync version passes all tests

### Phase 2: Simple Migrations (T092-T093)
Migrate simple app launch tests (Pattern 1):
1. test_walker_app_launch.json → test_walker_app_launch_sync.json
2. test_env_validation.json → test_env_validation_sync.json
3. test_firefox_simple.json → test_firefox_simple_sync.json
4. test_vscode_scoped.json → test_vscode_scoped_sync.json
5. test_pwa_workspace.json → test_pwa_workspace_sync.json
6. test_app_workspace_launch.json → test_app_workspace_launch_sync.json

### Phase 3: Complex Migration (T094)
Migrate multi-app test (Pattern 2):
1. test_multi_app_workspaces.json → test_multi_app_workspaces_sync.json

### Phase 4: Validation & Cleanup (T095, T098-T100)
1. Run all migrated tests - verify 100% pass rate
2. DELETE all original timeout-based files
3. Verify zero timeout-based tests remain
4. Measure performance improvement

## Success Criteria

- [ ] All 8 timeout-based tests migrated to sync patterns
- [ ] All original timeout-based files DELETED
- [ ] 100% test pass rate with sync versions
- [ ] Test suite runtime reduced by ≥50% (target: ~25 seconds vs ~50 seconds)
- [ ] Individual test speedup of 5-10x verified
- [ ] Zero timeout-based `wait_event` calls remain in test files

## Performance Targets

| Metric | Before (Timeout) | After (Sync) | Target |
|--------|------------------|--------------|--------|
| test_firefox_simple | 10s timeout | ~100ms | 100x faster |
| test_multi_app_workspaces | 33s cumulative | ~300ms | 110x faster |
| Total test suite | ~50s | ~25s | 2x faster |
| Flakiness rate | ~10% (race conditions) | <1% | <1% |

## Notes

- Keep event-driven `wait_event` for app-specific state (e.g., INITIALIZED events)
- Migration script (T091) will automate Pattern 1 conversions
- Complex tests (Pattern 2) may need manual review
- After migration, update action-executor.ts to deprecate timeout-based wait_event (T096-T097)

## Risks

- **Low Risk**: Simple app launch migrations (Pattern 1) - well-established pattern
- **Low Risk**: Multi-app migration (Pattern 2) - straightforward sequential sync
- **No Risk**: Deletion of superseded tests - already have sync versions

## Timeline Estimate

- Phase 1 (Deletion): 5 minutes
- Phase 2 (Simple migrations): 30 minutes (6 tests)
- Phase 3 (Complex migration): 15 minutes (1 test)
- Phase 4 (Validation): 20 minutes
- **Total**: ~70 minutes for complete migration

---

**Status**: ✅ T090 Complete - Inventory created, 8 timeout-based tests identified for migration
**Next**: T091 - Create migration script
