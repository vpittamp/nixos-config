{
  "name": "Monitoring Panel Project Switch Test",
  "description": "Verify project switch updates panel content (hidden windows, project labels)",
  "setup": {
    "steps": [
      {
        "action": "exec",
        "command": "systemctl --user restart i3-project-event-listener",
        "description": "Restart daemon for clean state"
      },
      {
        "action": "wait_sync"
      },
      {
        "action": "exec",
        "command": "systemctl --user restart eww-monitoring-panel",
        "description": "Restart Eww service"
      },
      {
        "action": "wait_sync"
      },
      {
        "action": "exec",
        "command": "eww --config $HOME/.config/eww-monitoring-panel open monitoring-panel",
        "description": "Open monitoring panel"
      },
      {
        "action": "wait_sync"
      },
      {
        "action": "exec",
        "command": "i3pm project create test-project-a",
        "description": "Create test project A"
      },
      {
        "action": "exec",
        "command": "i3pm project create test-project-b",
        "description": "Create test project B"
      },
      {
        "action": "wait_sync"
      }
    ]
  },
  "tests": [
    {
      "name": "Scoped windows show project labels",
      "steps": [
        {
          "action": "exec",
          "command": "i3pm project switch test-project-a",
          "description": "Switch to project A"
        },
        {
          "action": "wait_sync"
        },
        {
          "action": "exec",
          "command": "ghostty &",
          "description": "Launch scoped terminal in project A"
        },
        {
          "action": "wait_sync"
        },
        {
          "action": "wait",
          "duration_ms": 200,
          "description": "Wait for window to be marked as scoped"
        },
        {
          "action": "verify",
          "condition": {
            "type": "command_output",
            "command": "eww --config $HOME/.config/eww-monitoring-panel get monitoring_data | jq -r '.monitors[].workspaces[].windows[] | select(.app_name==\"com.mitchellh.ghostty\") | .project'",
            "equals": "test-project-a",
            "description": "Terminal should show project A label"
          }
        },
        {
          "action": "verify",
          "condition": {
            "type": "command_output",
            "command": "eww --config $HOME/.config/eww-monitoring-panel get monitoring_data | jq -r '.monitors[].workspaces[].windows[] | select(.app_name==\"com.mitchellh.ghostty\") | .scope'",
            "equals": "scoped",
            "description": "Terminal should be marked as scoped"
          }
        }
      ]
    },
    {
      "name": "Switching projects hides scoped windows",
      "steps": [
        {
          "action": "exec",
          "command": "i3pm project switch test-project-b",
          "description": "Switch to project B"
        },
        {
          "action": "wait_sync"
        },
        {
          "action": "wait",
          "duration_ms": 200,
          "description": "Wait for window hiding"
        },
        {
          "action": "verify",
          "condition": {
            "type": "command_output",
            "command": "eww --config $HOME/.config/eww-monitoring-panel get monitoring_data | jq -r '.monitors[].workspaces[] | select(.name==\"scratchpad\") | .windows[] | select(.project==\"test-project-a\") | .hidden'",
            "equals": "true",
            "description": "Project A windows should be hidden in scratchpad"
          }
        },
        {
          "action": "verify",
          "condition": {
            "type": "command_output",
            "command": "eww --config $HOME/.config/eww-monitoring-panel get monitoring_data | jq -r '.monitors[].workspaces[] | select(.name==\"scratchpad\") | .windows[] | select(.project==\"test-project-a\") | .state_classes'",
            "contains": "window-hidden",
            "description": "Hidden windows should have window-hidden class"
          }
        }
      ]
    },
    {
      "name": "Switching back to project shows windows again",
      "steps": [
        {
          "action": "exec",
          "command": "i3pm project switch test-project-a",
          "description": "Switch back to project A"
        },
        {
          "action": "wait_sync"
        },
        {
          "action": "wait",
          "duration_ms": 200,
          "description": "Wait for window restoration"
        },
        {
          "action": "verify",
          "condition": {
            "type": "command_output",
            "command": "eww --config $HOME/.config/eww-monitoring-panel get monitoring_data | jq -r '.monitors[].workspaces[].windows[] | select(.project==\"test-project-a\" and .app_name==\"com.mitchellh.ghostty\") | .hidden'",
            "equals": "false",
            "description": "Project A terminal should be visible again"
          }
        }
      ]
    },
    {
      "name": "Global mode shows all windows",
      "steps": [
        {
          "action": "exec",
          "command": "i3pm project clear",
          "description": "Clear project (global mode)"
        },
        {
          "action": "wait_sync"
        },
        {
          "action": "wait",
          "duration_ms": 200,
          "description": "Wait for window restoration"
        },
        {
          "action": "verify",
          "condition": {
            "type": "command_output",
            "command": "eww --config $HOME/.config/eww-monitoring-panel get monitoring_data | jq -r '.monitors[].workspaces[] | select(.name==\"scratchpad\") | .window_count'",
            "equals": "0",
            "description": "No windows should be hidden in global mode"
          }
        }
      ]
    }
  ],
  "cleanup": {
    "steps": [
      {
        "action": "exec",
        "command": "swaymsg '[app_id=\"com.mitchellh.ghostty\"] kill'",
        "description": "Clean up test windows"
      },
      {
        "action": "exec",
        "command": "i3pm project clear",
        "description": "Clear project mode"
      },
      {
        "action": "exec",
        "command": "eww --config $HOME/.config/eww-monitoring-panel close monitoring-panel",
        "description": "Close panel"
      }
    ]
  }
}
