{
  "name": "Monitoring Panel State Updates Test",
  "description": "Verify window create/close events trigger panel updates within 100ms via event-driven mechanism",
  "setup": {
    "steps": [
      {
        "action": "exec",
        "command": "systemctl --user restart eww-monitoring-panel",
        "description": "Restart Eww service"
      },
      {
        "action": "wait_sync"
      },
      {
        "action": "exec",
        "command": "eww --config $HOME/.config/eww-monitoring-panel open monitoring-panel",
        "description": "Open monitoring panel"
      },
      {
        "action": "wait_sync"
      }
    ]
  },
  "tests": [
    {
      "name": "Panel updates when window is created",
      "steps": [
        {
          "action": "exec",
          "command": "eww --config $HOME/.config/eww-monitoring-panel get monitoring_data | jq -r '.window_count'",
          "save_output": "initial_window_count",
          "description": "Get initial window count"
        },
        {
          "action": "exec",
          "command": "ghostty &",
          "description": "Create new window"
        },
        {
          "action": "wait_sync",
          "description": "Wait for window to appear"
        },
        {
          "action": "wait",
          "duration_ms": 100,
          "description": "Wait 100ms for event-driven update"
        },
        {
          "action": "verify",
          "condition": {
            "type": "command_output",
            "command": "eww --config $HOME/.config/eww-monitoring-panel get monitoring_data | jq -r '.window_count'",
            "greater_than": "$initial_window_count",
            "description": "Window count should have increased"
          }
        }
      ]
    },
    {
      "name": "Panel updates when window is closed",
      "steps": [
        {
          "action": "exec",
          "command": "eww --config $HOME/.config/eww-monitoring-panel get monitoring_data | jq -r '.window_count'",
          "save_output": "before_close_count",
          "description": "Get window count before close"
        },
        {
          "action": "exec",
          "command": "swaymsg '[app_id=\"com.mitchellh.ghostty\"] kill'",
          "description": "Close the Ghostty window"
        },
        {
          "action": "wait_sync",
          "description": "Wait for window to close"
        },
        {
          "action": "wait",
          "duration_ms": 100,
          "description": "Wait 100ms for event-driven update"
        },
        {
          "action": "verify",
          "condition": {
            "type": "command_output",
            "command": "eww --config $HOME/.config/eww-monitoring-panel get monitoring_data | jq -r '.window_count'",
            "less_than": "$before_close_count",
            "description": "Window count should have decreased"
          }
        }
      ]
    },
    {
      "name": "Panel shows focused workspace changes",
      "steps": [
        {
          "action": "exec",
          "command": "swaymsg workspace 2",
          "description": "Switch to workspace 2"
        },
        {
          "action": "wait_sync"
        },
        {
          "action": "wait",
          "duration_ms": 100,
          "description": "Wait for update"
        },
        {
          "action": "verify",
          "condition": {
            "type": "command_output",
            "command": "eww --config $HOME/.config/eww-monitoring-panel get monitoring_data | jq -r '.monitors[0].workspaces[] | select(.focused==true) | .number'",
            "equals": "2",
            "description": "Workspace 2 should be marked as focused"
          }
        },
        {
          "action": "exec",
          "command": "swaymsg workspace 1",
          "description": "Return to workspace 1"
        },
        {
          "action": "wait_sync"
        }
      ]
    }
  ],
  "cleanup": {
    "steps": [
      {
        "action": "exec",
        "command": "eww --config $HOME/.config/eww-monitoring-panel close monitoring-panel",
        "description": "Close panel"
      }
    ]
  }
}
