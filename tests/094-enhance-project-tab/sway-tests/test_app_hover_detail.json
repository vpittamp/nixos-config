{
  "name": "Applications Tab Hover Detail Interaction Test",
  "description": "Verify Applications tab data loading and hover variable interaction (Feature 094 - T027)",
  "setup": {
    "steps": [
      {
        "action": "exec",
        "command": "systemctl --user restart eww-monitoring-panel",
        "description": "Restart Eww service with updated Applications tab"
      },
      {
        "action": "wait_sync"
      },
      {
        "action": "exec",
        "command": "eww --config $HOME/.config/eww-monitoring-panel close-all",
        "description": "Ensure panel is closed"
      },
      {
        "action": "wait_sync"
      }
    ]
  },
  "tests": [
    {
      "name": "Panel opens and Applications tab is accessible",
      "steps": [
        {
          "action": "exec",
          "command": "eww --config $HOME/.config/eww-monitoring-panel open monitoring-panel",
          "description": "Open monitoring panel"
        },
        {
          "action": "wait_sync",
          "description": "Wait for panel to open"
        },
        {
          "action": "verify",
          "condition": {
            "type": "command_output",
            "command": "eww --config $HOME/.config/eww-monitoring-panel active-windows",
            "contains": "monitoring-panel",
            "description": "Panel should be open"
          }
        }
      ]
    },
    {
      "name": "Applications data loads successfully",
      "steps": [
        {
          "action": "wait",
          "duration_ms": 500,
          "description": "Wait for Applications tab data to load via deflisten"
        },
        {
          "action": "verify",
          "condition": {
            "type": "command_output",
            "command": "eww --config $HOME/.config/eww-monitoring-panel get apps_data | jq -r '.status'",
            "equals": "ok",
            "description": "Applications data status should be 'ok'"
          }
        }
      ]
    },
    {
      "name": "Applications data contains apps array",
      "steps": [
        {
          "action": "verify",
          "condition": {
            "type": "command_output",
            "command": "eww --config $HOME/.config/eww-monitoring-panel get apps_data | jq 'has(\"apps\")'",
            "equals": "true",
            "description": "Applications data should have apps field"
          }
        },
        {
          "action": "verify",
          "condition": {
            "type": "command_output",
            "command": "eww --config $HOME/.config/eww-monitoring-panel get apps_data | jq 'has(\"app_count\")'",
            "equals": "true",
            "description": "Applications data should have app_count field"
          }
        }
      ]
    },
    {
      "name": "Apps data has non-zero count",
      "steps": [
        {
          "action": "verify",
          "condition": {
            "type": "command_success",
            "command": "eww --config $HOME/.config/eww-monitoring-panel get apps_data | jq -e '.app_count > 0'",
            "description": "Should have at least one app"
          }
        }
      ]
    },
    {
      "name": "Hover variable for apps exists and can be updated",
      "steps": [
        {
          "action": "verify",
          "condition": {
            "type": "command_output",
            "command": "eww --config $HOME/.config/eww-monitoring-panel get hover_app_name 2>&1",
            "not_contains": "error",
            "description": "hover_app_name variable should exist"
          }
        },
        {
          "action": "exec",
          "command": "eww --config $HOME/.config/eww-monitoring-panel update hover_app_name='firefox'",
          "description": "Simulate hover by updating variable"
        },
        {
          "action": "wait",
          "duration_ms": 100,
          "description": "Wait for update"
        },
        {
          "action": "verify",
          "condition": {
            "type": "command_output",
            "command": "eww --config $HOME/.config/eww-monitoring-panel get hover_app_name",
            "equals": "firefox",
            "description": "hover_app_name should be updated"
          }
        }
      ]
    },
    {
      "name": "Hover variable can be cleared",
      "steps": [
        {
          "action": "exec",
          "command": "eww --config $HOME/.config/eww-monitoring-panel update hover_app_name=''",
          "description": "Simulate hover lost by clearing variable"
        },
        {
          "action": "wait",
          "duration_ms": 100,
          "description": "Wait for update"
        },
        {
          "action": "verify",
          "condition": {
            "type": "command_output",
            "command": "eww --config $HOME/.config/eww-monitoring-panel get hover_app_name",
            "equals": "",
            "description": "hover_app_name should be empty"
          }
        }
      ]
    },
    {
      "name": "Applications tab can be switched to via Alt+3",
      "steps": [
        {
          "action": "key",
          "keys": "Alt+3",
          "description": "Switch to Applications tab (tab 3)"
        },
        {
          "action": "wait",
          "duration_ms": 100,
          "description": "Wait for tab switch"
        },
        {
          "action": "verify",
          "condition": {
            "type": "command_output",
            "command": "eww --config $HOME/.config/eww-monitoring-panel get selected_tab",
            "equals": "2",
            "description": "selected_tab should be 2 (Applications tab, 0-indexed)"
          }
        }
      ]
    },
    {
      "name": "App data includes required fields",
      "steps": [
        {
          "action": "verify",
          "condition": {
            "type": "command_success",
            "command": "eww --config $HOME/.config/eww-monitoring-panel get apps_data | jq -e '.apps[0] | has(\"name\") and has(\"display_name\") and has(\"command\") and has(\"expected_class\") and has(\"preferred_workspace\") and has(\"scope\") and has(\"terminal\")'",
            "description": "First app should have all required fields"
          }
        }
      ]
    },
    {
      "name": "Terminal apps can be identified",
      "steps": [
        {
          "action": "exec",
          "command": "eww --config $HOME/.config/eww-monitoring-panel get apps_data | jq '[.apps[] | select(.terminal == true)] | length'",
          "save_output": "terminal_count",
          "description": "Count terminal apps"
        },
        {
          "action": "verify",
          "condition": {
            "type": "command_success",
            "command": "test $terminal_count -gt 0",
            "description": "Should have at least one terminal app"
          }
        }
      ]
    },
    {
      "name": "Regular apps can be identified",
      "steps": [
        {
          "action": "exec",
          "command": "eww --config $HOME/.config/eww-monitoring-panel get apps_data | jq '[.apps[] | select(.terminal == false and .preferred_workspace <= 50)] | length'",
          "save_output": "regular_count",
          "description": "Count regular apps"
        },
        {
          "action": "verify",
          "condition": {
            "type": "command_success",
            "command": "test $regular_count -gt 0",
            "description": "Should have at least one regular app"
          }
        }
      ]
    },
    {
      "name": "PWA apps use workspace 50+",
      "steps": [
        {
          "action": "exec",
          "command": "eww --config $HOME/.config/eww-monitoring-panel get apps_data | jq '[.apps[] | select(.preferred_workspace >= 50)] | length'",
          "save_output": "pwa_count",
          "description": "Count PWAs (workspace 50+)"
        },
        {
          "action": "verify",
          "condition": {
            "type": "skip_if_zero",
            "value": "$pwa_count",
            "description": "Skip if no PWAs exist"
          }
        },
        {
          "action": "verify",
          "condition": {
            "type": "command_success",
            "command": "eww --config $HOME/.config/eww-monitoring-panel get apps_data | jq -e '[.apps[] | select(.preferred_workspace >= 50)] | all(.preferred_workspace >= 50)'",
            "description": "All PWAs should use workspace 50+"
          }
        }
      ]
    }
  ],
  "cleanup": {
    "steps": [
      {
        "action": "exec",
        "command": "eww --config $HOME/.config/eww-monitoring-panel update hover_app_name=''",
        "description": "Clear hover state"
      },
      {
        "action": "exec",
        "command": "eww --config $HOME/.config/eww-monitoring-panel close monitoring-panel",
        "description": "Close panel"
      }
    ]
  }
}
