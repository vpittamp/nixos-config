#!/usr/bin/env bash
# NixOS build wrapper with comprehensive error tracking and structured output
# Wraps nh/nixos-rebuild to provide detailed build status and error reporting
#
# Usage:
#   nixos-build-wrapper [os|home] [switch|build|test] [OPTIONS]
#
# This wrapper:
# - Uses nh (if available) with nom for better visualization
# - Captures build output and errors
# - Generates structured build logs (JSON)
# - Provides human-readable summaries
# - Tracks generation changes
# - Records build metadata
#
# Exit codes match the underlying build tool (nix/nh)

set -euo pipefail

# Configuration
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly LOG_DIR="${LOG_DIR:-/var/log/nixos-builds}"
readonly BUILD_LOG_JSON="${LOG_DIR}/last-build.json"
readonly BUILD_LOG_TEXT="${LOG_DIR}/last-build.log"
readonly BUILD_HISTORY_JSON="${LOG_DIR}/build-history.json"

# Color codes
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly CYAN='\033[0;36m'
readonly NC='\033[0m'
readonly BOLD='\033[1m'

# Defaults
TARGET="os"  # os or home
ACTION="switch"  # switch, build, test, boot
USE_NH=1
OUTPUT_FORMAT="auto"  # auto, human, json
FLAKE_PATH="/etc/nixos"
EXTRA_ARGS=()

usage() {
  cat <<'EOF'
Usage: nixos-build-wrapper [TARGET] [ACTION] [OPTIONS] [-- EXTRA_ARGS]

Wrapper for NixOS/Home Manager builds with comprehensive status tracking.

TARGETS:
  os              Build NixOS system (default)
  home            Build Home Manager configuration

ACTIONS:
  switch          Build and activate (default)
  build           Build only, don't activate
  test            Build and test (no bootloader)
  boot            Build and set as boot default
  dry-build       Show what would be built

OPTIONS:
  --no-nh         Use nixos-rebuild instead of nh
  --json          Output in JSON format
  --human         Output in human-readable format (default)
  --flake PATH    Path to flake (default: /etc/nixos)
  --log-dir DIR   Directory for build logs (default: /var/log/nixos-builds)
  --help          Show this help

EXAMPLES:
  # Standard system rebuild with nh
  nixos-build-wrapper os switch

  # Home Manager activation
  nixos-build-wrapper home switch

  # Build without activation
  nixos-build-wrapper os build

  # Use specific flake
  nixos-build-wrapper os switch --flake ~/nixos-config

  # Pass extra arguments to underlying tool
  nixos-build-wrapper os switch -- --verbose --show-trace

ENVIRONMENT VARIABLES:
  NH_OS_FLAKE         Flake path for nh os commands
  NH_HOME_FLAKE       Flake path for nh home commands
  LOG_DIR             Directory for build logs
  NO_COLOR            Disable colored output
EOF
}

# Parse arguments
while (( $# )); do
  case "$1" in
    os|home)
      TARGET="$1"
      ;;
    switch|build|test|boot|dry-build)
      ACTION="$1"
      ;;
    --no-nh)
      USE_NH=0
      ;;
    --json)
      OUTPUT_FORMAT="json"
      ;;
    --human)
      OUTPUT_FORMAT="human"
      ;;
    --flake)
      shift
      FLAKE_PATH="$1"
      ;;
    --log-dir)
      shift
      LOG_DIR="$1"
      ;;
    --help|-h)
      usage
      exit 0
      ;;
    --)
      shift
      EXTRA_ARGS=("$@")
      break
      ;;
    *)
      EXTRA_ARGS+=("$1")
      ;;
  esac
  shift
done

# Create log directory
mkdir -p "$LOG_DIR"

# Determine which tool to use
TOOL="nixos-rebuild"
if [[ $USE_NH -eq 1 ]] && command -v nh &>/dev/null; then
  TOOL="nh"
fi

# Get pre-build generation info
PRE_GEN_JSON="{}"
if command -v nixos-generation-info &>/dev/null; then
  PRE_GEN_JSON=$(nixos-generation-info --json 2>/dev/null || echo '{}')
fi

# Record build start
BUILD_START=$(date -Iseconds)
BUILD_START_TS=$(date +%s)

# Build command based on tool
BUILD_CMD=()
if [[ "$TOOL" == "nh" ]]; then
  # Use nh with nom integration
  BUILD_CMD=("nh" "$TARGET" "$ACTION")

  # Set flake environment variables
  if [[ "$TARGET" == "os" ]]; then
    export NH_OS_FLAKE="$FLAKE_PATH"
  else
    export NH_HOME_FLAKE="$FLAKE_PATH"
  fi

  # nh handles nom automatically, but we can control it
  # NH_NOM=1 enables nom visualization
  export NH_NOM=1

else
  # Use traditional nixos-rebuild
  BUILD_CMD=("sudo" "nixos-rebuild" "$ACTION" "--flake" "$FLAKE_PATH")

  # Use nom if available
  if command -v nom &>/dev/null; then
    BUILD_CMD+=("--log-format" "internal-json" "-v")
  fi
fi

# Add extra arguments
BUILD_CMD+=("${EXTRA_ARGS[@]}")

# Execute build and capture output
BUILD_EXIT_CODE=0
BUILD_OUTPUT=""
BUILD_ERRORS=""

log_msg() {
  [[ "$OUTPUT_FORMAT" != "json" ]] && printf '%b\n' "$@"
}

log_msg "${CYAN}${BOLD}Starting build...${NC}"
log_msg "${BLUE}Command: ${BUILD_CMD[*]}${NC}"
log_msg ""

# Run build and capture output
if BUILD_OUTPUT=$("${BUILD_CMD[@]}" 2>&1); then
  BUILD_EXIT_CODE=0
  log_msg "${GREEN}${BOLD}✓ Build succeeded${NC}"
else
  BUILD_EXIT_CODE=$?
  BUILD_ERRORS=$(echo "$BUILD_OUTPUT" | grep -i "error\|failed\|fatal" || echo "$BUILD_OUTPUT")
  log_msg "${RED}${BOLD}✗ Build failed with exit code $BUILD_EXIT_CODE${NC}"
fi

# Record build end
BUILD_END=$(date -Iseconds)
BUILD_END_TS=$(date +%s)
BUILD_DURATION=$((BUILD_END_TS - BUILD_START_TS))

# Get post-build generation info
POST_GEN_JSON="{}"
if command -v nixos-generation-info &>/dev/null; then
  POST_GEN_JSON=$(nixos-generation-info --json 2>/dev/null || echo '{}')
fi

# Save build output to text log
echo "$BUILD_OUTPUT" > "$BUILD_LOG_TEXT"

# Generate structured JSON log
cat > "$BUILD_LOG_JSON" <<EOF
{
  "buildStart": "$BUILD_START",
  "buildEnd": "$BUILD_END",
  "buildDuration": $BUILD_DURATION,
  "target": "$TARGET",
  "action": "$ACTION",
  "tool": "$TOOL",
  "flakePath": "$FLAKE_PATH",
  "exitCode": $BUILD_EXIT_CODE,
  "success": $([ $BUILD_EXIT_CODE -eq 0 ] && echo "true" || echo "false"),
  "hostname": "$(hostname)",
  "user": "$(whoami)",
  "command": $(printf '%s' "${BUILD_CMD[*]}" | jq -R -s '.'),
  "preGeneration": $PRE_GEN_JSON,
  "postGeneration": $POST_GEN_JSON,
  "buildLogPath": "$BUILD_LOG_TEXT",
  "errors": $(printf '%s' "$BUILD_ERRORS" | jq -R -s '.')
}
EOF

# Append to build history
if [[ -f "$BUILD_HISTORY_JSON" ]]; then
  # Append to existing history (keep last 100 builds)
  jq ". += [$(cat "$BUILD_LOG_JSON")]" "$BUILD_HISTORY_JSON" | \
    jq '.[-100:]' > "${BUILD_HISTORY_JSON}.tmp" && \
    mv "${BUILD_HISTORY_JSON}.tmp" "$BUILD_HISTORY_JSON"
else
  # Create new history file
  echo "[$(cat "$BUILD_LOG_JSON")]" > "$BUILD_HISTORY_JSON"
fi

# Output results
if [[ "$OUTPUT_FORMAT" == "json" ]]; then
  cat "$BUILD_LOG_JSON"
else
  log_msg ""
  log_msg "${CYAN}${BOLD}=== Build Summary ===${NC}"
  log_msg "Duration:    ${BUILD_DURATION}s"
  log_msg "Exit Code:   $BUILD_EXIT_CODE"
  log_msg "Log saved:   $BUILD_LOG_TEXT"
  log_msg "JSON saved:  $BUILD_LOG_JSON"

  if [[ $BUILD_EXIT_CODE -eq 0 ]]; then
    # Show generation change
    local pre_gen post_gen
    pre_gen=$(echo "$PRE_GEN_JSON" | jq -r '.generationRaw // "unknown"')
    post_gen=$(echo "$POST_GEN_JSON" | jq -r '.generationRaw // "unknown"')

    if [[ "$pre_gen" != "$post_gen" ]]; then
      log_msg ""
      log_msg "${GREEN}Generation changed: g$pre_gen → g$post_gen${NC}"
    fi

    # Show what changed
    if command -v nixos-generation-info &>/dev/null; then
      log_msg ""
      nixos-generation-info --short
    fi
  else
    log_msg ""
    log_msg "${RED}${BOLD}Build failed. Error details:${NC}"
    log_msg "${RED}$BUILD_ERRORS${NC}"
    log_msg ""
    log_msg "${YELLOW}Tip: Check full build log at $BUILD_LOG_TEXT${NC}"
  fi

  log_msg ""
  log_msg "${CYAN}View full status: nixos-build-status${NC}"
  log_msg "${CYAN}View build history: jq . $BUILD_HISTORY_JSON${NC}"
fi

exit $BUILD_EXIT_CODE
