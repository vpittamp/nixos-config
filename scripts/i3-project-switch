#!/usr/bin/env bash
# i3-project-switch - Switch active project via daemon IPC
# Part of i3 Project Event Daemon (T010)

set -euo pipefail

# Configuration
SOCKET_PATH="${XDG_RUNTIME_DIR:-/run/user/$(id -u)}/i3-project-daemon/ipc.sock"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Usage message
usage() {
    cat <<EOF
Usage: i3-project-switch <project_name>
       i3-project-switch --clear

Switch the active i3 project context.

Options:
    <project_name>  Name of project to switch to
    --clear, -c     Clear active project (global mode)
    --help, -h      Show this help message

Examples:
    i3-project-switch nixos
    i3-project-switch --clear

Exit codes:
    0  Success
    1  Error (invalid arguments, project not found)
    2  Daemon not running
EOF
    exit 0
}

# Check if daemon is running
check_daemon() {
    if [[ ! -S "$SOCKET_PATH" ]]; then
        echo -e "${RED}Error: Daemon socket not found at $SOCKET_PATH${NC}" >&2
        echo "Is the daemon running? Check: systemctl --user status i3-project-event-listener" >&2
        exit 2
    fi
}

# Send JSON-RPC request to daemon
send_request() {
    local method="$1"
    local params="$2"

    local request
    request=$(cat <<EOF
{"jsonrpc":"2.0","method":"$method","params":$params,"id":1}
EOF
)

    # Send request via socket
    response=$(echo "$request" | nc -U -N "$SOCKET_PATH" 2>/dev/null || true)

    if [[ -z "$response" ]]; then
        echo -e "${RED}Error: No response from daemon${NC}" >&2
        exit 2
    fi

    echo "$response"
}

# Switch to project
switch_project() {
    local project_name="$1"

    echo "Switching to project: $project_name"

    # Send switch request
    response=$(send_request "switch_project" "{\"project_name\":\"$project_name\"}")

    # Parse response
    if echo "$response" | grep -q '"error"'; then
        error_msg=$(echo "$response" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)
        echo -e "${RED}Error: $error_msg${NC}" >&2
        exit 1
    fi

    # Send tick event to trigger switch
    i3-msg -t send_tick "project:$project_name" >/dev/null

    echo -e "${GREEN}✓ Switched to project: $project_name${NC}"
}

# Clear active project
clear_project() {
    echo "Clearing active project (entering global mode)"

    # Send tick event
    i3-msg -t send_tick "project:none" >/dev/null

    echo -e "${GREEN}✓ Entered global mode${NC}"
}

# Main
main() {
    # Parse arguments
    if [[ $# -eq 0 ]]; then
        echo -e "${RED}Error: Missing project name${NC}" >&2
        usage
    fi

    case "$1" in
        -h|--help)
            usage
            ;;
        -c|--clear)
            check_daemon
            clear_project
            ;;
        *)
            check_daemon
            switch_project "$1"
            ;;
    esac
}

main "$@"
