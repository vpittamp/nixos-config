#!/usr/bin/env bash
# Start a development shell with container environment and 1Password secrets
# This uses op run to automatically load secrets from 1Password

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
NIXOS_DIR="$(dirname "$SCRIPT_DIR")"
ENV_FILE="$NIXOS_DIR/.env.container"

# Check if op CLI is available
if ! command -v op &> /dev/null; then
    echo "Error: 1Password CLI (op) is not installed or not in PATH"
    exit 1
fi

# Check if env file exists
if [ ! -f "$ENV_FILE" ]; then
    echo "Error: Environment file not found: $ENV_FILE"
    exit 1
fi

echo "üîê Loading secrets from 1Password..."
echo "üìÅ Using env file: $ENV_FILE"
echo ""

# Run shell with secrets loaded from 1Password
op run --env-file "$ENV_FILE" -- bash -c '
    echo "‚úÖ Secrets loaded successfully!"
    echo ""
    echo "Environment variables:"
    echo "  OP_SERVICE_ACCOUNT_TOKEN: ${OP_SERVICE_ACCOUNT_TOKEN:0:10}..."
    echo ""
    echo "You can now use Git and other tools that need 1Password authentication."
    echo "Type '\''exit'\'' to leave this shell."
    echo ""
    exec bash
'
