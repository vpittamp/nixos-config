#!/usr/bin/env bash
# Comprehensive NixOS build status tracking with structured output
# Supports both human-readable and JSON formats for automation
#
# Usage:
#   nixos-build-status [--json] [--verbose] [--help]
#
# This script provides detailed build status including:
# - Build success/failure
# - Generation numbers
# - Git commit information
# - Home Manager activation status
# - Build errors and diagnostics
#
# Exit codes:
#   0 = Everything in sync
#   1 = Out of sync (system or home-manager)
#   2 = Build errors detected
#   3 = Invalid arguments

set -euo pipefail

# Color codes for human-readable output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly CYAN='\033[0;36m'
readonly NC='\033[0m' # No Color
readonly BOLD='\033[1m'

# Configuration
FORMAT="human"
VERBOSE=0
CHECK_BOOT_LOGS=1

usage() {
  cat <<'EOF'
Usage: nixos-build-status [OPTIONS]

Comprehensive build status tracking for NixOS and Home Manager.

OPTIONS:
  --json         Output in JSON format for automation
  --verbose      Include detailed diagnostic information
  --no-boot      Skip boot log checking
  --help         Show this help message

OUTPUT FORMATS:
  human          Color-coded human-readable output (default)
  json           Structured JSON for automation/testing

EXAMPLES:
  # Check current status
  nixos-build-status

  # Get JSON for automation
  nixos-build-status --json | jq .

  # Verbose human-readable output
  nixos-build-status --verbose

EXIT CODES:
  0 = System in sync, no issues
  1 = Out of sync (system or home-manager)
  2 = Build errors detected
  3 = Invalid arguments

INTEGRATION:
  This script can be integrated into CI/CD pipelines, testing frameworks,
  and automated debugging workflows. Use --json for structured output that
  can be parsed by tools like jq, Python, or TypeScript.
EOF
}

# Parse arguments
while (( $# )); do
  case "$1" in
    --json)
      FORMAT="json"
      ;;
    --verbose)
      VERBOSE=1
      ;;
    --no-boot)
      CHECK_BOOT_LOGS=0
      ;;
    --help|-h)
      usage
      exit 0
      ;;
    *)
      echo "Unknown option: $1" >&2
      usage >&2
      exit 3
      ;;
  esac
  shift
done

# JSON escape function
json_escape() {
  local value="$1"
  # shellcheck disable=SC2001
  value=$(sed 's/\\/\\\\/g; s/"/\\"/g; s/\t/\\t/g' <<< "$value")
  value=$(sed ':a;N;$!ba;s/\n/\\n/g' <<< "$value")
  printf '%s' "$value"
}

# Collect generation info using existing script
collect_generation_info() {
  if command -v nixos-generation-info &>/dev/null; then
    if [[ "$FORMAT" == "json" ]]; then
      nixos-generation-info --json 2>/dev/null || echo '{}'
    else
      nixos-generation-info --export 2>/dev/null || true
    fi
  else
    [[ "$FORMAT" == "json" ]] && echo '{}' || true
  fi
}

# Check for recent build errors in journald
check_build_errors() {
  local errors=()
  local error_count=0

  # Check for recent nixos-rebuild failures
  if command -v journalctl &>/dev/null; then
    local rebuild_errors
    rebuild_errors=$(journalctl -u nixos-rebuild --since "24 hours ago" -p err -q 2>/dev/null || true)
    if [[ -n "$rebuild_errors" ]]; then
      ((error_count++))
      errors+=("$(printf "NixOS rebuild errors in last 24h:\n%s" "$rebuild_errors")")
    fi
  fi

  # Check for activation script failures
  if [[ -f "/var/log/nixos-activation.log" ]]; then
    local activation_errors
    activation_errors=$(grep -i "error\|failed\|fatal" /var/log/nixos-activation.log 2>/dev/null | tail -20 || true)
    if [[ -n "$activation_errors" ]]; then
      ((error_count++))
      errors+=("$(printf "Activation script errors:\n%s" "$activation_errors")")
    fi
  fi

  # Output results
  if [[ "$FORMAT" == "json" ]]; then
    printf '{"errorCount":%d,"errors":[' "$error_count"
    local first=1
    for error in "${errors[@]}"; do
      [[ $first -eq 0 ]] && printf ','
      printf '"%s"' "$(json_escape "$error")"
      first=0
    done
    printf ']}'
  else
    if [[ $error_count -gt 0 ]]; then
      printf '%b\n' "${RED}✗ Found $error_count error source(s)${NC}" >&2
      if [[ $VERBOSE -eq 1 ]]; then
        for error in "${errors[@]}"; do
          printf '%b\n' "${RED}$error${NC}" >&2
        done
      fi
    else
      printf '%b\n' "${GREEN}✓ No recent build errors detected${NC}" >&2
    fi
  fi

  # Return count only
  return $error_count
}

# Check boot status
check_boot_status() {
  local boot_failed=0
  local boot_errors=""

  if [[ $CHECK_BOOT_LOGS -eq 1 ]] && command -v journalctl &>/dev/null; then
    # Check for failed systemd units
    local failed_units
    failed_units=$(systemctl --failed --no-legend 2>/dev/null | awk '{print $1}' || true)

    if [[ -n "$failed_units" ]]; then
      boot_failed=1
      boot_errors=$(systemctl --failed --no-pager 2>/dev/null || true)
    fi
  fi

  if [[ "$FORMAT" == "json" ]]; then
    printf '{"bootFailed":%s,"failedUnits":"%s"}' \
      "$boot_failed" \
      "$(json_escape "$boot_errors")"
  else
    if [[ $boot_failed -eq 1 ]]; then
      printf '%b\n' "${RED}✗ System has failed units${NC}" >&2
      if [[ $VERBOSE -eq 1 ]]; then
        printf '%b\n' "${RED}$boot_errors${NC}" >&2
      fi
    else
      printf '%b\n' "${GREEN}✓ All systemd units started successfully${NC}" >&2
    fi
  fi

  # Return status
  return $boot_failed
}

# Check if system can be built
check_buildability() {
  local can_build=1
  local build_error=""

  # Try to evaluate the flake
  if command -v nix &>/dev/null && [[ -f "/etc/nixos/flake.nix" ]]; then
    if ! nix flake metadata /etc/nixos --no-write-lock-file &>/dev/null; then
      can_build=0
      build_error="Flake evaluation failed"
    fi
  fi

  if [[ "$FORMAT" == "json" ]]; then
    printf '{"canBuild":%s,"buildError":"%s"}' \
      "$([ $can_build -eq 1 ] && echo "true" || echo "false")" \
      "$(json_escape "$build_error")"
  else
    if [[ $can_build -eq 1 ]]; then
      printf '%b\n' "${GREEN}✓ Flake can be evaluated${NC}" >&2
    else
      printf '%b\n' "${RED}✗ Flake evaluation failed: $build_error${NC}" >&2
    fi
  fi

  # Return status (0 = can build, 1 = cannot build)
  [ $can_build -eq 1 ] && return 0 || return 1
}

# Main execution
main() {
  local exit_code=0

  if [[ "$FORMAT" == "json" ]]; then
    # JSON output
    printf '{\n'
    printf '  "timestamp": "%s",\n' "$(date -Iseconds)"
    printf '  "hostname": "%s",\n' "$(hostname)"

    # Generation info
    printf '  "generation": '
    collect_generation_info
    printf ',\n'

    # Build errors
    printf '  "buildErrors": '
    check_build_errors
    local error_count=$?
    printf ',\n'

    # Boot status
    printf '  "bootStatus": '
    check_boot_status
    local boot_failed=$?
    printf ',\n'

    # Buildability
    printf '  "buildability": '
    check_buildability
    local can_build=$?
    printf ',\n'

    # Overall status
    local status="success"
    if [[ $error_count -ne 0 || $boot_failed -ne 0 || $can_build -ne 0 ]]; then
      status="error"
      exit_code=2
    fi

    # Check sync status from generation info
    if command -v nixos-generation-info &>/dev/null; then
      local gen_status
      gen_status=$(nixos-generation-info --status 2>/dev/null || echo "unknown")
      if [[ "$gen_status" == "out-of-sync" ]]; then
        exit_code=1
      fi
    fi

    printf '  "overallStatus": "%s",\n' "$status"
    printf '  "exitCode": %d\n' "$exit_code"
    printf '}\n'

  else
    # Human-readable output
    printf '%b\n' "${BOLD}${CYAN}=== NixOS Build Status ===${NC}"
    printf '\n'

    # Generation info
    printf '%b\n' "${BOLD}Generation Information:${NC}"
    if command -v nixos-generation-info &>/dev/null; then
      nixos-generation-info
    else
      printf '%b\n' "${YELLOW}⚠ nixos-generation-info not available${NC}"
    fi
    printf '\n'

    # Build errors
    printf '%b\n' "${BOLD}Build Error Check:${NC}"
    check_build_errors
    local error_count=$?
    printf '\n'

    # Boot status
    printf '%b\n' "${BOLD}Boot Status:${NC}"
    check_boot_status
    local boot_failed=$?
    printf '\n'

    # Buildability
    printf '%b\n' "${BOLD}Flake Status:${NC}"
    check_buildability
    local can_build=$?
    printf '\n'

    # Overall summary
    printf '%b\n' "${BOLD}${CYAN}=== Summary ===${NC}"
    if [[ $error_count -eq 0 && $boot_failed -eq 0 && $can_build -eq 0 ]]; then
      printf '%b\n' "${GREEN}✓ System is healthy${NC}"

      # Check sync status
      if command -v nixos-generation-info &>/dev/null; then
        local gen_status
        gen_status=$(nixos-generation-info --status 2>/dev/null || echo "unknown")
        if [[ "$gen_status" == "out-of-sync" ]]; then
          printf '%b\n' "${YELLOW}⚠ System or Home Manager out of sync${NC}"
          exit_code=1
        fi
      fi
    else
      printf '%b\n' "${RED}✗ System has issues requiring attention${NC}"
      exit_code=2
    fi
    printf '\n'
  fi

  exit $exit_code
}

main
