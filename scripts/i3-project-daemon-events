#!/usr/bin/env bash
# i3-project-daemon-events - Show recent daemon events for debugging
# Part of Feature 015: Event-Based i3 Project Synchronization
#
# This is now a wrapper around the Deno implementation: i3pm daemon events
# The Deno version has more features including real-time event following.

set -euo pipefail

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Check if i3pm is available
if ! command -v i3pm &> /dev/null; then
    echo -e "${RED}Error: i3pm command not found${NC}" >&2
    echo "Please ensure i3pm is installed via home-manager" >&2
    exit 1
fi

# Parse arguments and convert to i3pm daemon events format
ARGS=()
SHOW_MIGRATION_NOTICE=false

while [[ $# -gt 0 ]]; do
    case "$1" in
        --limit=*)
            ARGS+=("--limit=${1#*=}")
            shift
            ;;
        --type=*)
            ARGS+=("--type=${1#*=}")
            shift
            ;;
        --format=json)
            # The Deno version doesn't have --format flag, but outputs are already structured
            # For JSON output, users should pipe to jq
            echo -e "${YELLOW}Note: JSON output format has been replaced by structured text output${NC}" >&2
            echo -e "${BLUE}Tip: Pipe output to 'jq' for JSON processing if needed${NC}" >&2
            SHOW_MIGRATION_NOTICE=true
            shift
            ;;
        -h|--help)
            # Show migration notice and forward to Deno help
            echo -e "${BOLD}i3-project-daemon-events${NC} (Legacy Wrapper)"
            echo ""
            echo -e "${YELLOW}This command is now a wrapper around 'i3pm daemon events'${NC}"
            echo -e "${BLUE}The new Deno implementation has additional features:${NC}"
            echo "  - Real-time event following with --follow / -f"
            echo "  - Event ID filtering with --since-id"
            echo "  - Better formatted output with colors"
            echo ""
            echo -e "${BOLD}For full usage information, run:${NC}"
            echo "  i3pm daemon events --help"
            echo ""
            echo -e "${BOLD}Migration Examples:${NC}"
            echo "  Old: i3-project-daemon-events --limit=50"
            echo "  New: i3pm daemon events --limit=50"
            echo ""
            echo "  Old: i3-project-daemon-events --type=window"
            echo "  New: i3pm daemon events --type=window"
            echo ""
            echo "  ${BOLD}New feature:${NC} i3pm daemon events --follow    # Real-time event stream"
            echo ""
            exit 0
            ;;
        *)
            echo -e "${RED}Error: Unknown option: $1${NC}" >&2
            echo "Run 'i3-project-daemon-events --help' for usage" >&2
            exit 1
            ;;
    esac
done

# Show migration notice if needed
if [[ "$SHOW_MIGRATION_NOTICE" == true ]]; then
    echo ""
    echo -e "${BOLD}Consider migrating to:${NC} i3pm daemon events"
    echo ""
fi

# Execute the Deno implementation
exec i3pm daemon events "${ARGS[@]}"
