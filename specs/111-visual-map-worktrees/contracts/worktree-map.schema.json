{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "worktree-map.schema.json",
  "title": "WorktreeMap",
  "description": "Visual worktree relationship map data structure for Feature 111",
  "type": "object",
  "required": ["repository", "nodes", "edges", "main_branch", "width", "height", "computed_at"],
  "properties": {
    "repository": {
      "type": "string",
      "description": "Repository qualified name (account/repo)",
      "pattern": "^[a-zA-Z0-9_-]+/[a-zA-Z0-9_-]+$"
    },
    "nodes": {
      "type": "array",
      "description": "Worktree nodes in the map",
      "items": { "$ref": "#/$defs/WorktreeNode" }
    },
    "edges": {
      "type": "array",
      "description": "Relationship edges between nodes",
      "items": { "$ref": "#/$defs/RelationshipEdge" }
    },
    "main_branch": {
      "type": "string",
      "description": "Name of the main/master branch",
      "default": "main"
    },
    "svg_path": {
      "type": ["string", "null"],
      "description": "Path to generated SVG file"
    },
    "width": {
      "type": "integer",
      "minimum": 100,
      "maximum": 2000,
      "description": "SVG canvas width in pixels"
    },
    "height": {
      "type": "integer",
      "minimum": 100,
      "maximum": 4000,
      "description": "SVG canvas height in pixels"
    },
    "max_depth": {
      "type": "integer",
      "minimum": 1,
      "maximum": 10,
      "default": 5,
      "description": "Maximum layer depth for hierarchy"
    },
    "computed_at": {
      "type": "integer",
      "description": "Unix timestamp when map was computed"
    }
  },
  "$defs": {
    "WorktreeNode": {
      "type": "object",
      "required": ["branch", "qualified_name", "x", "y", "layer", "node_type", "status"],
      "properties": {
        "branch": {
          "type": "string",
          "description": "Full branch name"
        },
        "branch_number": {
          "type": ["string", "null"],
          "pattern": "^[0-9]{2,4}$",
          "description": "Extracted feature number (e.g., '111')"
        },
        "branch_description": {
          "type": "string",
          "description": "Human-readable description derived from branch name"
        },
        "qualified_name": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9_-]+/[a-zA-Z0-9_-]+:.+$",
          "description": "Full qualified name (account/repo:branch)"
        },
        "x": {
          "type": "number",
          "minimum": 0,
          "description": "X position in SVG canvas"
        },
        "y": {
          "type": "number",
          "minimum": 0,
          "description": "Y position in SVG canvas"
        },
        "layer": {
          "type": "integer",
          "minimum": 0,
          "maximum": 10,
          "description": "Hierarchical layer (0 = main branch)"
        },
        "node_type": {
          "type": "string",
          "enum": ["main", "feature", "hotfix", "release"],
          "description": "Type of branch"
        },
        "status": {
          "type": "string",
          "enum": ["active", "stale", "merged", "conflict"],
          "description": "Current status of the worktree"
        },
        "is_dirty": {
          "type": "boolean",
          "default": false,
          "description": "Has uncommitted changes"
        },
        "is_active": {
          "type": "boolean",
          "default": false,
          "description": "Currently selected worktree"
        },
        "ahead_of_parent": {
          "type": "integer",
          "minimum": 0,
          "default": 0,
          "description": "Commits ahead of parent branch"
        },
        "behind_parent": {
          "type": "integer",
          "minimum": 0,
          "default": 0,
          "description": "Commits behind parent branch"
        },
        "parent_branch": {
          "type": ["string", "null"],
          "description": "Parent branch name"
        },
        "last_commit_relative": {
          "type": "string",
          "description": "Relative time since last commit (e.g., '2 days ago')"
        },
        "last_commit_message": {
          "type": "string",
          "description": "Last commit message (truncated)"
        },
        "tooltip": {
          "type": "string",
          "description": "Tooltip content for hover display"
        }
      }
    },
    "RelationshipEdge": {
      "type": "object",
      "required": ["source_branch", "target_branch", "edge_type"],
      "properties": {
        "source_branch": {
          "type": "string",
          "description": "Source/parent node branch name"
        },
        "target_branch": {
          "type": "string",
          "description": "Target/child node branch name"
        },
        "edge_type": {
          "type": "string",
          "enum": ["parent_child", "merged", "conflict"],
          "description": "Type of relationship"
        },
        "ahead_count": {
          "type": "integer",
          "minimum": 0,
          "default": 0,
          "description": "Commits in target not in source"
        },
        "behind_count": {
          "type": "integer",
          "minimum": 0,
          "default": 0,
          "description": "Commits in source not in target"
        },
        "conflict_files": {
          "type": "array",
          "items": { "type": "string" },
          "default": [],
          "description": "Files with potential conflicts"
        },
        "label": {
          "type": "string",
          "description": "Display label for the edge (e.g., '↑3 ↓2')"
        },
        "css_class": {
          "type": "string",
          "description": "CSS class for styling"
        }
      }
    },
    "WorktreeRelationship": {
      "type": "object",
      "required": ["source_branch", "target_branch", "merge_base_commit", "ahead_count", "behind_count", "computed_at"],
      "properties": {
        "source_branch": {
          "type": "string",
          "description": "Branch being analyzed"
        },
        "target_branch": {
          "type": "string",
          "description": "Branch to compare against"
        },
        "merge_base_commit": {
          "type": "string",
          "pattern": "^[a-f0-9]{7,40}$",
          "description": "Common ancestor commit hash"
        },
        "ahead_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Commits in source not in target"
        },
        "behind_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Commits in target not in source"
        },
        "is_diverged": {
          "type": "boolean",
          "description": "True if both ahead AND behind"
        },
        "computed_at": {
          "type": "integer",
          "description": "Unix timestamp of computation"
        }
      }
    }
  }
}
