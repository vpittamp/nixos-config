# PWA Lifecycle Consolidation - Known Limitations

**Feature**: 055-pwa-lifecycle-consolidation
**Date**: 2025-11-02

## Limitation 1: Hardcoded PWA IDs in App Registry

### Issue

PWA profile IDs are system-generated by firefoxpwa and differ across machines:
- hetzner-sway: `FFPWA-01K666N2V6BQMDSBMX3AY74TY7` (YouTube)
- m1: `FFPWA-<different-id>` (YouTube)

The daemon's window identifier service (`window_identifier.py`) uses exact class matching and doesn't support:
- Wildcard patterns (`FFPWA-*`)
- PWA name lookup via firefoxpwa query

This means `expected_class` in `app-registry-data.nix` must contain hardcoded IDs for Priority 2 (registry fallback) workspace assignment to work.

### Impact

**Severity**: Medium

- ✅ **Launch from Walker works**: Priority 0 (launch notification) bypasses registry matching
- ❌ **Direct CLI launch fails**: Assigns to wrong workspace (falls through to Priority 2)
- ❌ **Cross-machine portability broken**: m1 will have different IDs, requires manual updates

### Current Workaround

Temporarily using hardcoded IDs with TODO comments:

```nix
expected_class = "FFPWA-01K666N2V6BQMDSBMX3AY74TY7";  # TODO: PWA IDs are machine-specific (Feature 055 limitation)
```

### Proper Fix

Enhance daemon's window identifier to support PWA name lookup:

**Option A: Query firefoxpwa for PWA name**
```python
# In window_identifier.py
def get_pwa_name(pwa_id: str) -> Optional[str]:
    """Query firefoxpwa profile list to get PWA name from ID."""
    try:
        result = subprocess.run(
            ["firefoxpwa", "profile", "list"],
            capture_output=True,
            text=True,
            timeout=2
        )
        for line in result.stdout.splitlines():
            if pwa_id in line:
                # Parse: "- YouTube: https://youtube.com (01K666N2V6BQMDSBMX3AY74TY7)"
                match = re.match(r'^- ([^:]+):', line)
                if match:
                    return match.group(1)
    except Exception as e:
        logger.warning(f"Failed to query PWA name for {pwa_id}: {e}")
    return None
```

**Option B: Use PWA name from window title**
- Window title changes to "YouTube" quickly after launch
- Match based on title instead of class for PWAs
- Less reliable (title can change dynamically)

**Recommendation**: Implement Option A with caching to avoid repeated subprocess calls.

### Implementation Task

**Task**: Add PWA name lookup to window identifier service

**Files to modify**:
- `/etc/nixos/home-modules/desktop/i3-project-event-daemon/services/window_identifier.py`
- `/etc/nixos/home-modules/desktop/app-registry-data.nix` (remove hardcoded IDs after fix)

**Steps**:
1. Add `get_pwa_name()` function to window_identifier.py
2. Cache PWA ID → name mappings in memory (TTL: 5 minutes)
3. Update `match_window_class()` to query PWA name for `FFPWA-*` classes
4. Match PWA name against app registry `display_name` field
5. Add tests for PWA matching
6. Update app-registry-data.nix to use `display_name` instead of hardcoded IDs
7. Test cross-machine deployment (hetzner-sway → m1)

**Estimated effort**: 2-3 hours

**Priority**: Medium (workaround exists via Priority 0 matching)

## Limitation 2: Direct CLI Launch Bypasses Launch Notification

### Issue

Launching PWAs directly via `firefoxpwa site launch <id>` bypasses `app-launcher-wrapper.sh`, so no launch notification is sent. Window assignment falls through to Priority 2 (registry match), which requires hardcoded IDs (see Limitation 1).

### Impact

**Severity**: Low

- ✅ Normal workflow (Walker launch) works correctly
- ❌ Manual CLI testing shows incorrect workspace assignment

### Workaround

Always launch PWAs via Walker or app-launcher-wrapper.sh:
```bash
# ❌ Direct CLI (wrong workspace)
firefoxpwa site launch 01K666N2V6BQMDSBMX3AY74TY7

# ✅ Via wrapper (correct workspace)
app-launcher-wrapper.sh youtube-pwa
```

### Proper Fix

Not needed - direct CLI launch is not a supported workflow for workspace assignment.

## Success Criteria Update

Original Feature 055 success criteria status after discovering limitations:

| Criterion | Status | Notes |
|-----------|--------|-------|
| SC-001: 100% portability | ⚠️ Partial | Launch-pwa-by-name is portable, but registry IDs are hardcoded |
| SC-002: Zero hardcoded IDs | ❌ Blocked | Reverted to hardcoded IDs due to daemon limitation |
| SC-003: Zero legacy files | ✅ Complete | No WebApp/ice scripts exist |
| SC-004: Identical lifecycle | ✅ Complete | PWAs use same Priority 0-3 system |
| SC-005: Zero config updates | ⚠️ Partial | launch-pwa-by-name dynamic, but registry needs manual updates |
| SC-006: Same decision tree | ✅ Complete | No special PWA assignment code |

## Recommended Next Steps

1. ✅ **Complete Phase 1 testing**: Test Walker launch (Priority 0 should work)
2. ⏳ **Document workaround**: Update CLAUDE.md with current limitations
3. ⏳ **Implement proper fix**: Add PWA name lookup to daemon (2-3 hours)
4. ⏳ **Test cross-machine**: Deploy to m1 after fix, verify dynamic matching
5. ⏳ **Update success criteria**: Mark SC-002 and SC-005 as complete after fix

## User Communication

**What works now**:
- ✅ Manual PWA installation via Firefox GUI (reliable)
- ✅ Automatic 1Password integration (declarative)
- ✅ Dynamic PWA launch via `launch-pwa-by-name` (queries firefoxpwa)
- ✅ Validation commands (`pwa-validate`, `pwa-list`)
- ✅ Walker launch with correct workspace assignment (Priority 0)

**What doesn't work yet**:
- ❌ Cross-machine portability of app-registry-data.nix (hardcoded IDs)
- ❌ Direct CLI PWA launch with correct workspace (use Walker instead)

**Temporary manual step for m1 deployment**:
1. Install PWAs manually via Firefox GUI on m1
2. Run `firefoxpwa profile list` to get m1-specific IDs
3. Update `expected_class` in app-registry-data.nix with m1 IDs
4. Rebuild configuration

**After proper fix is implemented**:
- No manual ID updates needed
- app-registry-data.nix will be truly portable
- Both Priority 0 (launch notification) and Priority 2 (registry fallback) will work
