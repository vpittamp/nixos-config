# Implementation Plan: Hetzner Cloud Sway Configuration with Headless Wayland

**Branch**: `046-revise-my-spec` | **Date**: 2025-10-28 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/046-revise-my-spec/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command after completing Phase 0 (research) and Phase 1 (data models, contracts, quickstart).

## Summary

**Primary Requirement**: Enable Sway tiling window manager on Hetzner Cloud VM running headless Wayland (no physical displays) with VNC remote access, full i3pm daemon integration, and Walker application launcher support. This configuration is parallel to the existing `hetzner` (i3/X11) configuration and does not modify it.

**Technical Approach**:
- Use **WLR_BACKENDS=headless** to run Sway without physical displays
- Create virtual outputs (HEADLESS-1) with in-memory EGL framebuffers (1920x1080@60Hz)
- Use **wayvnc** as VNC server for remote access (port 5900, PAM authentication)
- Use **pixman** for CPU-based software rendering (no GPU acceleration required)
- Use **greetd + tuigreet** as display manager for headless login
- Enable **user lingering** for persistent session after SSH logout
- Reuse existing i3pm daemon from Feature 045 (100% Sway IPC compatible, no code changes needed)
- Reuse Walker/Elephant configuration from Feature 043 (Wayland-native)

## Technical Context

**Language/Version**: Nix 2.18+, NixOS 24.05+, Sway 1.9+, Python 3.11 (for existing i3pm daemon)

**Primary Dependencies**:
- **sway**: Window manager with headless backend support (wlroots 0.17+)
- **wayvnc**: VNC server for wlroots-based compositors
- **greetd + tuigreet**: Display manager for headless login
- **pixman**: Software rendering library (CPU-based EGL)
- **i3ipc-python 2.2+**: Sway IPC client library (existing daemon uses this)
- **walker + elephant**: Application launcher (Feature 043, already Wayland-native)
- **home-manager**: Declarative user environment management

**Storage**:
- **JSON files**: Project configurations (~/.config/i3/projects/*.json), active project state, window-workspace mappings
- **TOML files**: wayvnc configuration (~/.config/wayvnc/config)
- **NixOS store**: Immutable system and user packages
- **In-memory**: Sway window tree state, virtual output framebuffers (EGL)

**Testing**:
- **Manual validation**: Test scenarios in quickstart.md (6 user stories, 5 edge cases)
- **Automated checks**: Shell script test suite (test-feature-046.sh)
- **i3pm daemon tests**: Existing pytest suite (Feature 015) validates IPC compatibility
- **Integration testing**: Deploy to Hetzner VM, verify via SSH and VNC

**Target Platform**: Hetzner Cloud VM (x86_64-linux), KVM virtualization, no GPU passthrough, remote access via VNC

**Project Type**: System configuration (NixOS declarative modules)

**Performance Goals**:
- Daemon IPC connection: <2 seconds from Sway session start
- Window event processing: <100ms latency (mark application)
- Project switch: <500ms (window hide/show operations)
- VNC window creation: <500ms (from launch to visible)
- VNC workspace switch: <200ms (display update)
- VNC keyboard input: <100ms latency (including network)

**Constraints**:
- **Software rendering only**: No GPU acceleration (CPU-based pixman renderer)
- **VNC bandwidth**: 10-20 Mbps typical for 60 FPS remote desktop
- **Memory limits**: Sway <50MB, wayvnc <50MB, i3pm daemon <15MB, virtual framebuffer ~8MB per output
- **Network latency**: Assume <100ms RTT for European datacenter (impacts VNC responsiveness)
- **Zero code changes**: i3pm daemon and Walker must work unmodified (IPC compatibility requirement)

**Scale/Scope**:
- 1 NixOS configuration (hetzner-sway) parallel to existing hetzner config
- 1-2 virtual outputs (HEADLESS-1, optionally HEADLESS-2 for multi-monitor testing)
- 70 workspaces (same as existing configurations)
- Same application registry as hetzner/M1 (~16 applications)
- Same project configurations as hetzner/M1 (nixos, stacks, personal)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

**Status**: âœ… PASS (No constitution file found - no violations possible)

**Analysis**:
- This feature adds a new parallel configuration (hetzner-sway) without modifying existing configurations
- Zero code changes to existing Python daemon (Feature 045 already made it Sway-compatible)
- Zero code changes to Walker/Elephant (Feature 043 already made it Wayland-native)
- Reuses existing module architecture (sway.nix, wayvnc.nix already exist from Feature 045)
- No new abstractions or complexity layers introduced
- Configuration isolation maintained (separate flake output)

## Project Structure

### Documentation (this feature)

```
specs/046-revise-my-spec/
â”œâ”€â”€ spec.md                           # Feature specification (6 user stories, 31 FR)
â”œâ”€â”€ plan.md                           # This file (implementation plan)
â”œâ”€â”€ research.md                       # Phase 0 output (8 technical decisions)
â”œâ”€â”€ data-model.md                     # Phase 1 output (6 core entities, relationships)
â”œâ”€â”€ quickstart.md                     # Phase 1 output (test scenarios, validation)
â”œâ”€â”€ checklists/
â”‚   â””â”€â”€ requirements.md               # Specification quality validation (all PASS)
â””â”€â”€ contracts/
    â”œâ”€â”€ sway-ipc.md                   # Sway IPC protocol contract (i3 compatibility)
    â”œâ”€â”€ wayvnc-configuration.md       # wayvnc config contract (VNC server settings)
    â””â”€â”€ systemd-dependencies.md       # Service startup sequence and dependencies
```

### Source Code (repository root)

**Structure**: NixOS declarative configuration (no src/ directory - purely configuration-based feature)

```
/etc/nixos/
â”œâ”€â”€ flake.nix                          # ADD: hetzner-sway flake output
â”‚
â”œâ”€â”€ configurations/
â”‚   â”œâ”€â”€ hetzner.nix                    # UNCHANGED: Existing i3/X11 config
â”‚   â”œâ”€â”€ hetzner-sway.nix               # NEW: Headless Sway configuration
â”‚   â””â”€â”€ base.nix                       # UNCHANGED: Shared base config
â”‚
â”œâ”€â”€ hardware/
â”‚   â””â”€â”€ hetzner.nix                    # UNCHANGED: Virtual hardware config
â”‚
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ desktop/
â”‚   â”‚   â”œâ”€â”€ sway.nix                   # EXISTS (Feature 045): System-level Sway module
â”‚   â”‚   â”œâ”€â”€ wayvnc.nix                 # EXISTS (Feature 045): wayvnc module (UPDATE: default config for headless)
â”‚   â”‚   â””â”€â”€ i3wm.nix                   # UNCHANGED: i3 module for hetzner config
â”‚   â””â”€â”€ services/
â”‚       â””â”€â”€ development.nix            # UNCHANGED: Dev tools (shared)
â”‚
â”œâ”€â”€ home-modules/
â”‚   â”œâ”€â”€ desktop/
â”‚   â”‚   â”œâ”€â”€ sway.nix                   # EXISTS (Feature 045): Home-manager Sway config (UPDATE: headless-specific output config)
â”‚   â”‚   â”œâ”€â”€ walker.nix                 # EXISTS (Feature 043): Walker launcher (UNCHANGED: already Wayland-native)
â”‚   â”‚   â””â”€â”€ i3-project-event-daemon/   # EXISTS (Feature 045): Python daemon (UNCHANGED: Sway-compatible)
â”‚   â”‚       â”œâ”€â”€ daemon.py
â”‚   â”‚       â”œâ”€â”€ handlers.py            # Contains get_window_class() for Sway
â”‚   â”‚       â””â”€â”€ connection.py          # Contains Sway IPC connection logic
â”‚   â””â”€â”€ hetzner-sway.nix               # NEW: Home-manager entry point for hetzner-sway user
â”‚
â””â”€â”€ specs/046-revise-my-spec/          # Feature documentation
    â””â”€â”€ [documentation files as shown above]
```

**Key Files to Modify/Create**:

1. **flake.nix** (ADD): New `nixosConfigurations.hetzner-sway` output
2. **configurations/hetzner-sway.nix** (NEW): Imports base.nix, sway.nix, wayvnc.nix, sets headless env vars
3. **home-modules/hetzner-sway.nix** (NEW): User-level configuration (imports sway.nix, walker.nix, i3pm daemon)
4. **modules/desktop/sway.nix** (UPDATE): Add headless backend environment variables (conditional based on config)
5. **modules/desktop/wayvnc.nix** (UPDATE): Set default wayvnc config suitable for headless (port 5900, enable_auth=true)
6. **home-modules/desktop/sway.nix** (UPDATE): Add headless-specific virtual output configuration

**No Code Changes Required** (reuse existing work):
- âŒ Python daemon code (Feature 045 already made it Sway-compatible)
- âŒ Walker/Elephant config (Feature 043 already made it Wayland-native)
- âŒ Application registry (reuse existing from hetzner/M1)
- âŒ Project configurations (reuse existing from hetzner/M1)
- âŒ i3bar configuration (already uses Sway-compatible i3 bar protocol)

**Structure Decision**: This is a **configuration-only feature** (NixOS modules and home-manager). No new source code directories needed. All implementation happens via declarative Nix expressions that compose existing modules (sway.nix from Feature 045, wayvnc.nix from Feature 045, walker.nix from Feature 043) with headless-specific settings (WLR_BACKENDS=headless, virtual outputs, greetd display manager).

## Complexity Tracking

*Fill ONLY if Constitution Check has violations that must be justified*

**Status**: âœ… No violations - complexity tracking not required

**Rationale**: This feature adds a parallel configuration (3rd configuration: wsl, hetzner, hetzner-sway, m1 = 4 total) which could be seen as increased complexity, but:

1. **Isolation**: hetzner-sway is independent, doesn't modify existing configs
2. **Reuse**: 95% of implementation already exists from Features 043 (Walker) and 045 (Sway/wayvnc modules)
3. **Zero Code**: No new Python code, no new daemon logic, no new IPC protocol
4. **Testing Path**: Separate flake output allows independent testing without affecting production (hetzner config)
5. **Migration Strategy**: Provides gradual migration path from hetzner (i3) â†’ hetzner-sway without disruption

**Alternative Considered**: Modify hetzner.nix to support both i3 and Sway via option flag

**Rejected Because**:
- Single configuration with conditional logic increases complexity (if-then-else throughout modules)
- Higher risk of breaking existing stable i3 configuration
- Harder to rollback (generations would mix i3/Sway state)
- Separate configs provide clearer separation of concerns and easier troubleshooting

---

## Implementation Tasks

**Note**: This section provides a high-level task breakdown. Detailed tasks will be generated by `/speckit.tasks` command after planning is complete.

### Phase 0: Setup and Validation âœ… COMPLETE

- [x] Research headless Wayland/Sway viability on cloud VMs
- [x] Research VNC server options for wlroots compositors
- [x] Validate Feature 045 (Sway module) provides necessary foundation
- [x] Validate Feature 043 (Walker) works on Wayland
- [x] Document research findings (research.md)

### Phase 1: Planning and Design âœ… COMPLETE

- [x] Generate data model (data-model.md)
- [x] Generate contracts (Sway IPC, wayvnc config, systemd dependencies)
- [x] Generate test scenarios (quickstart.md)
- [x] Complete implementation plan (this file)

### Phase 2: Core Configuration (Estimated: 2-3 hours)

- [ ] Create configurations/hetzner-sway.nix (imports base.nix, sway.nix, wayvnc.nix)
- [ ] Add hetzner-sway flake output to flake.nix
- [ ] Configure greetd display manager for headless login
- [ ] Enable user lingering for vpittamp user
- [ ] Set headless environment variables (WLR_BACKENDS, WLR_LIBINPUT_NO_DEVICES, WLR_RENDERER)

### Phase 3: Home-Manager Configuration (Estimated: 1-2 hours)

- [ ] Create home-modules/hetzner-sway.nix (imports sway.nix, walker.nix, i3pm daemon)
- [ ] Configure virtual output in home-modules/desktop/sway.nix (HEADLESS-1, 1920x1080@60Hz)
- [ ] Configure wayvnc in home-modules/desktop/sway.nix (systemd user service)
- [ ] Update i3pm daemon service dependencies (After=sway-session.target)

### Phase 4: Testing and Validation (Estimated: 3-4 hours)

- [ ] Deploy to Hetzner VM via nixos-rebuild switch
- [ ] Execute Test Scenario 1: Headless Sway Session Startup (quickstart.md)
- [ ] Execute Test Scenario 2: i3pm Daemon Integration (quickstart.md)
- [ ] Execute Test Scenario 3: Walker Launcher Integration (quickstart.md)
- [ ] Execute Test Scenario 4: Remote Desktop Performance (quickstart.md)
- [ ] Execute Test Scenario 5: Configuration Isolation (quickstart.md)
- [ ] Execute Edge Case Testing (5 edge cases in quickstart.md)
- [ ] Run automated test suite (test-feature-046.sh)

### Phase 5: Multi-Monitor Support (Optional, Priority P3) (Estimated: 1-2 hours)

- [ ] Configure second virtual output (HEADLESS-2)
- [ ] Test workspace distribution across two virtual outputs
- [ ] Execute Test Scenario 6: Multi-Monitor Support (quickstart.md)

### Phase 6: Documentation and Cleanup (Estimated: 1 hour)

- [ ] Update CLAUDE.md with Feature 046 quickstart reference
- [ ] Document troubleshooting tips based on test findings
- [ ] Create git commit with Feature 046 changes
- [ ] Update agent context (if needed)

**Total Estimated Time**: 8-12 hours (excluding optional multi-monitor support)

---

## Success Criteria Validation Plan

Each success criterion from spec.md will be validated as follows:

| Success Criterion | Validation Method | Test Scenario |
|-------------------|-------------------|---------------|
| SC-001: Basic window management via VNC | Manual VNC testing | Test Scenario 1, Step 1.4 |
| SC-002: Daemon connects <2s | i3pm daemon status command | Test Scenario 2, Step 2.1 |
| SC-003: Project switch <500ms | Manual timing with VNC | Test Scenario 2, Steps 2.4-2.5 |
| SC-004: Walker providers work | Manual Walker testing via VNC | Test Scenario 3, Steps 3.1-3.4 |
| SC-005: VNC performance acceptable | Manual latency measurement | Test Scenario 4, Steps 4.1-4.5 |
| SC-006: Multi-instance app marks | Window mark inspection via swaymsg | Test Scenario 2, Step 2.3 |
| SC-007: Both configs buildable | nixos-rebuild dry-build for both | Test Scenario 5, Step 5.4 |
| SC-008: hetzner config unchanged | Diff hetzner.nix before/after | Test Scenario 5, Step 5.1 |
| SC-009: Daemon tests pass | pytest suite (existing tests) | Phase 4 validation |
| SC-010: Build succeeds | nixos-rebuild dry-build | Phase 4 validation |

---

## Risk Assessment

### Low Risk

âœ… **Sway IPC Compatibility**: Feature 045 implementation proves 100% i3 IPC compatibility (daemon already works with Sway)

âœ… **Walker Wayland Support**: Feature 043 implementation proves Walker works on Wayland (already tested on M1)

âœ… **Configuration Isolation**: Separate flake output ensures zero risk to existing hetzner config

### Medium Risk

âš ï¸ **VNC Performance**: Network latency and software rendering (pixman) may impact responsiveness
- **Mitigation**: Test with realistic workloads, adjust max_rate if needed (30 FPS instead of 60 FPS)
- **Fallback**: If performance unacceptable, investigate alternative remote access (x2go, NoMachine)

âš ï¸ **Virtual Output Detection**: wayvnc auto-detection of HEADLESS-1 may fail if multiple outputs
- **Mitigation**: Explicitly configure output=HEADLESS-1 in wayvnc config
- **Test**: Verify output selection with single and dual virtual outputs

### Low Impact (Known Limitations)

ðŸ”µ **GPU Acceleration**: Software rendering only (no GPU in cloud VM)
- **Impact**: Higher CPU usage for compositor, but acceptable for remote desktop use case
- **Documented**: Already captured in constraints (WLR_RENDERER=pixman)

ðŸ”µ **Audio Forwarding**: VNC protocol doesn't support audio
- **Impact**: No audio playback in VNC session (use SSH + mpv if audio needed)
- **Documented**: Already marked "Out of Scope" in spec.md

---

## Deployment Strategy

### Development Testing

1. **Local Testing**: Build configuration locally with `nixos-rebuild dry-build --flake .#hetzner-sway`
2. **Remote Build**: Build on Hetzner VM with `nixos-rebuild build --flake .#hetzner-sway --target-host vpittamp@hetzner`
3. **Staging Deployment**: Deploy to test VM first (if available) before production Hetzner VM

### Production Deployment

1. **Backup Current Config**: Ensure hetzner config works and is committed to git
2. **Deploy hetzner-sway**: `nixos-rebuild switch --flake .#hetzner-sway --target-host vpittamp@hetzner --use-remote-sudo`
3. **Reboot VM**: `ssh vpittamp@hetzner 'sudo reboot'` (greetd requires reboot to start)
4. **Validate**: Run automated test suite and manual VNC connection test
5. **Rollback Plan**: If issues, revert to hetzner config: `nixos-rebuild switch --flake .#hetzner --target-host vpittamp@hetzner --use-remote-sudo && sudo reboot`

### Gradual Rollout

- **Week 1**: Deploy hetzner-sway, test via VNC during off-hours
- **Week 2**: Use for non-critical work, identify performance issues
- **Week 3**: Migrate primary workflows if performance acceptable
- **Week 4**: Keep hetzner config available for rollback (don't remove)

---

## Dependencies on Other Features

### Hard Dependencies (Must be complete)

âœ… **Feature 043**: Walker/Elephant Wayland-native support (COMPLETE)
- Provides: Application launcher, project switcher, calculator, clipboard provider
- Status: Validated on M1 Sway, no changes needed

âœ… **Feature 045**: M1 Sway migration with i3pm daemon Sway compatibility (IN PROGRESS - Phase 2 complete)
- Provides: sway.nix module, wayvnc.nix module, i3pm daemon Sway IPC support
- Status: Phases 1-2 complete (daemon and modules working), remaining phases not blocking for Feature 046

### Soft Dependencies (Nice to have)

ðŸ”µ **Feature 045 Complete**: Full M1 Sway validation
- Benefit: Provides additional confidence in Sway module stability
- Impact if incomplete: Low - hetzner-sway can proceed independently, M1-specific features (native display, multi-monitor) not relevant to headless

---

## Future Enhancements (Out of Scope for MVP)

1. **Multi-User VNC Sessions**: Support multiple concurrent VNC sessions (separate wayvnc instances on different ports)
2. **RDP Protocol**: Investigate weston-rdp or wlroots RDP backend (experimental, requires X11 fallback currently)
3. **Hardware Acceleration**: Explore GPU passthrough in Hetzner Cloud for GPU-accelerated rendering
4. **Multi-Virtual-Output VNC**: Run multiple wayvnc instances to expose each virtual output separately
5. **Performance Monitoring**: Add Grafana dashboard for Sway/wayvnc performance metrics (CPU, memory, frame rate)
6. **Clipboard Synchronization**: Enhance wl-clipboard integration for seamless clipboard sharing
7. **File Transfer**: Add VNC extension or separate service for file upload/download

---

## References

- **Feature Specification**: [spec.md](./spec.md)
- **Research Findings**: [research.md](./research.md)
- **Data Model**: [data-model.md](./data-model.md)
- **Quickstart Guide**: [quickstart.md](./quickstart.md)
- **Contracts**:
  - [Sway IPC Contract](./contracts/sway-ipc.md)
  - [wayvnc Configuration Contract](./contracts/wayvnc-configuration.md)
  - [systemd Dependencies Contract](./contracts/systemd-dependencies.md)
- **Related Features**:
  - [Feature 043: Walker/Elephant Integration](../043-get-full-functionality/)
  - [Feature 045: M1 Sway Migration](../045-migrate-m1-macbook/)
- **External Documentation**:
  - [Sway IPC Protocol](https://man.archlinux.org/man/sway-ipc.7.en)
  - [wayvnc GitHub](https://github.com/any1/wayvnc)
  - [wlroots Headless Backend](https://gitlab.freedesktop.org/wlroots/wlroots/-/blob/master/backend/headless/backend.c)
  - [greetd Documentation](https://sr.ht/~kennylevinsen/greetd/)

---

**Planning Status**: âœ… COMPLETE

**Next Step**: Run `/speckit.tasks` to generate detailed implementation tasks from this plan
