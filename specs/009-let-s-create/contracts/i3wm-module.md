# Contract: i3wm Desktop Module

**Module Path**: `modules/desktop/i3wm.nix`
**Version**: 1.0.0
**Status**: Active
**Last Updated**: 2025-10-17

## Purpose

This module provides a complete i3 window manager desktop environment for NixOS systems, including X11 server configuration, essential desktop tools, and declarative configuration file generation.

## Module Interface

### Options

#### `services.i3wm.enable`
- **Type**: `boolean`
- **Default**: `false`
- **Description**: Enable i3 window manager desktop environment
- **Effect**: Enables X11 server, i3 window manager, and essential desktop packages

#### `services.i3wm.package`
- **Type**: `package`
- **Default**: `pkgs.i3`
- **Description**: i3 package to use
- **Effect**: Allows using alternative i3 builds or versions

#### `services.i3wm.extraPackages`
- **Type**: `listOf package`
- **Default**: `[ pkgs.dmenu pkgs.i3status pkgs.i3lock ]`
- **Description**: Additional packages to install with i3
- **Effect**: Extends the default package list with user-specified packages

## Dependencies

### Required System Capabilities
- X11 server (automatically enabled via `services.xserver.enable`)
- Video drivers (modesetting/fbdev by default)

### Package Dependencies
- `pkgs.i3` - i3 window manager
- `pkgs.alacritty` - Terminal emulator
- `pkgs.rofi` - Application launcher
- `pkgs.i3status` - Status bar
- `pkgs.clipcat` - Clipboard manager (for keybindings)

### Optional Dependencies
- `modules/desktop/xrdp.nix` - For remote desktop access
- `home-modules/desktop/i3.nix` - For user-specific i3 configuration
- `home-modules/desktop/i3wsr.nix` - For dynamic workspace renaming

## Generated Resources

### Configuration Files

#### `/etc/i3/config`
- **Generated By**: `environment.etc."i3/config".text`
- **Format**: i3 configuration file (v4 syntax)
- **Content**: Complete i3 configuration with keybindings, window rules, bar configuration
- **Keybindings**: See "Keybinding Contract" section below

#### `/etc/i3status.conf`
- **Generated By**: `environment.etc."i3status.conf".text`
- **Format**: i3status configuration file
- **Content**: Status bar configuration (disk, memory, load, time)

#### `/etc/i3/scripts/show-keybindings.sh`
- **Generated By**: `environment.etc."i3/scripts/show-keybindings.sh"`
- **Format**: Bash script
- **Content**: Script to display keybinding help in rofi
- **Permissions**: `0755` (executable)

### System Packages

The following packages are added to `environment.systemPackages`:
- `cfg.package` (i3)
- `pkgs.alacritty`
- `pkgs.rofi`
- All packages in `cfg.extraPackages`

### System Services

#### X11 Server
- **Service**: `services.xserver`
- **Enabled**: `true`
- **Window Manager**: `i3`
- **Display Manager Session**: `"none+i3"` (no display manager)
- **Video Drivers**: `["modesetting" "fbdev"]` (overrideable with mkDefault)

## Keybinding Contract

### Modifier Keys
- `$mod` = `Mod4` (Windows/Super key)
- Workspace switching uses `Control+1-9` for RDP compatibility (Windows RDP captures Win key)

### Core Keybindings (Guaranteed)

| Keybinding | Action | Requirement |
|------------|--------|-------------|
| `Win+Return` | Open terminal (alacritty) | FR-003 |
| `Win+Shift+Return` | Open floating terminal | FR-003 |
| `Win+d` | Application launcher (rofi) | FR-006 |
| `Win+v` | Clipboard history (clipcat) | FR-004 |
| `Win+Shift+v` | Clear clipboard history | FR-004 |
| `Win+i` | Show keybinding help | FR-003 |
| `Win+c` | Quick launch VS Code | FR-003 |
| `Win+b` | Quick launch Firefox | FR-003 |
| `Win+Shift+q` | Close window | FR-003 |
| `Win+f` | Fullscreen toggle | FR-003 |
| `Win+h` | Split horizontal | FR-003 |
| `Win+Shift+\|` | Split vertical | FR-003 |
| `Win+s` | Stacking layout | FR-003 |
| `Win+w` | Tabbed layout | FR-003 |
| `Win+e` | Toggle split layout | FR-003 |
| `Win+Shift+Space` | Toggle floating | FR-003 |
| `Win+Space` | Focus mode toggle (tiling/floating) | FR-003 |
| `Win+Shift+-` | Move to scratchpad | FR-003 |
| `Win+-` | Show scratchpad | FR-003 |
| `Control+1-9` | Switch to workspace 1-9 | FR-003 (RDP-compatible) |
| `Win+Shift+1-9` | Move window to workspace 1-9 | FR-003 |
| `Win+Arrows` | Change focus | FR-003 |
| `Win+Shift+Arrows` | Move window | FR-003 |
| `Win+Shift+c` | Reload i3 config | FR-003 |
| `Win+Shift+r` | Restart i3 | FR-003 |
| `Win+Shift+e` | Exit i3 | FR-003 |

### Keybinding Extension Points

Platform configurations or home-manager modules can add keybindings by:
1. Creating user-specific i3 config at `~/.config/i3/config` (home-manager)
2. Including additional config files via `include` directive in system config
3. Using `lib.mkForce` to override `/etc/i3/config` entirely (discouraged)

## Platform Override Patterns

### Example: M1 Platform Override

```nix
# configurations/m1.nix
{
  imports = [ ./hetzner-i3.nix ];

  # Override DPI for Retina display
  services.xserver.dpi = lib.mkForce 180;
  services.xserver.serverFlagsSection = lib.mkForce ''
    Option "DPI" "180 x 180"
  '';

  # Disable remote desktop (not needed on laptop)
  services.xrdp-i3.enable = lib.mkForce false;
}
```

### Example: Container Headless Override

```nix
# configurations/container.nix
{
  imports = [ ./hetzner-i3.nix ];

  # Disable GUI entirely
  services.i3wm.enable = lib.mkForce false;
  services.xserver.enable = lib.mkForce false;
}
```

## Conditional Features

This module does not have conditional features based on system capabilities. If i3wm is enabled, all features are enabled. Headless systems should disable the module entirely.

## Validation Requirements

### Build-Time Validation
- Configuration file syntax must be valid i3 config v4
- All package references must resolve to available packages
- Keybindings must not conflict with X11 system keybindings

### Runtime Validation
- X11 server must start successfully
- i3 window manager must start within 5 seconds
- All keybindings must be functional
- Status bar must display and update

### Integration Testing
- Remote desktop (xrdp) must work with i3 (multi-session support)
- Clipboard manager must work with i3 keybindings
- Application launcher (rofi) must launch and search applications
- Terminal (alacritty) must launch and render correctly

## Migration Contract

### From KDE Plasma to i3wm

When migrating from KDE Plasma to i3wm, the following must be preserved:

| Feature | KDE Plasma | i3wm Equivalent | Status |
|---------|------------|-----------------|--------|
| Application Launcher | KRunner (Alt+F2) | rofi (Win+d) | ✅ Implemented |
| Clipboard Manager | klipper | clipcat (Win+v) | ✅ Implemented |
| Screen Locking | kscreenlocker | i3lock (Win+l) | ⚠️ Optional (remote desktop use case) |
| Window Management | kwin | i3 tiling | ✅ Implemented |
| Workspace Navigation | Ctrl+F1-F12 | Ctrl+1-9 | ✅ Implemented |
| Multi-Session RDP | Limited/problematic | xrdp with independent sessions | ✅ Implemented |

### Breaking Changes

1. **No GUI Settings Manager**: i3 uses text configuration files; no GUI settings app like KDE System Settings
2. **Manual Window Layout**: Tiling window manager requires manual splits/layouts vs automatic window placement
3. **Keyboard-First**: Most operations require keyboard; mouse is secondary
4. **No Panels/Widgets**: i3bar is minimal; no KDE panels, widgets, or desktop icons

## Compatibility Matrix

| Platform | i3wm Support | Notes |
|----------|--------------|-------|
| Hetzner (x86_64) | ✅ Full | Primary reference configuration |
| M1 (aarch64) | ✅ Full | Requires DPI override for HiDPI |
| Container (x86_64) | ❌ N/A | Headless; disable i3wm module |
| WSL (x86_64) | ⚠️ Limited | WSL2 supports X11 but no GPU acceleration |

## Version History

- **1.0.0** (2025-10-17): Initial contract for KDE Plasma → i3wm migration
  - Defined module interface (options, dependencies, generated resources)
  - Documented keybinding contract for RDP compatibility
  - Specified platform override patterns
  - Defined migration contract from KDE Plasma

## See Also

- `home-modules/desktop/i3.nix` - User-specific i3 configuration
- `home-modules/desktop/i3wsr.nix` - Dynamic workspace renaming
- `modules/desktop/xrdp.nix` - Remote desktop integration
- `docs/I3WM_SETUP.md` - i3wm configuration guide (to be created)
