# Quickstart Guide: i3bar + i3blocks Status Bar

**Feature**: Migrate from Polybar to i3 Native Status Bar
**Audience**: Users who want to customize the status bar
**Date**: 2025-10-19

## Overview

This guide explains how to customize your i3bar status bar powered by i3blocks after migration from polybar. The configuration is declarative (managed by Nix), so all changes are version-controlled and reproducible.

## Architecture

```
┌─────────────────────────────────────────────┐
│         i3 Window Manager                   │
│  ┌───────────────────────────────────────┐ │
│  │           i3bar (native)              │ │
│  │  ┌──────┬──────┬──────┬──────┬──────┐│ │
│  │  │WS 1  │WS 2  │  ...  │Status Blocks││ │
│  │  └──────┴──────┴──────┴──────┴──────┘│ │
│  └───────────────────────────────────────┘ │
│         ↑                    ↑              │
│         │                    │              │
│    IPC Events           Status Output       │
│    (workspaces)         (i3blocks)          │
└─────────────────────────────────────────────┘
                              ↑
                              │
           ┌──────────────────┴──────────────────┐
           │        i3blocks                     │
           │  ┌────────┬────────┬────────────┐  │
           │  │ CPU    │ Memory │ Project    │  │
           │  │ script │ script │ script     │  │
           │  └────────┴────────┴────────────┘  │
           └─────────────────────────────────────┘
```

**Key Points**:
- **Workspaces**: Managed natively by i3, displayed automatically by i3bar
- **Status Info**: Generated by i3blocks scripts, aggregated and sent to i3bar
- **Configuration**: Declarative Nix expressions in home-manager

## File Locations

### Configuration Files (Auto-Generated)

| File | Purpose | Edit Via |
|------|---------|----------|
| `~/.config/i3/config` | i3 configuration with bar block | `home-modules/desktop/i3.nix` |
| `~/.config/i3blocks/config` | i3blocks configuration | `home-modules/desktop/i3blocks/default.nix` |
| `~/.config/i3blocks/scripts/*.sh` | Status block scripts | `home-modules/desktop/i3blocks/scripts/` |

### State Files (User Data)

| File | Purpose | Modified By |
|------|---------|-------------|
| `~/.config/i3/active-project` | Current project context | `i3-project-switch` command |

**Important**: Do NOT edit auto-generated files directly. Edit the Nix source and rebuild.

## Common Customizations

### 1. Change Bar Position

**Location**: `home-modules/desktop/i3.nix`

```nix
xsession.windowManager.i3.config = {
  bars = [{
    position = "top";  # Change from "bottom" to "top"
    # ... rest of config
  }];
};
```

**Apply**:
```bash
sudo nixos-rebuild switch --flake .#hetzner
```

---

### 2. Customize Status Bar Colors

**Location**: `home-modules/desktop/i3.nix`

```nix
colors = {
  background = "#1e1e2e";  # Bar background
  statusline = "#cdd6f4";  # Status text color
  separator  = "#6c7086";  # Separator color
  
  # Focused workspace (current workspace)
  focused_workspace  = {
    border = "#b4befe";      # Border color
    background = "#45475a";  # Background
    text = "#cdd6f4";        # Text color
  };
  
  # Change urgent workspace to different color
  urgent_workspace = {
    border = "#f9e2af";      # Yellow instead of red
    background = "#f9e2af";
    text = "#1e1e2e";
  };
};
```

**Color Palette** (Catppuccin Mocha):
```nix
# Base colors
base     = "#1e1e2e";
surface0 = "#313244";
surface1 = "#45475a";
overlay0 = "#6c7086";

# Text colors
text     = "#cdd6f4";
subtext0 = "#bac2de";

# Accent colors
lavender = "#b4befe";  # Primary
blue     = "#89b4fa";  # Secondary
green    = "#a6e3a1";  # Success
yellow   = "#f9e2af";  # Warning
red      = "#f38ba8";  # Error/urgent
```

---

### 3. Change Status Update Intervals

**Location**: `home-modules/desktop/i3blocks/default.nix`

```nix
xdg.configFile."i3blocks/config".text = ''
  [cpu]
  command=${cpuScript}
  interval=10  # Change from 5 to 10 seconds
  
  [memory]
  command=${memoryScript}
  interval=10  # Change from 5 to 10 seconds
  
  [datetime]
  command=${datetimeScript}
  interval=30  # Change from 60 to 30 seconds (update twice per minute)
'';
```

**Interval Options**:
- `interval=N` - Update every N seconds
- `interval=once` - Run once at startup
- `interval=persist` - Long-running process (advanced)

---

### 4. Add a New Status Block

**Example**: Add disk usage block

**Step 1**: Create script in `home-modules/desktop/i3blocks/scripts/disk.sh`:

```nix
home.file.".config/i3blocks/scripts/disk.sh" = {
  text = ''
    #!/usr/bin/env bash
    # Disk usage for root filesystem
    
    USAGE=$(df -h / | awk 'NR==2 {print $5}' | tr -d '%')
    
    # Color based on usage
    if [ $USAGE -gt 90 ]; then
      COLOR="#f38ba8"  # Red
    elif [ $USAGE -gt 75 ]; then
      COLOR="#f9e2af"  # Yellow
    else
      COLOR="#cdd6f4"  # Normal
    fi
    
    cat <<EOF
    {
      "full_text": "DISK: ${USAGE}%",
      "color": "$COLOR"
    }
    EOF
  '';
  executable = true;
};
```

**Step 2**: Add block to i3blocks config:

```nix
xdg.configFile."i3blocks/config".text = ''
  # ... existing blocks ...
  
  [disk]
  command=/home/vpittamp/.config/i3blocks/scripts/disk.sh
  interval=30
  color=#cdd6f4
'';
```

**Step 3**: Rebuild:
```bash
sudo nixos-rebuild switch --flake .#hetzner
```

---

### 5. Customize Block Appearance

**Use Pango Markup** for rich formatting:

```bash
#!/usr/bin/env bash
# CPU with icon and colored percentage

CPU=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)

cat <<EOF
{
  "full_text": "<span foreground='#89b4fa'></span> ${CPU}%",
  "markup": "pango"
}
EOF
```

**Common Nerd Font Icons**:
- CPU: `` (U+F2DB)
- Memory: `` (U+F035B)
- Network: `` (U+F1EB)
- Calendar: `` (U+F073)
- Folder: `` (U+F07C)

**Enable Pango Markup**:
```nix
xdg.configFile."i3blocks/config".text = ''
  markup=pango  # Global setting
'';
```

---

### 6. Change Font

**Location**: `home-modules/desktop/i3.nix`

```nix
bars = [{
  fonts = {
    names = [ "JetBrainsMono Nerd Font" ];  # Change font
    size = 11.0;  # Change size
  };
}];
```

**Available Fonts** (check with `fc-list`):
- FiraCode Nerd Font
- JetBrainsMono Nerd Font
- Hack Nerd Font
- Iosevka Nerd Font

---

### 7. Modify Separator Appearance

**Global Separator**:
```nix
xdg.configFile."i3blocks/config".text = ''
  separator_block_width=20  # Wider separator (default: 15)
'';
```

**Per-Block Separator**:
```bash
cat <<EOF
{
  "full_text": "CPU: 25%",
  "separator": true,
  "separator_block_width": 25  # Override global setting
}
EOF
```

**Disable Separator**:
```bash
{
  "full_text": "...",
  "separator": false  # No separator after this block
}
```

---

### 8. Add Click Actions (Optional)

**Enable click events** in bar config:

```nix
bars = [{
  extraConfig = ''
    click_events yes
  '';
}];
```

**Handle clicks in script**:
```bash
#!/usr/bin/env bash

case $BLOCK_BUTTON in
  1)  # Left click - open htop
    alacritty -e htop &
    ;;
  3)  # Right click - refresh immediately
    # Just re-run the script
    ;;
esac

# Normal output
echo '{"full_text":"CPU: 25%"}'
```

---

## Troubleshooting

### Bar Not Appearing

**Check i3 is running**:
```bash
pgrep -a i3
```

**Check i3bar processes**:
```bash
pgrep -a i3bar
```

**Expected**: One i3bar process per monitor

**Check i3 config syntax**:
```bash
i3 -C
```

---

### Status Blocks Not Showing

**Check i3blocks is running**:
```bash
pgrep -a i3blocks
```

**Check i3blocks config**:
```bash
cat ~/.config/i3blocks/config
```

**Test script manually**:
```bash
~/.config/i3blocks/scripts/cpu.sh
```

**Expected**: Valid JSON output

**Validate JSON**:
```bash
~/.config/i3blocks/scripts/cpu.sh | jq .
```

---

### Colors Not Showing

**Check color format**:
- ✅ Correct: `#cdd6f4` (6-digit hex)
- ❌ Wrong: `cdd6f4` (missing #)
- ❌ Wrong: `#cd6` (3-digit shorthand not supported)

**Check script output**:
```bash
~/.config/i3blocks/scripts/cpu.sh | jq -r '.color'
```

---

### Project Indicator Not Updating

**Check project state file**:
```bash
cat ~/.config/i3/active-project | jq .
```

**Expected**: Valid JSON with `name` and `display_name`

**Test signal manually**:
```bash
pkill -RTMIN+10 i3blocks
```

**Check signal number in config**:
```ini
[project]
signal=10  # Must match RTMIN+10
```

---

### Script Taking Too Long

**Test execution time**:
```bash
time ~/.config/i3blocks/scripts/cpu.sh
```

**Expected**: <100ms

**Optimize**: See [Performance Guidelines](contracts/i3blocks-protocol.md#performance-guidelines)

---

## Advanced Customization

### Per-Monitor Bar Configuration

**Different settings per monitor**:
```nix
bars = [
  {
    position = "bottom";
    output = "rdp0";  # Primary monitor
    statusCommand = "${pkgs.i3blocks}/bin/i3blocks -c ${fullConfig}";
  }
  {
    position = "top";
    output = "rdp1";  # Secondary monitor
    statusCommand = "${pkgs.i3blocks}/bin/i3blocks -c ${minimalConfig}";
  }
];
```

---

### Custom Color Schemes

**Create a theme**:
```nix
let
  # Define custom theme
  myTheme = {
    bg = "#282a36";        # Dracula background
    fg = "#f8f8f2";        # Dracula foreground
    purple = "#bd93f9";    # Dracula purple
    # ... more colors
  };
in
{
  bars = [{
    colors = {
      background = myTheme.bg;
      statusline = myTheme.fg;
      focused_workspace = {
        border = myTheme.purple;
        background = myTheme.purple;
        text = myTheme.bg;
      };
    };
  }];
}
```

---

### Long-Running Block (Persist Mode)

**Example**: Monitor i3 events in real-time

```bash
#!/usr/bin/env bash
# Long-running block that subscribes to i3 events

# Send i3bar protocol header
echo '{"version":1}'
echo '['
echo '[]'

# Subscribe to i3 workspace events
i3-msg -t subscribe -m '["workspace"]' | while read -r event; do
  # Parse event and output status
  WORKSPACE=$(echo "$event" | jq -r '.current.name')
  echo ",[{\"full_text\":\"WS: $WORKSPACE\"}]"
done
```

**Config**:
```ini
[workspace-monitor]
command=/path/to/script.sh
interval=persist  # Long-running
```

**Caution**: Advanced usage, can cause issues if script crashes.

---

## Configuration Reference

### Full Example Configuration

**home-modules/desktop/i3.nix**:
```nix
{ config, lib, pkgs, ... }:

{
  xsession.windowManager.i3.config = {
    bars = [{
      position = "bottom";
      statusCommand = "${pkgs.i3blocks}/bin/i3blocks -c ${config.xdg.configHome}/i3blocks/config";
      workspaceButtons = true;
      fonts = {
        names = [ "FiraCode Nerd Font" ];
        size = 10.0;
      };
      colors = {
        background = "#1e1e2e";
        statusline = "#cdd6f4";
        separator  = "#6c7086";
        
        focused_workspace  = {
          border = "#b4befe";
          background = "#45475a";
          text = "#cdd6f4";
        };
        active_workspace   = {
          border = "#89b4fa";
          background = "#313244";
          text = "#cdd6f4";
        };
        inactive_workspace = {
          border = "#313244";
          background = "#1e1e2e";
          text = "#bac2de";
        };
        urgent_workspace   = {
          border = "#f38ba8";
          background = "#f38ba8";
          text = "#1e1e2e";
        };
      };
    }];
  };
}
```

---

## Migration from Polybar

### Feature Comparison

| Feature | Polybar | i3bar + i3blocks | Notes |
|---------|---------|------------------|-------|
| Workspace indicators | External module | Native i3 integration | Better in i3bar |
| System info | Built-in modules | Custom scripts | More flexible |
| Click actions | Module-specific | Generic click events | Different approach |
| Visual customization | Extensive | Moderate | Simpler in i3bar |
| Multi-monitor | pin-workspaces option | Native i3 handling | Automatic in i3bar |
| Reliability | Complex systemd service | Managed by i3 | More reliable |

### Key Differences

**Polybar**:
- Standalone status bar (separate from WM)
- Complex module system
- Extensive visual customization
- Requires systemd service management

**i3bar**:
- Native i3 component
- Simple script-based blocks
- Good enough visual customization
- Lifecycle managed by i3

---

## Getting Help

**Check Documentation**:
- i3 User Guide: https://i3wm.org/docs/userguide.html
- i3bar Protocol: https://i3wm.org/docs/i3bar-protocol.html
- i3blocks Wiki: https://github.com/vivien/i3blocks/wiki

**Debug Commands**:
```bash
# Check i3 configuration
i3 -C

# View i3 log
tail -f ~/.local/share/i3/log

# Test i3blocks manually
i3blocks -c ~/.config/i3blocks/config

# View i3 IPC messages
i3-msg -t get_bar_config
i3-msg -t get_workspaces
```

**Common Issues**:
- Bar not appearing → Check i3 config syntax
- Blocks not showing → Test scripts manually
- Colors wrong → Validate hex codes
- Performance slow → Profile script execution time

---

## Next Steps

1. **Customize colors** to match your preference
2. **Add custom blocks** for your workflow (battery, weather, etc.)
3. **Optimize update intervals** based on your needs
4. **Set up click actions** for interactive blocks
5. **Create themes** for different contexts (work, focus mode)

**Remember**: All changes must be made in Nix files and applied via `nixos-rebuild switch`.
