# Quick Reference Card: Script Conversion Pattern

**Feature 014** - Constitutional Compliance Remediation
**Use this as a cheat sheet when converting scripts**

---

## ‚ö° Conversion Checklist

For each script conversion:

- [ ] Read original script file
- [ ] Identify all binary dependencies
- [ ] Identify common.sh function dependencies
- [ ] Convert to `text = ''...''` syntax
- [ ] Replace shebang with `#!${pkgs.bash}/bin/bash`
- [ ] Add binary path variables at top
- [ ] Inline common functions via `${commonFunctions}`
- [ ] Escape bash variables: `''${VAR}`
- [ ] Test with `nixos-rebuild dry-build`
- [ ] Deploy with `nixos-rebuild switch`
- [ ] Manually test the script
- [ ] Mark task as [X] in tasks.md

---

## üîß Binary Path Quick Reference

```nix
# Core utilities
BASH="${pkgs.bash}/bin/bash"
CAT="${pkgs.coreutils}/bin/cat"
ECHO="${pkgs.coreutils}/bin/echo"
DATE="${pkgs.coreutils}/bin/date"
MV="${pkgs.coreutils}/bin/mv"
RM="${pkgs.coreutils}/bin/rm"
MKDIR="${pkgs.coreutils}/bin/mkdir"
SLEEP="${pkgs.coreutils}/bin/sleep"

# JSON processing
JQ="${pkgs.jq}/bin/jq"

# Text processing
AWK="${pkgs.gawk}/bin/awk"
GREP="${pkgs.gnugrep}/bin/grep"
SED="${pkgs.gnused}/bin/sed"

# i3 and window management
I3MSG="${pkgs.i3}/bin/i3-msg"
XDOTOOL="${pkgs.xdotool}/bin/xdotool"

# Process management
PKILL="${pkgs.procps}/bin/pkill"
PGREP="${pkgs.procps}/bin/pgrep"

# Applications
CODE="${pkgs.vscode}/bin/code"
ROFI="${pkgs.rofi}/bin/rofi"
```

---

## üìù Template: Basic Script Conversion

```nix
# In home-modules/desktop/i3-project-manager.nix

home.file.".config/i3/scripts/script-name.sh" = {
  executable = true;
  text = ''
    #!${pkgs.bash}/bin/bash
    # Script description
    # Declaratively generated by home-manager

    set -euo pipefail

    # Source common functions
    ${commonFunctions}

    # Binary paths
    JQ="${pkgs.jq}/bin/jq"
    ECHO="${pkgs.coreutils}/bin/echo"
    CAT="${pkgs.coreutils}/bin/cat"

    main() {
      # Script logic here
      # Use ''${VAR} for bash variables
      # Use $BINARY for commands

      local project_name="$1"
      $ECHO "Processing: $project_name"
    }

    main "$@"
  '';
};
```

---

## üîÅ Common Patterns

### Pattern 1: Reading JSON Files
```bash
# Original
project_json=$(cat "$file")
name=$(echo "$project_json" | jq -r '.project.name')

# Converted
project_json=$($CAT "$file")
name=$($ECHO "$project_json" | $JQ -r '.project.name')
```

### Pattern 2: i3 IPC Queries
```bash
# Original
windows=$(i3-msg -t get_tree | jq -r '.. | select(.marks) | .window')

# Converted
windows=$($I3MSG -t get_tree | $JQ -r '.. | select(.marks) | .window')
```

### Pattern 3: Atomic File Writes
```bash
# Original
echo "$json" > "$file"

# Converted
temp_file="''${file}.tmp"
$ECHO "$json" > "$temp_file"
$MV "$temp_file" "$file"
```

### Pattern 4: Logging
```bash
# Use pre-defined functions from commonFunctions
log_info "Operation completed"
log_error "Operation failed: $reason"
```

---

## ‚ö†Ô∏è Common Mistakes

### Mistake 1: Forgetting to Escape Bash Variables
```nix
# ‚ùå WRONG - Nix will try to interpolate $VAR
text = ''
  project_name=$PROJECT_DIR/config.json
'';

# ‚úÖ CORRECT - Escape with ''
text = ''
  project_name=''${PROJECT_DIR}/config.json
'';
```

### Mistake 2: Using Hardcoded Paths
```nix
# ‚ùå WRONG
text = ''
  jq -r '.name' "$file"
'';

# ‚úÖ CORRECT
text = ''
  JQ="${pkgs.jq}/bin/jq"
  $JQ -r '.name' "$file"
'';
```

### Mistake 3: Sourcing External Files
```nix
# ‚ùå WRONG - Can't source external files
text = ''
  source ~/.config/i3/scripts/common.sh
'';

# ‚úÖ CORRECT - Inline functions
text = ''
  ${commonFunctions}
'';
```

---

## üß™ Testing Commands

```bash
# Step 1: Dry build (catches Nix syntax errors)
nixos-rebuild dry-build --flake .#hetzner --show-trace

# Step 2: Deploy
nixos-rebuild switch --flake .#hetzner

# Step 3: Check generated script
cat ~/.config/i3/scripts/script-name.sh

# Step 4: Test manually
~/.config/i3/scripts/script-name.sh

# Step 5: Check logs
tail -f ~/.config/i3/project-system.log

# Step 6: Run validation
/etc/nixos/tests/validate-i3-schema.sh
```

---

## üìä Complexity Guide

| Complexity | Indicators | Example Scripts |
|------------|-----------|-----------------|
| **Low** | <100 lines, no i3-msg, simple logic | project-list.sh, project-current.sh |
| **Medium** | 100-150 lines, some i3-msg, moderate logic | project-create.sh, launch-code.sh |
| **High** | 150+ lines, heavy i3-msg, complex logic | project-switch.sh |

**Strategy**: Start with low complexity scripts to validate pattern

---

## üéØ Phase 2 Task Order (Recommended)

### Foundation (REQUIRED FIRST)
1. T004: Study i3-project-manager.nix
2. T005: Create commonFunctions

### Simple Scripts (Build Confidence)
3. T009: project-list.sh (LOW)
4. T010: project-current.sh (LOW) ‚Üê Template provided
5. T008: project-clear.sh (LOW)

### Medium Scripts
6. T006: project-create.sh (MEDIUM)
7. T011: project-delete.sh (MEDIUM)
8. T014: launch-lazygit.sh (LOW-MEDIUM)
9. T015: launch-yazi.sh (LOW-MEDIUM)
10. T012: launch-code.sh (MEDIUM)
11. T013: launch-ghostty.sh (MEDIUM)
12. T016: project-logs.sh (MEDIUM)

### Complex Scripts (Save for Last)
13. T007: project-switch.sh (HIGH) ‚Üê Template provided

### i3blocks Scripts (Can Parallelize)
14. T017: project.sh ‚Üê Template provided
15. T018-T021: cpu.sh, memory.sh, network.sh, datetime.sh

### Cleanup
16. T022-T029: Polybar removal, state cleanup

---

## üíæ Backup Before Starting

```bash
# Backup current working system
cp -r ~/.config/i3 ~/.config/i3.backup-$(date +%Y%m%d)

# Backup Nix modules
cd /etc/nixos
git add .
git commit -m "Backup before Phase 2 constitutional compliance"
git branch backup-pre-phase2
```

---

## üÜò Troubleshooting

### Error: "attribute 'pkgs' missing"
**Fix**: Ensure module has `{ config, lib, pkgs, ... }:` at top

### Error: "syntax error, unexpected $end"
**Fix**: Check for unescaped `$` in Nix strings - use `''${var}`

### Error: Script not found after rebuild
**Fix**: Check file path - should be `.config/i3/scripts/` not `~/.config/`

### Script runs but commands fail
**Fix**: Check binary paths - ensure they use `${pkgs.*/bin/*}` format

### Nix evaluation takes forever
**Fix**: Check for infinite recursion in let bindings

---

## ‚úÖ Success Indicators

After each conversion:
- [ ] `nixos-rebuild dry-build` succeeds
- [ ] Script appears in `~/.config/i3/scripts/`
- [ ] Script is executable
- [ ] Script runs without "command not found" errors
- [ ] Script produces expected output
- [ ] No errors in project-system.log

---

## üìö Reference Documents

- **Full Guide**: `IMPLEMENTATION_GUIDE.md`
- **Progress**: `PROGRESS_SUMMARY.md`
- **Tasks**: `tasks.md`
- **Research**: `research.md`
- **Validation**: `/etc/nixos/tests/validate-*.sh`

---

**Print this page and keep it next to your keyboard!** üìÑ

---

**Version**: 1.0 | **Updated**: 2025-10-19
