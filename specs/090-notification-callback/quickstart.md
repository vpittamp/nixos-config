# Quickstart: Enhanced Notification Callback for Claude Code

**Feature**: 090-notification-callback
**Status**: Implementation pending
**Quick Reference**: Return to Claude Code terminal from any project/workspace with one click or Enter key

## TL;DR

When Claude Code finishes a long-running task and you're working in another project, click "Return to Window" (or press **Enter**) in the notification to instantly switch back to the exact terminal and tmux pane where Claude Code is waiting.

**Before**: Manually navigate back (10-15s): switch project ‚Üí find workspace ‚Üí locate terminal ‚Üí enter correct tmux pane
**After**: Enter key (< 2s): automated project switch + workspace focus + terminal focus + tmux pane selection

## Quick Start

### Receiving Notifications

1. **Start Claude Code in a project terminal**:
   ```bash
   # Switch to project (sets I3PM_PROJECT_NAME environment variable)
   i3pm project switch nixos-090-notification-callback

   # Launch terminal on workspace 1 (where Claude Code runs)
   # Terminal inherits project environment variables

   # Start Claude Code
   claude-code
   ```

2. **Start a long-running task**:
   ```
   > analyze all Python files and suggest improvements
   ```

3. **Switch to another project while Claude Code works**:
   ```bash
   # User presses Win+P (project switcher)
   # User selects "nixos-089-cleanup" project
   # i3pm switches to project B, hides nixos-090 terminal
   ```

4. **Receive notification when Claude Code finishes**:
   ```
   Notification Title: Claude Code Ready
   Message: I've analyzed 23 Python files and identified 15 improvement opportunities...

   üìä Activity: 5 bash, 3 reads

   üìÅ nixos-090-notification-callback

   Source: nixos-090:0

   [üñ•Ô∏è  Return to Window]  [Dismiss]
   ```

5. **Click "Return to Window" or press Enter**:
   - System switches from nixos-089 back to nixos-090 project
   - Workspace 1 focused (where terminal lives)
   - Ghostty terminal window focused
   - tmux window 0 selected (where Claude Code is running)
   - **You can immediately type your next prompt** (< 2 seconds total)

### Keyboard Shortcuts

**Note**: SwayNC has hardcoded shortcuts that cannot be customized.

| Key | Action |
|-----|--------|
| **Enter** / **Return** | Return to Claude Code terminal (same as clicking "Return to Window") |
| **Escape** | Dismiss notification without changing focus |
| **Delete** / **Backspace** | Dismiss notification without changing focus |

### Same-Project Navigation (No Project Switch)

If you're already in the same project but on a different workspace:

1. Claude Code running on workspace 1
2. You open VS Code on workspace 2 to review code
3. Claude Code finishes, notification appears
4. Press **Enter** ‚Üí instantly jump to workspace 1 terminal
5. (No project switch needed - already in correct project)

## Use Cases

### Use Case 1: Cross-Project Context Switching

**Scenario**: You're refactoring Feature 090 code but need to quickly check Feature 089 documentation while Claude Code processes files.

**Workflow**:
1. In `nixos-090` project: Start Claude Code task "refactor notification hooks"
2. While Claude Code works: Switch to `nixos-089` project to review related code
3. Notification arrives: "Claude Code Ready - refactoring complete"
4. Press **Enter**: Back to `nixos-090` terminal instantly
5. Review Claude Code suggestions and provide next prompt

**Time saved**: 13 seconds (15s manual navigation - 2s automated return)

### Use Case 2: Multi-Workspace Productivity

**Scenario**: Claude Code running test suite on workspace 1, you're reviewing test output in browser on workspace 3.

**Workflow**:
1. Workspace 1: Claude Code running `pytest tests/090-notification-callback/`
2. Workspace 3: Firefox open to test documentation
3. Notification: "Claude Code Ready - 15 tests passed"
4. Press **Enter**: Jump to workspace 1 terminal
5. See full test output, start next task

**Time saved**: 8 seconds (10s workspace switching - 2s automated focus)

### Use Case 3: Notification Deferral

**Scenario**: Claude Code finishes but you're in the middle of critical work and can't context switch yet.

**Workflow**:
1. Notification appears: "Claude Code Ready"
2. You're focused on time-sensitive task in current project
3. Press **Escape**: Dismiss notification, stay in current context
4. Later: Manually switch back to Claude Code project when ready
5. Claude Code still waiting for input (dismissal didn't affect state)

## Configuration

### SwayNC Keybindings (Hardcoded)

**Note**: SwayNC has hardcoded keyboard shortcuts that cannot be customized through config.json.

Built-in shortcuts:
- **Enter/Return**: Execute default notification action (notification-action-0)
- **1-9**: Execute alternative notification actions
- **Escape**: Dismiss notification
- **Delete/Backspace**: Dismiss notification

File: `~/.config/swaync/config.json` (generated by home-manager)

```json
{
  "keyboard-shortcuts": true  // Enable hardcoded shortcuts
}
```

**No manual configuration needed** - shortcuts are built into SwayNC and enabled by default.

### Notification Hook (Already Configured)

File: `/etc/nixos/home-modules/ai-assistants/claude-code.nix`

```nix
hooks = {
  Stop = [{
    hooks = [{
      type = "command";
      command = "${self}/scripts/claude-hooks/stop-notification.sh";
      timeout = 3;
    }];
  }];
}
```

**No manual configuration needed** - hook automatically enabled via home-manager configuration.

## Troubleshooting

### Notification doesn't appear

**Symptom**: Claude Code finishes but no notification displayed

**Causes**:
1. SwayNC not running
2. Notification timeout too short
3. Hook execution failed

**Diagnostics**:
```bash
# Check if SwayNC is running
pgrep -x swaync
# Output: Process ID (e.g., 12345) - SwayNC is running
# Output: (empty) - SwayNC not running

# Restart SwayNC
systemctl --user restart swaync

# Check notification hook logs (if hook failed)
journalctl --user -u home-manager-vpittamp.service | grep "stop-notification"
```

### "Return to Window" doesn't focus terminal

**Symptom**: Clicking notification action or pressing Enter does nothing

**Causes**:
1. Terminal window closed before action clicked
2. i3pm daemon not running (project switch fails)
3. Sway IPC error (window focus fails)

**Diagnostics**:
```bash
# Check if terminal window still exists
swaymsg -t get_tree | jq '.. | objects | select(.type=="con") | select(.app_id=="com.mitchellh.ghostty")'
# Output: Window details - terminal exists
# Output: (empty) - terminal closed

# Check if i3pm daemon running
pgrep -f "i3-project-event-listener"
# Output: Process ID - daemon running
# Output: (empty) - daemon not running

# Restart i3pm daemon
systemctl --user restart i3-project-event-listener

# Test project switch manually
i3pm project switch nixos-090-notification-callback
```

### tmux window not selected after focus

**Symptom**: Terminal focused but wrong tmux window/pane active

**Causes**:
1. tmux session killed before action clicked
2. tmux window index changed (windows added/removed)
3. tmux `select-window` command failed

**Diagnostics**:
```bash
# Check if tmux session exists
tmux has-session -t nixos-090
echo $?
# Output: 0 - session exists
# Output: 1 - session doesn't exist

# List tmux sessions
tmux list-sessions

# Manually select tmux window
tmux select-window -t nixos-090:0
```

### Project switch takes > 2 seconds

**Symptom**: Notification action is slow, feels unresponsive

**Causes**:
1. Many scoped windows need to be shown/hidden
2. i3pm daemon busy processing other events
3. System under heavy load

**Diagnostics**:
```bash
# Check i3pm daemon status
i3pm daemon status

# Check system load
uptime

# Check number of scoped windows in project
i3pm windows --project nixos-090-notification-callback | wc -l
```

**Mitigation**: Reduce number of scoped windows in project (close unused terminals/editors)

### Notification action has no effect (silent failure)

**Symptom**: Clicking "Return to Window" does nothing, no error shown

**Causes**:
1. Window ID invalid (terminal window no longer exists)
2. Project name invalid (project deleted or renamed)
3. notification-handler.sh script error

**Diagnostics**:
```bash
# Enable debug logging in notification handler
# Edit scripts/claude-hooks/stop-notification-handler.sh
# Add: set -x  # Enable Bash debug output

# Trigger notification manually (for testing)
bash scripts/claude-hooks/stop-notification-handler.sh \
    "12345" \
    "Test notification" \
    "nixos-090" \
    "0"

# Check stderr output for errors
```

## Advanced Usage

### Testing Notification Workflow

**Manual test** (trigger notification without Claude Code):

```bash
# 1. Get current terminal window ID
WINDOW_ID=$(swaymsg -t get_tree | jq -r '.. | objects | select(.focused==true) | .id')

# 2. Get tmux session info
TMUX_SESSION=$(tmux display-message -p "#{session_name}")
TMUX_WINDOW=$(tmux display-message -p "#{window_index}")

# 3. Trigger notification handler directly
nohup scripts/claude-hooks/stop-notification-handler.sh \
    "$WINDOW_ID" \
    "Test notification - click Return to Window to focus this terminal" \
    "$TMUX_SESSION" \
    "$TMUX_WINDOW" \
    >/dev/null 2>&1 &

# 4. Switch to different workspace
swaymsg workspace 3

# 5. Wait for notification, click "Return to Window" or press Enter
# Expected: Terminal focused, workspace restored
```

**Automated test** (sway-test framework):

```bash
# Run sway-test suite for notification callback
sway-test run tests/090-notification-callback/test-same-project-focus.json

# Expected output:
# ‚úì Same-project terminal focus after notification (1.2s)
```

### Customizing Notification Content

**Edit hook script** to change notification message format:

File: `scripts/claude-hooks/stop-notification.sh`

```bash
# Customize notification body sections
NOTIFICATION_BODY="$LAST_MESSAGE"

# Add custom context (e.g., token count, execution time)
if [ -n "$CUSTOM_CONTEXT" ]; then
    NOTIFICATION_BODY="${NOTIFICATION_BODY}\n\nüìä ${CUSTOM_CONTEXT}"
fi
```

**Rebuild home-manager** to apply changes:

```bash
home-manager switch --flake .
```

### Multiple Claude Code Instances

If running multiple Claude Code instances in different terminals:

- Each instance sends notifications with **unique window IDs**
- Each notification action focuses the **specific terminal** that sent it
- No ambiguity - notifications include source info (project:session:window)

**Example**:

Terminal 1 (nixos-090 project):
```
Notification: Claude Code Ready
Source: nixos-090:0
[Return to Window] ‚Üê Focuses Terminal 1
```

Terminal 2 (dotfiles project):
```
Notification: Claude Code Ready
Source: dotfiles:1
[Return to Window] ‚Üê Focuses Terminal 2
```

## Performance Expectations

| Operation | Typical Time | Max Time (Budget) |
|-----------|--------------|-------------------|
| Notification hook execution | 50-100ms | 100ms |
| Notification display | Instant | N/A |
| Project switch (simple) | 200-500ms | 2000ms |
| Project switch (complex) | 500-1000ms | 2000ms |
| Terminal window focus | 50-100ms | 200ms |
| tmux window selection | 50-100ms | 200ms |
| **Total (notification to focused)** | **0.5-1.5s** | **2s** |

**"Simple" project**: 1-3 scoped windows
**"Complex" project**: 10+ scoped windows (many show/hide operations)

## Integration with Existing Workflow

### Feature 062: Scratchpad Terminal

Notification callback works with scratchpad terminal:

```bash
# Launch project-scoped scratchpad terminal
i3pm scratchpad toggle

# Start Claude Code in scratchpad terminal
claude-code

# Switch to different workspace, notification arrives
# Press Enter ‚Üí Scratchpad terminal shows and focuses
```

### Feature 078: Project Switcher

Notification callback integrates with project switcher:

```bash
# Use project switcher to change projects
Win+P ‚Üí Select "nixos-089-cleanup"

# Claude Code finishes in nixos-090 project
# Notification arrives with "nixos-090:0" source info

# Press Enter ‚Üí Project switcher reverses navigation back to nixos-090
```

### Feature 087: Remote Projects (SSH)

Notification callback works with remote projects:

```bash
# Create remote project
i3pm project create-remote hetzner-dev --remote-host hetzner-sway.tailnet

# Switch to remote project
i3pm project switch hetzner-dev

# Start Claude Code in remote terminal (via SSH)
# Notification arrives when Claude Code finishes

# Press Enter ‚Üí Switches back to hetzner-dev project, focuses SSH terminal
```

## Next Steps

- **Implementation**: `/speckit.tasks` to generate task breakdown
- **Testing**: Run `sway-test run tests/090-notification-callback/*.json` after implementation
- **Documentation**: Update `CLAUDE.md` with notification callback usage instructions

## Related Features

- **Feature 079**: Notification hook already captures tmux session/window info
- **Feature 078**: Project switcher provides `i3pm project switch` command
- **Feature 062**: Scratchpad terminal integration
- **Feature 087**: Remote project SSH terminal support
