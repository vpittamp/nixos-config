# Implementation Plan: NixOS Full Observability Stack

**Branch**: `129-create-observability-nixos` | **Date**: 2025-12-19 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/129-create-observability-nixos/spec.md`

## Summary

Deploy comprehensive observability stack on NixOS workstations using Grafana Alloy as unified telemetry collector, Beyla for eBPF auto-instrumentation, and Pyroscope for continuous profiling. Local AI session monitoring (otel-ai-monitor) is preserved for real-time EWW widget updates. All telemetry is exported to Kubernetes-hosted LGTM stack (Mimir, Loki, Tempo, Grafana, Pyroscope) via Tailscale for centralized storage and visualization.

## Technical Context

**Language/Version**: Nix (flakes), Alloy configuration language, Python 3.11+ (existing otel-ai-monitor)
**Primary Dependencies**: Grafana Alloy 1.x, Grafana Beyla 1.x, Pyroscope agent, opentelemetry-collector-contrib
**Storage**: Remote only (Kubernetes LGTM stack); local memory buffer (100MB) for offline queuing
**Testing**: NixOS dry-build validation, integration tests via systemd service status checks
**Target Platform**: NixOS (Linux x86_64), kernel 5.8+ with BTF support for Beyla eBPF
**Project Type**: NixOS module configuration (infrastructure-as-code)
**Performance Goals**: Alloy <200MB memory, Beyla <5% overhead, telemetry latency <30s to Grafana
**Constraints**: Must preserve existing otel-ai-monitor latency (<1s to EWW), graceful degradation when K8s unreachable
**Scale/Scope**: 3-5 workstations sending to single Kubernetes cluster

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Modular Composition | ✅ PASS | New modules: `services/grafana-alloy.nix`, `services/grafana-beyla.nix`, `services/pyroscope-agent.nix` |
| II. Reference Implementation Flexibility | ✅ PASS | Hetzner-sway remains reference; observability modules are additive |
| III. Test-Before-Apply | ✅ PASS | All changes validated via `nixos-rebuild dry-build` |
| IV. Override Priority Discipline | ✅ PASS | Use `mkDefault` for configurable ports/endpoints |
| V. Platform Flexibility | ✅ PASS | Modules detect capabilities (eBPF support, systemd availability) |
| VI. Declarative Configuration | ✅ PASS | All services configured via NixOS options, no imperative scripts |
| VII. Documentation as Code | ✅ PASS | quickstart.md generated, CLAUDE.md updated |
| X. Python Development Standards | ✅ PASS | otel-ai-monitor unchanged (async, pytest, type hints) |
| XI. i3 IPC Alignment | N/A | Not applicable to observability stack |
| XII. Forward-Only Development | ✅ PASS | Replaces otel-ai-collector with Alloy; no backwards compatibility |
| XIV. Test-Driven Development | ✅ PASS | Integration tests for service status and telemetry flow |

**Gate Status**: ✅ PASSED - No violations

## Project Structure

### Documentation (this feature)

```text
specs/129-create-observability-nixos/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output
├── quickstart.md        # Phase 1 output
├── contracts/           # Phase 1 output (OTLP endpoints, Alloy config schema)
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
modules/services/
├── grafana-alloy.nix        # Unified OTEL collector (replaces otel-ai-collector.nix)
├── grafana-beyla.nix        # eBPF auto-instrumentation service
└── pyroscope-agent.nix      # Continuous profiling agent

home-modules/services/
└── otel-ai-monitor.nix      # PRESERVED - local AI session tracking

configurations/
├── hetzner-sway.nix         # Enable observability modules
├── thinkpad.nix             # Enable observability modules
└── ryzen.nix                # Enable observability modules (optional - may be K8s only)

scripts/otel-ai-monitor/     # PRESERVED - existing Python service (unchanged)
```

**Structure Decision**: Infrastructure-as-code pattern using NixOS modules. New services are system-level (modules/services/), existing AI monitoring remains user-level (home-modules/services/). No new source directories created; this is configuration-only.

## Complexity Tracking

> No violations requiring justification.

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| (none) | - | - |
