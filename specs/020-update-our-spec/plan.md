# Implementation Plan: App Discovery & Auto-Classification System

**Branch**: `020-update-our-spec` | **Date**: 2025-10-21 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/020-update-our-spec/spec.md`

## Summary

Extend i3pm (i3 Project Manager) with four enhancements for automatic application classification: (1) Pattern-based rules using glob/regex to match window classes (2) Automated window class detection via Xvfb isolation (3) Interactive TUI wizard for visual classification workflows (4) Real-time window inspector for troubleshooting and direct classification. These enhancements reduce manual classification work by 95% (from 50 manual edits to 1 pattern rule), enable new users to complete setup in under 5 minutes, and provide comprehensive diagnostics for troubleshooting. Implementation builds on existing foundation (80% of pattern code exists in config.py, 60% of detection code exists in app_discovery.py).

## Technical Context

**Language/Version**: Python 3.11+ (matches existing i3-project daemon standard)
**Primary Dependencies**:
- Core: i3ipc (async i3 IPC), textual (TUI framework), rich (terminal formatting), argcomplete (shell completion)
- Detection: xvfb-run, xdotool, xprop (external binaries for isolated window class detection)
- Testing: pytest, pytest-asyncio, pytest-textual (TUI testing)
**Storage**: JSON files (`~/.config/i3/app-classes.json`), detection result cache (`~/.cache/i3pm/detected-classes.json`)
**Testing**: pytest with pytest-asyncio for async tests, pytest-textual for TUI interaction tests, mocked Xvfb for isolated testing
**Target Platform**: NixOS with i3 window manager (X11 only, Wayland out of scope per FR-073 assumption #2)
**Project Type**: Single Python package extending existing i3pm CLI/TUI application
**Performance Goals**:
- Pattern matching: <1ms per window with 100+ patterns (FR-078, SC-025)
- Wizard TUI: <50ms keyboard response time (FR-109, SC-026)
- Xvfb detection: 10 apps in <60s (SC-022)
- Inspector: property display in <100ms live mode (SC-037)
**Constraints**:
- Memory: <100MB for wizard with 1000+ apps (FR-109)
- Cleanup: 100% reliable resource cleanup, zero zombie processes (FR-089, SC-027)
- Data integrity: Atomic writes (temp file + rename) for concurrent safety (FR-106, FR-119)
- Responsiveness: All TUI operations <50ms (SC-026), daemon reload <100ms (assumption #6)
**Scale/Scope**:
- Applications: 1000+ apps discovered via desktop files
- Patterns: 100+ glob/regex rules with precedence
- Concurrent sessions: Single user, single wizard/inspector instance (assumption #8)
- Event buffer: 500 events max in circular buffer for diagnostics

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### ✅ Core Principles Compliance

**I. Modular Composition**:
- ✅ Extends existing `home-modules/tools/i3_project_manager/` modular structure
- ✅ No code duplication - builds on existing `core/config.py` (patterns), `core/app_discovery.py` (detection)
- ✅ Clear separation: `cli/commands.py` (CLI), `tui/` (wizard/inspector), `core/` (business logic)

**III. Test-Before-Apply**:
- ✅ NixOS package rebuild required after Python code changes
- ✅ `sudo nixos-rebuild dry-build --flake .#hetzner` before switch
- ✅ Automated pytest test suite validates functionality before deployment

**V. Platform Flexibility Through Conditional Features**:
- ✅ Xvfb detection degrades gracefully if dependencies unavailable (FR-092)
- ✅ TUI adapts to terminal capabilities (colors, UTF-8 glyphs per assumption #7)
- ✅ CLI provides JSON output for scripting alongside rich TUI mode

**VI. Declarative Configuration Over Imperative**:
- ✅ All dependencies declared in `pyproject.toml` and `i3-project-manager.nix`
- ✅ NixOS package installation via `home.packages` in home-manager module
- ✅ Configuration files (`app-classes.json`) generated by Python code, not shell scripts

**VII. Documentation as Code**:
- ✅ Module docstrings (Google style) for all public APIs (per Principle X)
- ✅ User guide sections: Pattern Rules, Wizard, Inspector, Detection (FR-135 UAT requirements)
- ✅ Troubleshooting guide with common issues and remediation steps (SC-036)

**X. Python Development & Testing Standards**:
- ✅ Python 3.11+ with async/await for i3 IPC (via i3ipc.aio)
- ✅ pytest + pytest-asyncio for testing framework
- ✅ Type hints for function signatures and public APIs
- ✅ Rich library for terminal UI (tables, live displays, formatting)
- ✅ Pydantic models or dataclasses for data validation

**XI. i3 IPC Alignment & State Authority**:
- ✅ Window properties queried via GET_TREE (WM_CLASS, marks, workspace)
- ✅ Classification triggers window marking via i3 COMMAND (mark window with project)
- ✅ Inspector live mode subscribes to i3 events (window::title, window::mark)
- ✅ Event-driven architecture, no polling (consistent with Feature 015 daemon)

### Principle Compliance Table

| Principle | Status | Evidence |
|-----------|--------|----------|
| Modular Composition | ✅ PASS | Extends existing modules, no duplication |
| Test-Before-Apply | ✅ PASS | dry-build + pytest required before merge |
| Platform Flexibility | ✅ PASS | Graceful degradation (Xvfb), terminal adaptation |
| Declarative Config | ✅ PASS | NixOS package, no imperative scripts |
| Documentation | ✅ PASS | Docstrings, user guide, troubleshooting |
| Python Standards | ✅ PASS | Python 3.11+, async/await, pytest, Rich |
| i3 IPC Alignment | ✅ PASS | GET_TREE, COMMAND, event subscriptions |

**Result**: ✅ **GATE PASSED** - No constitution violations. Proceed to Phase 0.

## Project Structure

### Documentation (this feature)

```
specs/020-update-our-spec/
├── spec.md                  # Feature specification (complete)
├── plan.md                  # This file (/speckit.plan command output)
├── research.md              # Phase 0 output (next)
├── data-model.md            # Phase 1 output
├── quickstart.md            # Phase 1 output
├── contracts/               # Phase 1 output (CLI commands, TUI interactions)
├── checklists/              # Quality validation
│   └── requirements.md      # Spec quality checklist (complete)
└── tasks.md                 # Phase 2 output (/speckit.tasks command - NOT created yet)
```

### Source Code (repository root)

```
home-modules/tools/i3_project_manager/
├── __init__.py
├── __main__.py                      # Entry point (existing)
├── core/
│   ├── __init__.py
│   ├── config.py                    # AppClassConfig (existing) - EXTEND for patterns
│   ├── app_discovery.py             # AppDiscovery (existing) - ACTIVATE Xvfb detection
│   ├── i3_client.py                 # i3 IPC wrapper (existing)
│   └── pattern_matcher.py           # NEW - Pattern matching engine
├── cli/
│   ├── __init__.py
│   └── commands.py                  # CLI commands (existing) - ADD pattern/detect/inspect commands
├── tui/                             # NEW - Textual TUI applications
│   ├── __init__.py
│   ├── wizard.py                    # Classification wizard TUI
│   ├── inspector.py                 # Window inspector TUI
│   ├── widgets/                     # Reusable TUI components
│   │   ├── __init__.py
│   │   ├── app_table.py             # Sortable app table widget
│   │   ├── detail_panel.py          # App detail display widget
│   │   └── property_display.py      # Window property display widget
│   └── screens/                     # TUI screen definitions
│       ├── __init__.py
│       ├── wizard_screen.py         # Wizard main screen
│       └── inspector_screen.py      # Inspector main screen
└── models/                          # NEW - Data models
    ├── __init__.py
    ├── pattern.py                   # PatternRule model
    ├── detection.py                 # DetectionResult model
    └── classification.py            # AppClassification model

tests/i3_project_manager/
├── unit/
│   ├── test_pattern_matcher.py     # Pattern matching unit tests
│   ├── test_models.py               # Data model validation tests
│   └── test_config.py               # Config management tests (existing - EXTEND)
├── integration/
│   ├── test_xvfb_detection.py      # Xvfb detection integration tests (mocked)
│   ├── test_wizard_workflow.py     # Wizard TUI workflow tests
│   └── test_inspector_workflow.py  # Inspector TUI workflow tests
├── scenarios/
│   ├── test_pattern_lifecycle.py   # Pattern creation → matching → classification
│   ├── test_detection_workflow.py  # Discovery → detection → classification
│   └── test_classification_e2e.py  # Wizard → pattern → inspector round-trip
└── fixtures/
    ├── mock_xvfb.py                # Xvfb mock for testing
    ├── sample_desktop_files.py     # .desktop file fixtures
    └── sample_patterns.json        # Pattern rule fixtures
```

**Structure Decision**: Single Python project extending existing i3pm package. Chosen because:
1. Seamless integration with existing CLI/TUI framework (FR-058 unified interface)
2. Reuses existing i3 IPC client, config management, daemon communication
3. Maintains consistent user experience (single `i3pm` command with subcommands)
4. Simpler dependency management (single `pyproject.toml`, single Nix package)

**New Components**:
- `tui/`: Textual-based TUI applications (wizard, inspector) - NEW subsystem
- `models/`: Pydantic/dataclass models for patterns, detection, classification - NEW for validation
- `core/pattern_matcher.py`: Glob/regex pattern matching engine - NEW core service
- Tests organized by type (unit/integration/scenarios) per Principle X testing standards

## Complexity Tracking

*No constitution violations requiring justification.*

**Adherence Notes**:
- Modular structure prevents deep hierarchies (max 3 levels: package → subsystem → module)
- No additional platforms beyond existing WSL/Hetzner/M1/containers
- Reuses existing daemon communication, i3 IPC client (no new abstraction layers)
- TUI framework (Textual) justified by FR-095 through FR-110 visual interface requirements
- Pattern precedence rules explicitly specified (FR-076) to prevent ambiguity

---

## Planning Workflow Status

**Phase 0: Research & Design** - ✅ COMPLETE
- Created: [research.md](research.md) - 7 decisions documented with rationale and alternatives
- All NEEDS CLARIFICATION items resolved

**Phase 1: Design Artifacts** - ✅ COMPLETE
- Created: [data-model.md](data-model.md) - 5 entities with dataclass definitions and validation
- Created: [contracts/cli-commands.md](contracts/cli-commands.md) - 9 CLI commands with complete specifications
- Created: [contracts/tui-wizard.md](contracts/tui-wizard.md) - Interactive wizard TUI contract
- Created: [contracts/tui-inspector.md](contracts/tui-inspector.md) - Window inspector TUI contract
- Created: [quickstart.md](quickstart.md) - Developer quick start guide (4-6 week implementation)

**Phase 2: Task Generation** - ✅ COMPLETE
- Created: [tasks.md](tasks.md) - 101 tasks organized by user story priority
- 7 phases: Setup (8) + Foundation (4) + US1-Patterns (18) + US2-Detection (14) + US3-Wizard (23) + US4-Inspector (22) + Polish (12)
- 28 test tasks (TDD approach per FR-131 through FR-135)
- 45 tasks parallelizable within phases
- MVP scope: 30 tasks (Setup + Foundation + US1)
