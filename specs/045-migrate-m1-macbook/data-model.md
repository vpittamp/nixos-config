# Data Model: M1 Sway Migration

**Date**: 2025-10-27
**Feature**: 045-migrate-m1-macbook

## Overview

This document defines the data structures and entities for M1 Sway migration. Most entities are unchanged from Hetzner i3 configuration due to i3 IPC protocol compatibility.

---

## Configuration Entities

### Sway Configuration

**Description**: Sway window manager system configuration generated by NixOS modules.

**Attributes**:
- `keybindings`: Map of key combinations to commands (identical to i3 syntax)
- `outputs`: Map of output names to display configuration
- `bars`: Swaybar configuration (equivalent to i3bar)
- `startup_commands`: Programs to launch at session start
- `window_rules`: for_window directives (identical to i3)
- `workspace_names`: Workspace labels (1-70)

**Storage**: `~/.config/sway/config` (generated by home-manager)

**Relations**:
- References: Application Registry (for window rules)
- Used by: i3pm Daemon (for IPC connection)

**Validation**:
- Keybindings MUST use valid Sway command syntax
- Output names MUST match Sway DRM output identifiers (eDP-1, HDMI-A-1, etc.)
- Workspace numbers MUST be integers 1-70

**Example**:
```toml
# Sway config structure (generated as text)
output "eDP-1" scale 2.0 resolution 2560x1600@60Hz
output "HDMI-A-1" scale 1.0 resolution 1920x1080@60Hz

bindsym Mod4+Return exec ghostty
bindsym Mod4+d exec walker
bindsym Ctrl+1 workspace number 1
bindsym Ctrl+2 workspace number 2

for_window [app_id="walker"] floating enable

bar {
    status_command i3bar-status-event-driven.sh
    position top
}
```

---

### Window State (Sway)

**Description**: Window properties queryable via Sway IPC GET_TREE command. Enhanced from i3 with Wayland-specific fields.

**Attributes**:
- `id`: Window container ID (integer)
- `pid`: Process ID (integer, directly from Sway IPC)
- `app_id`: Wayland application identifier (string, Sway-specific)
- `window_properties`: X11 window properties for XWayland apps (dict with 'class', 'instance', 'title')
- `name`: Window title (string)
- `workspace_number`: Assigned workspace (integer 1-70)
- `output_name`: Monitor name (string, e.g., "eDP-1")
- `marks`: List of marks including project marks (list of strings)
- `geometry`: Position and size (rect with x, y, width, height)
- `floating`: Boolean indicating floating/tiling state
- `visible`: Boolean indicating visibility (not in scratchpad)

**Storage**: Sway compositor memory (queryable via i3 IPC, not persisted)

**Relations**:
- Contains: I3PM Environment Variables (from /proc/<pid>/environ)
- Referenced by: Window-Workspace Map (for state persistence)

**Key Difference from i3**:
- **i3**: Uses `window_properties.class` for all windows (X11 WM_CLASS)
- **Sway**: Uses `app_id` for Wayland apps, `window_properties` only for XWayland apps

**Access Pattern**:
```python
# Sway window property access (i3ipc)
pid = container.ipc_data.get('pid')  # Direct from IPC (no xprop)
app_id = container.app_id  # Wayland app identifier
window_class = container.window_properties.get('class')  # XWayland fallback
title = container.name
marks = container.marks  # List of marks including project:nixos:12345
```

---

### Display Configuration

**Description**: Per-output display settings for HiDPI and multi-monitor support.

**Attributes**:
- `output_name`: Sway output identifier (string, e.g., "eDP-1", "HDMI-A-1")
- `scale`: Scaling factor (float, e.g., 2.0, 1.0, 1.5)
- `resolution`: Display resolution string (e.g., "2560x1600@60Hz")
- `position`: Output position in layout (string, e.g., "0,0", "2560,0")
- `transform`: Rotation (enum: normal, 90, 180, 270)
- `active`: Boolean indicating if output is enabled

**Storage**: Sway config file (`~/.config/sway/config`)

**Relations**:
- Used by: Workspace-Monitor Mapping (for workspace distribution)

**M1 MacBook Pro Defaults**:
```nix
{
  "eDP-1" = {  # Built-in Retina display
    scale = "2.0";
    resolution = "2560x1600@60Hz";
    position = "0,0";
    active = true;
  };
  "HDMI-A-1" = {  # External monitor (example)
    scale = "1.0";
    resolution = "1920x1080@60Hz";
    position = "1280,0";  # Right of built-in (1280 = 2560/2)
    active = true;
  };
}
```

**Validation**:
- Scale MUST be positive float (recommend integer for XWayland compatibility)
- Resolution MUST match output's supported modes
- Position MUST not cause output overlap

---

### Workspace-Monitor Mapping

**Description**: Configuration for automatic workspace distribution across monitors. Identical to i3 configuration (Feature 033).

**Attributes**:
- `version`: Schema version (string, "1.0")
- `enable_auto_reassign`: Boolean for automatic redistribution on monitor changes
- `debounce_ms`: Milliseconds to wait before reassigning (integer, default 500)
- `distributions`: Map of monitor count to workspace assignments
  - Key: "{N}_monitor" or "{N}_monitors" (string)
  - Value: Map of role (primary/secondary/tertiary) to workspace number lists

**Storage**: `~/.config/i3/workspace-monitor-mapping.json` (shared with i3, protocol-agnostic)

**Relations**:
- Used by: i3pm daemon monitor detection handlers
- References: Display Configuration (for output names)

**Validation**:
- Workspace numbers MUST be unique across all roles
- All workspaces 1-70 MUST be assigned
- Role names MUST be primary, secondary, or tertiary

**Example**:
```json
{
  "version": "1.0",
  "enable_auto_reassign": true,
  "debounce_ms": 500,
  "distributions": {
    "1_monitor": {
      "primary": [1, 2, 3, 4, 5, 6, 7, 8, 9, 70]
    },
    "2_monitors": {
      "primary": [1, 2],
      "secondary": [3, 4, 5, 6, 7, 8, 9, 70]
    }
  }
}
```

---

## Daemon State Entities

### Window-Workspace Map

**Description**: Persistent mapping of windows to workspaces for state preservation across project switches. Schema unchanged from i3 (Feature 038 v1.1).

**Attributes**:
- `version`: Schema version (string, "1.1")
- `windows`: Map of window ID to window state
  - `window_id`: Unique window identifier (string, e.g., "project:nixos:12345")
  - `workspace_number`: Last known workspace (integer)
  - `workspace_name`: Workspace name (string, optional)
  - `floating`: Boolean indicating floating/tiling state (preserved across scratchpad)
  - `geometry`: Position and size for floating windows (dict with x, y, width, height)
  - `scratchpad_origin`: Boolean indicating if window was manually placed in scratchpad

**Storage**: `~/.config/i3/window-workspace-map.json`

**Relations**:
- References: Window State (via window marks)
- Used by: Window filtering (on_tick handler)

**State Preservation (Feature 038)**:
- Tiling state preserved across scratchpad operations
- Floating geometry preserved (position + size)
- Workspace assignment persists across project switches

---

### I3PM Environment Variables

**Description**: Environment variables injected by app-launcher-wrapper for project context. Read from `/proc/<pid>/environ` by daemon.

**Attributes** (all strings):
- `I3PM_APP_ID`: Unique instance identifier
- `I3PM_APP_NAME`: Application name from registry
- `I3PM_PROJECT_NAME`: Active project name (or empty)
- `I3PM_PROJECT_DIR`: Project directory path
- `I3PM_PROJECT_DISPLAY_NAME`: Human-readable project name
- `I3PM_PROJECT_ICON`: Project icon emoji
- `I3PM_SCOPE`: Application scope (scoped/global)
- `I3PM_ACTIVE`: Boolean string ("true"/"false")
- `I3PM_LAUNCH_TIME`: Unix timestamp
- `I3PM_LAUNCHER_PID`: Wrapper script PID

**Storage**: `/proc/<pid>/environ` (Linux kernel process environment)

**Relations**:
- Injected by: app-launcher-wrapper.sh
- Read by: i3pm daemon window filter

**Access Pattern**:
```python
# Read from /proc filesystem
def read_process_environ(pid: int) -> Dict[str, str]:
    with open(f"/proc/{pid}/environ", "rb") as f:
        data = f.read().decode('utf-8', errors='ignore')
        pairs = data.split('\0')
        return dict(pair.split('=', 1) for pair in pairs if '=' in pair)

env = read_process_environ(window_pid)
project_name = env.get('I3PM_PROJECT_NAME', '')
```

---

## Remote Access Entities

### VNC Session State

**Description**: wayvnc session configuration and state. Replaces XRDP multi-session state from Hetzner.

**Attributes**:
- `enabled`: Boolean for VNC server activation
- `port`: TCP port (integer, default 5900)
- `authentication`: Authentication method (enum: pam, password, none)
- `tls_enabled`: Boolean for encrypted sessions
- `certificate_file`: Path to TLS certificate
- `private_key_file`: Path to TLS private key

**Storage**: `~/.config/wayvnc/config` (TOML)

**Relations**:
- None (standalone service)

**Limitations**:
- Single session (shares active Wayland session, unlike XRDP multi-session)
- No audio forwarding
- No file transfer

**Example**:
```toml
enable_auth=true
enable_pam=true
port=5900
address=0.0.0.0

# Optional TLS
certificate_file=/home/user/.config/wayvnc/tls_cert.pem
private_key_file=/home/user/.config/wayvnc/tls_key.pem
```

---

## Protocol Entities (Unchanged)

The following entities are protocol-level and unchanged from i3:

### i3 IPC Messages
- GET_TREE: Query window tree
- GET_WORKSPACES: Query workspace list
- GET_OUTPUTS: Query display outputs
- GET_MARKS: Query window marks
- COMMAND: Execute commands
- SUBSCRIBE: Subscribe to events

### i3 IPC Events
- window::new, window::close, window::focus, window::move, window::title
- workspace::init, workspace::empty, workspace::focus
- output::added, output::removed, output::changed (monitor hotplug)
- tick (project switch trigger)
- shutdown

All work identically on Sway via i3 IPC protocol.

---

## State Transitions

### Window Lifecycle (Sway-Specific)

1. **Application Launch**:
   - app-launcher-wrapper injects I3PM_* environment variables
   - Application executes with project context
   - Sway creates window container

2. **Window Creation Event** (window::new):
   - Daemon receives event with window ID
   - Reads window properties via IPC (no xprop):
     - `pid = container.ipc_data['pid']`
     - `app_id = container.app_id or container.window_properties.class`
   - Reads /proc/<pid>/environ for I3PM_* variables
   - Applies project mark: `project:nixos:12345`
   - Assigns to workspace based on application registry

3. **Project Switch** (tick event):
   - Daemon queries all windows via GET_TREE
   - Reads I3PM_PROJECT_NAME from /proc for each window
   - Filters windows by project:
     - Matching project: Restore from scratchpad to original workspace
     - Non-matching scoped: Move to scratchpad (hide)
     - Global: Keep visible

4. **State Preservation** (Feature 038):
   - Before scratchpad: Capture floating state, geometry, workspace
   - After restore: Reapply floating state, geometry, workspace assignment

5. **Window Close** (window::close):
   - Daemon removes from tracking
   - Cleanup window-workspace map entry (if expired)

---

## Migration Impact

### Changed Entities
1. **Window State**: Added `app_id` field (Sway-specific), PID access method changed
2. **Display Configuration**: New Sway output configuration format

### Unchanged Entities
1. **Workspace-Monitor Mapping**: Identical schema
2. **Window-Workspace Map**: Identical schema (Feature 038 v1.1)
3. **I3PM Environment Variables**: Identical (OS-level, not WM-dependent)
4. **i3 IPC Protocol Messages**: Identical (Sway compatibility)

### New Entities
1. **VNC Session State**: Replaces XRDP (Wayland remote access)

---

## Validation Rules

### Window Identification
- MUST check `app_id` before `window_properties.class` (Wayland-first)
- MUST handle missing PID gracefully (read from /proc failed)
- MUST validate project mark format: `project:<name>:<id>`

### Display Configuration
- Scale MUST be > 0.0
- Resolution MUST match output capabilities
- Position MUST not cause overlaps (validate via Sway IPC)

### State Persistence
- Window-workspace map MUST use schema v1.1 for state preservation
- Geometry MUST be valid rect (x, y, width > 0, height > 0)
- Workspace numbers MUST be 1-70

---

## Schema Version Compatibility

| Entity | i3 Version | Sway Version | Migration Required |
|--------|------------|--------------|-------------------|
| Window State | N/A | N/A | Code changes only (property access) |
| Window-Workspace Map | v1.1 | v1.1 | ✅ No migration |
| Workspace-Monitor Map | v1.0 | v1.0 | ✅ No migration (update output names only) |
| i3 IPC Protocol | v4.22+ | v1.8+ | ✅ Fully compatible |
