# Data Model: Unified Bar System with Enhanced Workspace Mode

**Feature**: 057-unified-bar-system | **Date**: 2025-11-11
**Purpose**: Entity definitions, relationships, validation rules, and state transitions

---

## Entity Definitions

### 1. ThemeConfig

**Purpose**: Centralized appearance configuration for all bar components

**Fields**:
```python
class ThemeConfig(BaseModel):
    """Centralized theme configuration (appearance.json)"""
    version: str = "1.0"                    # Schema version
    theme: str = "catppuccin-mocha"         # Theme identifier
    colors: ThemeColors                     # Color palette
    fonts: ThemeFonts                       # Font configuration
    workspace_bar: WorkspaceBarConfig       # Bottom bar settings
    top_bar: TopBarConfig                   # Top bar settings
    notification_center: NotificationCenterConfig  # SwayNC settings

class ThemeColors(BaseModel):
    """Catppuccin Mocha color palette"""
    base: str          # #1e1e2e - Background
    mantle: str        # #181825 - Darker background
    surface0: str      # #313244 - Surface layer 1
    surface1: str      # #45475a - Surface layer 2
    overlay0: str      # #6c7086 - Overlay/border
    text: str          # #cdd6f4 - Primary text
    subtext0: str      # #a6adc8 - Dimmed text
    blue: str          # #89b4fa - Accent (focused)
    mauve: str         # #cba6f7 - Border accent
    yellow: str        # #f9e2af - Pending state
    red: str           # #f38ba8 - Urgent/critical
    green: str         # #a6e3a1 - Success
    teal: str          # #94e2d5 - Info

class ThemeFonts(BaseModel):
    """Font configuration"""
    bar: str = "FiraCode Nerd Font"         # Top bar font
    bar_size: float = 8.0                   # Top bar font size (pt)
    workspace: str = "FiraCode Nerd Font"   # Workspace bar font
    workspace_size: float = 11.0            # Workspace bar font size (pt)
    notification: str = "Ubuntu Nerd Font"  # SwayNC font
    notification_size: float = 10.0         # SwayNC font size (pt)

class WorkspaceBarConfig(BaseModel):
    """Bottom bar (Eww) configuration"""
    height: int = 32                        # Bar height (px)
    padding: int = 4                        # Padding (px)
    border_radius: int = 6                  # Border radius (px)
    button_spacing: int = 3                 # Workspace button spacing (px)
    icon_size: int = 16                     # Workspace icon size (px)

class TopBarConfig(BaseModel):
    """Top bar (Swaybar) configuration"""
    position: str = "top"                   # Position: top, bottom
    separator: str = " | "                  # Module separator
    show_tray: bool = True                  # System tray visibility
    show_binding_mode: bool = True          # Binding mode indicator

class NotificationCenterConfig(BaseModel):
    """SwayNC configuration"""
    position_x: str = "right"               # left, center, right
    position_y: str = "top"                 # top, center, bottom
    width: int = 500                        # Notification width (px)
    timeout: int = 10                       # Normal timeout (s)
    timeout_critical: int = 0               # Critical timeout (0 = never)
    grouping: bool = True                   # Notification grouping
```

**Validation Rules**:
- Color fields MUST be valid hex colors (#RRGGBB format)
- Font sizes MUST be 6-24pt
- Workspace bar height MUST be 24-48px
- Notification width MUST be 300-800px
- Timeouts MUST be 0-120 seconds

**Storage**: `~/.config/sway/appearance.json` (generated by Nix)

---

### 2. WorkspacePreview

**Purpose**: Workspace preview card state for Eww overlay

**Fields**:
```python
class WorkspacePreview(BaseModel):
    """Workspace preview overlay state"""
    visible: bool = False                   # Show/hide overlay
    monitor: str = "HEADLESS-1"             # Target monitor output
    workspace_num: int                      # Target workspace number
    workspace_name: Optional[str] = None    # Workspace name (if named)
    mode: str = "goto"                      # "goto" or "move"
    apps: List[WorkspaceApp]                # Applications in workspace
    window_count: int                       # Total window count
    empty: bool = True                      # True if no windows
    invalid: bool = False                   # True if workspace >70 or ≤0
    icon_path: Optional[str] = None         # Primary workspace icon (first app)

class WorkspaceApp(BaseModel):
    """Application in workspace preview"""
    name: str                               # Display name
    icon_path: str = ""                     # Path to icon file
    app_id: Optional[str] = None            # Sway app_id
    window_class: Optional[str] = None      # X11 class
    focused: bool = False                   # Has focus in workspace
```

**Validation Rules**:
- `workspace_num` MUST be 1-70
- `mode` MUST be "goto" or "move"
- `monitor` MUST be valid Sway output name
- `apps` list MUST contain 0-50 entries (UI limitation)
- `visible=True` requires `workspace_num` to be valid

**State Transitions**:
```
1. HIDDEN → PREVIEW_VISIBLE: User types digit(s) in workspace mode
2. PREVIEW_VISIBLE → HIDDEN: User presses Enter (navigate) or Escape (cancel)
3. PREVIEW_VISIBLE → PREVIEW_VISIBLE: User types additional digit (update preview)
```

**Storage**: In-memory (Eww deflisten variable), no persistence

---

### 3. NotificationIcon

**Purpose**: App-aware notification icon resolution

**Fields**:
```python
class NotificationIcon(BaseModel):
    """Notification icon metadata"""
    app_name: str                           # Application name (org.freedesktop.Notifications parameter)
    desktop_entry: Optional[str] = None     # .desktop file name (from hints)
    resolved_icon_path: str                 # Path to resolved icon
    resolution_method: str                  # "registry", "icon_theme", "default"
    app_color_accent: Optional[str] = None  # CSS border color (optional)

class AppIconMapping(BaseModel):
    """Application icon registry entry"""
    app_name: str                           # Registry app name (e.g., "firefox")
    display_name: str                       # Display name
    icon_path: str                          # Path to SVG/PNG icon
    expected_class: Optional[str] = None    # Window class
    notification_match_patterns: List[str] = []  # Patterns for matching notifications
```

**Validation Rules**:
- `resolved_icon_path` MUST exist on filesystem
- `resolution_method` MUST be one of: "registry", "icon_theme", "default"
- `app_color_accent` MUST be valid hex color if present

**Icon Resolution Algorithm**:
```
1. Try application-registry.json lookup by app_name
2. Try pwa-registry.json lookup by ULID (for PWAs)
3. Try desktop entry icon theme lookup ($XDG_DATA_DIRS/icons/)
4. Fall back to generic "application" icon
```

**Storage**: In-memory cache (Python daemon), source: `~/.config/i3/application-registry.json`, `~/.config/i3/pwa-registry.json`

---

### 4. WorkspaceModeState

**Purpose**: Workspace mode navigation state (extends Feature 058)

**Fields**:
```python
class WorkspaceModeState(BaseModel):
    """Workspace mode state (from i3pm daemon)"""
    active: bool = False                    # Mode active/inactive
    mode: str = "goto"                      # "goto" or "move"
    digits_entered: str = ""                # Digits typed so far
    pending_workspace: Optional[int] = None # Target workspace number
    pending_output: Optional[str] = None    # Target monitor output (from Feature 001)
    valid: bool = True                      # True if pending_workspace is valid (1-70)
    timestamp: float                        # Mode entry timestamp

class WorkspaceModeEvent(BaseModel):
    """IPC event broadcast by i3pm daemon"""
    type: str = "workspace_mode"            # Event type
    payload: WorkspaceModeState             # Current state
    previous_state: Optional[WorkspaceModeState] = None  # Previous state (for diffing)
```

**Validation Rules**:
- `mode` MUST be "goto" or "move"
- `digits_entered` MUST be 0-2 digits (workspace numbers 1-70)
- `pending_workspace` MUST be 1-70 if present
- `active=True` requires `digits_entered` to be non-empty

**State Transitions**:
```
1. INACTIVE → ACTIVE (goto): User presses CapsLock
2. INACTIVE → ACTIVE (move): User presses CapsLock + Shift
3. ACTIVE → ACTIVE: User types digit (update digits_entered, pending_workspace)
4. ACTIVE → INACTIVE: User presses Enter (execute) or Escape (cancel)
```

**Storage**: In-memory (i3pm daemon), broadcast via IPC

---

### 5. ThemeReloadEvent

**Purpose**: Theme reload trigger for hot-reloading appearance

**Fields**:
```python
class ThemeReloadEvent(BaseModel):
    """Theme reload event"""
    timestamp: float                        # Reload trigger time
    config_path: str                        # Path to appearance.json
    config_hash: str                        # SHA256 hash of config file
    target_components: List[str]            # Components to reload: ["swaybar", "eww", "swaync"]
    reload_results: Dict[str, ReloadResult] = {}  # Results per component

class ReloadResult(BaseModel):
    """Component reload result"""
    component: str                          # "swaybar", "eww", "swaync"
    success: bool                           # Reload successful
    latency_ms: float                       # Time taken (ms)
    error_message: Optional[str] = None     # Error if failed
```

**Validation Rules**:
- `target_components` MUST contain at least one of: "swaybar", "eww", "swaync"
- `latency_ms` MUST be <5000ms per component
- Total reload time MUST be <3000ms (SC-001 requirement)

**Storage**: In-memory (theme manager daemon), logged for diagnostics

---

## Entity Relationships

```
ThemeConfig (1) ──> (N) Component Configs (SwaybarConfig, EwwConfig, SwayNCConfig)
    │
    └──> (N) ThemeReloadEvent (triggered on config change)

WorkspaceModeState (1) ──> (1) WorkspacePreview (current preview)
    │
    └──> (N) WorkspaceModeEvent (IPC broadcast history)

WorkspacePreview (1) ──> (N) WorkspaceApp (apps in workspace)

NotificationIcon (N) <── (1) AppIconMapping (icon registry entry)

WorkspaceApp.icon_path (N) <── (1) AppIconMapping.icon_path (shared icon source)
```

---

## JSON Schemas

### appearance.json

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "properties": {
    "version": {"type": "string", "enum": ["1.0"]},
    "theme": {"type": "string"},
    "colors": {
      "type": "object",
      "properties": {
        "base": {"type": "string", "pattern": "^#[0-9a-fA-F]{6}$"},
        "surface0": {"type": "string", "pattern": "^#[0-9a-fA-F]{6}$"},
        "blue": {"type": "string", "pattern": "^#[0-9a-fA-F]{6}$"},
        // ... other colors
      },
      "required": ["base", "text", "blue", "mauve"]
    },
    "fonts": {
      "type": "object",
      "properties": {
        "bar": {"type": "string"},
        "bar_size": {"type": "number", "minimum": 6, "maximum": 24}
      }
    }
  },
  "required": ["version", "theme", "colors"]
}
```

### workspace-preview (IPC output)

```json
{
  "visible": true,
  "monitor": "HEADLESS-2",
  "workspace_num": 23,
  "workspace_name": null,
  "mode": "goto",
  "apps": [
    {
      "name": "Firefox",
      "icon_path": "/nix/store/.../firefox.svg",
      "app_id": "firefox",
      "focused": true
    }
  ],
  "window_count": 1,
  "empty": false,
  "invalid": false
}
```

### workspace_mode event (i3pm IPC)

```json
{
  "jsonrpc": "2.0",
  "method": "event",
  "params": {
    "type": "workspace_mode",
    "payload": {
      "active": true,
      "mode": "goto",
      "digits_entered": "23",
      "pending_workspace": 23,
      "pending_output": "HEADLESS-2",
      "valid": true,
      "timestamp": 1699876543.123
    }
  }
}
```

---

## Validation Logic

### ThemeConfig Validation

```python
def validate_theme_config(config: ThemeConfig) -> List[str]:
    """Validate theme configuration, return list of errors."""
    errors = []

    # Validate hex colors
    for color_name, color_value in config.colors.dict().items():
        if not re.match(r'^#[0-9a-fA-F]{6}$', color_value):
            errors.append(f"Invalid hex color for {color_name}: {color_value}")

    # Validate font sizes
    if not (6 <= config.fonts.bar_size <= 24):
        errors.append(f"Bar font size {config.fonts.bar_size} out of range (6-24)")

    # Validate workspace bar height
    if not (24 <= config.workspace_bar.height <= 48):
        errors.append(f"Workspace bar height {config.workspace_bar.height} out of range (24-48)")

    return errors
```

### WorkspacePreview Validation

```python
def validate_workspace_preview(preview: WorkspacePreview) -> bool:
    """Validate workspace preview state."""
    # Check workspace number range
    if not (1 <= preview.workspace_num <= 70):
        preview.invalid = True
        return False

    # Check monitor output exists
    if not is_valid_sway_output(preview.monitor):
        return False

    # Check mode
    if preview.mode not in ["goto", "move"]:
        return False

    # If visible, must have valid workspace_num
    if preview.visible and preview.invalid:
        return False

    return True
```

---

## State Machine: Workspace Mode with Preview

```
States:
  - INACTIVE: Workspace mode not active
  - ACTIVE_GOTO: Goto mode active (CapsLock)
  - ACTIVE_MOVE: Move mode active (CapsLock + Shift)
  - PREVIEW_VISIBLE: Preview card showing
  - EXECUTING: Workspace switch/move in progress

Transitions:
  INACTIVE → ACTIVE_GOTO: press CapsLock
  INACTIVE → ACTIVE_MOVE: press CapsLock + Shift
  ACTIVE_GOTO → PREVIEW_VISIBLE: type digit (0-9)
  ACTIVE_MOVE → PREVIEW_VISIBLE: type digit (0-9)
  PREVIEW_VISIBLE → PREVIEW_VISIBLE: type digit (update workspace_num)
  PREVIEW_VISIBLE → EXECUTING: press Enter
  PREVIEW_VISIBLE → INACTIVE: press Escape
  EXECUTING → INACTIVE: workspace switch complete

Events:
  - workspace_mode_entry(mode)
  - workspace_mode_digit(digit)
  - workspace_mode_execute
  - workspace_mode_cancel
  - workspace_switch_complete
```

---

## Performance Constraints

| Entity | Max Size | Latency Constraint | Memory Constraint |
|--------|----------|-------------------|-------------------|
| ThemeConfig | ~5KB JSON | Load: <100ms | <1MB in-memory |
| WorkspacePreview | ~50 apps max | Update: <50ms | <500KB per preview |
| NotificationIcon | ~200 mappings | Resolve: <20ms | <2MB icon cache |
| WorkspaceModeState | Single instance | Broadcast: <10ms | <1KB |
| ThemeReloadEvent | History: 10 events | Reload: <3s total | <10KB |

---

## Summary

**Total Entities**: 5 core entities (ThemeConfig, WorkspacePreview, NotificationIcon, WorkspaceModeState, ThemeReloadEvent)

**Validation Rules**: 25+ validation constraints (hex colors, font sizes, workspace ranges, timeouts, etc.)

**State Machines**: 1 primary state machine (Workspace Mode with 5 states, 7 transitions)

**Storage**: 3 JSON files (appearance.json, application-registry.json, pwa-registry.json), 4 in-memory structures

**Relationships**: 4 primary relationships (ThemeConfig → Component Configs, WorkspaceModeState → WorkspacePreview, etc.)

**JSON Schemas**: 3 schemas defined (appearance.json, workspace-preview, workspace_mode event)

**Status**: ✅ Data model complete - ready for API contract generation
