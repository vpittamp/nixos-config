# CLI Contract: i3-project-capture

**Version**: 1.0
**Date**: 2025-10-17

## Overview

`i3-project-capture` is a CLI tool for capturing current workspace layouts and generating project configurations. It scans active workspaces, saves layouts, and generates declarative Nix configuration.

---

## Command: i3-project-capture

Capture current workspace arrangement and generate project configuration.

### Syntax

```bash
i3-project-capture <project-name> [OPTIONS]
```

### Arguments

- `<project-name>` (required): Name for the captured project

### Options

- `--workspace <number>`, `-w <number>`: Capture only specific workspace (default: all non-empty)
- `--output-dir <path>`, `-o <path>`: Output directory (default: `~/.config/i3-projects/captured`)
- `--format <format>`, `-f <format>`: Output format: `nix`, `json`, or `both` (default: `both`)
- `--include-empty`: Include empty workspaces in capture
- `--no-layouts`: Skip layout file generation
- `--verbose`, `-v`: Show detailed capture process

### Behavior

1. Query i3 for active workspaces
2. For each workspace (or specific workspace):
   - Skip if empty (unless `--include-empty`)
   - Save layout using `i3-save-tree`
   - Post-process JSON (uncomment swallows criteria)
   - Query window information (WM_CLASS, geometry, etc.)
   - Detect application commands
3. Generate output files:
   - Nix configuration template (`<project-name>.nix`)
   - JSON snapshot (`<project-name>.json`)
   - Layout files (`layouts/<project-name>-ws-<N>.json`)
4. Display summary and next steps

### Exit Codes

- `0`: Success - capture completed
- `1`: No windows to capture
- `2`: i3 communication error
- `3`: File write error
- `4`: Invalid workspace specified

### Output Examples

**Success**:
```
Capturing workspace layout for project 'my-workflow'...

Scanning workspaces:
  Workspace 1 (DP-1): 3 windows
    ● firefox (class: firefox)
    ● alacritty (class: Alacritty)
    ● code (class: Code)
  Workspace 2 (DP-2): 1 window
    ● alacritty (class: Alacritty)
  Workspace 5: empty (skipped)

Generating files:
  ✓ Layout: ~/.config/i3-projects/captured/layouts/my-workflow-ws-1.json
  ✓ Layout: ~/.config/i3-projects/captured/layouts/my-workflow-ws-2.json
  ✓ Nix config: ~/.config/i3-projects/captured/my-workflow.nix
  ✓ JSON snapshot: ~/.config/i3-projects/captured/my-workflow.json

✓ Captured 4 windows across 2 workspaces

Next steps:
  1. Review the generated configuration:
     $EDITOR ~/.config/i3-projects/captured/my-workflow.nix

  2. Move to your home-manager configuration:
     # Add to home-modules/desktop/i3-projects.nix:
     programs.i3Projects.projects.my-workflow = import ./captured/my-workflow.nix;

  3. Rebuild your system:
     sudo nixos-rebuild switch --flake .#hetzner

  4. Activate the project:
     i3-project activate my-workflow
```

**Specific Workspace**:
```
Capturing workspace 3 for project 'dev-env'...

Workspace 3 (DP-1): 2 windows
  ● firefox (class: firefox)
  ● alacritty (class: Alacritty)

✓ Captured 2 windows from workspace 3
Files written to ~/.config/i3-projects/captured/
```

**No Windows**:
```
Error: No windows found to capture
Hint: Make sure you have applications open in your workspaces
Use 'i3-project-capture --include-empty' to capture empty workspaces
```

**Verbose Output**:
```
[DEBUG] Connecting to i3 IPC...
[DEBUG] Querying workspaces...
[DEBUG] Found 10 workspaces, 3 non-empty
[DEBUG] Workspace 1: Saving layout...
[DEBUG] Running: i3-save-tree --workspace 1
[DEBUG] Post-processing layout JSON...
[DEBUG] Querying window tree...
[DEBUG] Window 0x02800003: firefox (Navigator, firefox)
[DEBUG]   Geometry: 0,0 1920x1080
[DEBUG]   Command detected: firefox
[DEBUG] Window 0x02a00001: alacritty (Alacritty, Alacritty)
[DEBUG]   Geometry: 0,1080 1920x1080
[DEBUG]   Working directory: /home/user/projects/api
[DEBUG]   Command detected: alacritty --working-directory=/home/user/projects/api
...
```

---

## Generated Nix Configuration

The tool generates a Nix configuration file ready for integration with home-manager.

### Example Output: `~/.config/i3-projects/captured/my-workflow.nix`

```nix
# Generated by i3-project-capture on 2025-10-17T14:30:00Z
# Project: my-workflow
# Captured from 2 workspaces

{
  displayName = "my-workflow";
  description = "Captured workspace layout";
  primaryWorkspace = "1";
  workingDirectory = null;  # TODO: Set if needed
  enabled = true;

  workspaces = [
    # Workspace 1 (DP-1) - 3 applications
    {
      number = "1";
      outputs = [ "DP-1" ];  # TODO: Add fallback outputs if needed
      layout = /home/user/.config/i3-projects/captured/layouts/my-workflow-ws-1.json;
      applications = [
        {
          package = "firefox";
          command = "firefox";
          wmClass = "firefox";
          wmInstance = "Navigator";
          # TODO: Add arguments if needed
          args = [];
          instanceBehavior = "shared";
          launchDelay = 2.0;
        }
        {
          package = "alacritty";
          command = "alacritty";
          wmClass = "Alacritty";
          workingDirectory = /home/user/projects/api;  # Detected from window
          args = [];
          instanceBehavior = "multi";
          launchDelay = 0.3;
        }
        {
          package = "vscode";
          command = "code";
          wmClass = "Code";
          # TODO: Verify workspace path
          args = [ "/home/user/projects/api" ];
          instanceBehavior = "single";
          launchDelay = 2.0;
        }
      ];
    }

    # Workspace 2 (DP-2) - 1 application
    {
      number = "2";
      outputs = [ "DP-2" ];
      applications = [
        {
          package = "alacritty";
          command = "alacritty";
          wmClass = "Alacritty";
          workingDirectory = /home/user/projects/api;
          args = [];
          instanceBehavior = "multi";
          launchDelay = 0.3;
        }
      ];
    }
  ];
}
```

---

## Generated JSON Snapshot

The tool also generates a JSON snapshot for machine-readable analysis.

### Example Output: `~/.config/i3-projects/captured/my-workflow.json`

```json
{
  "version": "1.0",
  "captured": "2025-10-17T14:30:00Z",
  "capturedBy": "i3-project-capture",
  "hostname": "hetzner",
  "user": "vpittamp",
  "workspaces": [
    {
      "number": "1",
      "name": "1: api ",
      "output": "DP-1",
      "focused": true,
      "visible": true,
      "windows": [
        {
          "id": "0x02800003",
          "wmClass": "firefox",
          "wmInstance": "Navigator",
          "windowRole": null,
          "title": "Mozilla Firefox",
          "geometry": {
            "x": 0,
            "y": 0,
            "width": 1920,
            "height": 1080
          },
          "floating": false,
          "focused": false,
          "pid": 12345,
          "command": "firefox",
          "workingDirectory": "/home/user"
        },
        {
          "id": "0x02a00001",
          "wmClass": "Alacritty",
          "wmInstance": "Alacritty",
          "windowRole": null,
          "title": "user@hetzner: ~/projects/api",
          "geometry": {
            "x": 0,
            "y": 1080,
            "width": 1920,
            "height": 1080
          },
          "floating": false,
          "focused": true,
          "pid": 12346,
          "command": "alacritty",
          "workingDirectory": "/home/user/projects/api"
        }
      ],
      "layoutFile": "/home/user/.config/i3-projects/captured/layouts/my-workflow-ws-1.json"
    }
  ]
}
```

---

## Layout File Post-Processing

The tool automatically post-processes i3-save-tree output to make it usable.

### Changes Made

1. **Uncomment swallows criteria**:
   ```json
   // Before (i3-save-tree output)
   // "swallows": [
   //     {
   //         // "class": "^firefox$"
   //     }
   // ]

   // After (post-processed)
   "swallows": [
       {
           "class": "^firefox$"
       }
   ]
   ```

2. **Remove unnecessary comments**:
   - Removes header comments
   - Removes inline documentation

3. **Optimize matching criteria**:
   - Prefers `class` + `instance` over `title`
   - Adds regex anchors (`^...$`) for exact matching

---

## Detection Heuristics

### Working Directory Detection

For terminal windows, the tool attempts to detect the working directory:

1. Query process tree from window PID
2. Find deepest child process
3. Read `/proc/<pid>/cwd`
4. If successful, add `workingDirectory` to application config

### Command Detection

The tool attempts to detect launch commands:

1. Query process cmdline from window PID: `/proc/<pid>/cmdline`
2. Extract executable and arguments
3. Map executable to nixpkgs package name (heuristic)
4. Generate `command` and `args` fields

### Instance Behavior Detection

Based on known application patterns:

- **Multi-instance**: terminals (Alacritty, kitty), editors (vim, nvim)
- **Single-instance**: IDEs (Code, IntelliJ), browsers (if not using profiles)
- **Shared**: Spotify, Slack, Discord

---

## Limitations and Warnings

### What Can Be Captured

✓ Window positions and sizes
✓ Workspace assignments
✓ Application WM_CLASS values
✓ Window roles and instances
✓ Layout tree structure
✓ Working directories (terminals)

### What Cannot Be Captured

✗ Application internal state (open tabs, unsaved buffers)
✗ Application-specific configurations
✗ Window contents or data
✗ Process environment variables
✗ Complex window relationships (transient windows, groups)

### Warnings in Output

The tool may generate warnings for:

```
⚠ Window 0x02c00005: Could not detect command (PID 12347)
  Manual intervention required in generated config

⚠ Window 0x02d00001: No WM_CLASS (class: null)
  This window may not match correctly on restore

⚠ Workspace 3: Empty workspace included (--include-empty flag)
  Consider removing from generated config
```

---

## Environment Variables

- `I3_PROJECTS_CAPTURE_DIR`: Default output directory (default: `~/.config/i3-projects/captured`)
- `I3_PROJECTS_LAYOUTS_DIR`: Layout files directory (default: `$CAPTURE_DIR/layouts`)

---

## Files

**Input**:
- i3 IPC socket: `/run/user/$UID/i3/ipc-socket.*`
- Process information: `/proc/<pid>/cwd`, `/proc/<pid>/cmdline`

**Output**:
- Nix config: `~/.config/i3-projects/captured/<project-name>.nix`
- JSON snapshot: `~/.config/i3-projects/captured/<project-name>.json`
- Layout files: `~/.config/i3-projects/captured/layouts/<project-name>-ws-<N>.json`

---

## Integration with NixOS Configuration

### Manual Integration

```bash
# 1. Capture workspace
i3-project-capture my-workflow

# 2. Move to NixOS config
mv ~/.config/i3-projects/captured/my-workflow.nix /etc/nixos/home-modules/desktop/i3-projects/

# 3. Import in i3-projects.nix
programs.i3Projects.projects.my-workflow = import ./i3-projects/my-workflow.nix;

# 4. Rebuild
sudo nixos-rebuild switch --flake .#hetzner
```

### Automated Workflow (Future Enhancement)

```bash
# Capture and auto-integrate (not yet implemented)
i3-project-capture my-workflow --integrate

# Would automatically:
# 1. Capture layout
# 2. Generate config
# 3. Add to home-manager configuration
# 4. Trigger rebuild
```

---

**CLI Contract Version**: 1.0
**Last Updated**: 2025-10-17
