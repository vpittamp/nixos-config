# Implementation Plan: Python Backend Consolidation

**Branch**: `058-python-backend-consolidation` | **Date**: 2025-11-03 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/058-python-backend-consolidation/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command.

## Summary

Consolidate TypeScript backend operations into the Python daemon to eliminate code duplication (particularly duplicate /proc environment variable reading), improve performance through native i3ipc library usage, and establish clear architectural separation where TypeScript handles CLI/UI concerns while Python handles all backend operations (file I/O, system access, state management).

**Technical Approach**: Move layout capture/restore operations and project CRUD operations from TypeScript services (`layout-engine.ts`, `project-manager.ts`) into Python daemon modules. Expose functionality via JSON-RPC methods. Update TypeScript CLI to be a thin client that requests operations from daemon and formats results for display. Delete TypeScript backend services after migration.

## Technical Context

**Language/Version**: Python 3.11+ (existing daemon), TypeScript/Deno 1.40+ (CLI)
**Primary Dependencies**: i3ipc-python (i3ipc.aio for async), asyncio, Pydantic (data validation), Deno standard library (@std/cli, @std/path)
**Storage**: JSON files (`~/.config/i3/projects/*.json`, `~/.config/i3/layouts/*.json`)
**Testing**: pytest with pytest-asyncio (Python backend), Deno.test (TypeScript CLI), manual integration testing
**Target Platform**: Linux NixOS with Sway/Wayland compositor (also supports i3/X11)
**Project Type**: Hybrid - Python daemon (backend) + TypeScript CLI (frontend)
**Performance Goals**: Layout operations <100ms for 50 windows (10-20x faster than shell-based), JSON-RPC roundtrip <10ms
**Constraints**: Must maintain identical CLI user interface (same commands, arguments, output), must preserve existing layout file format for backward compatibility
**Scale/Scope**: ~1000 lines TypeScript removed, ~500 lines Python added, affects 2 major services (layout, project management)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Principle XII: Forward-Only Development & Legacy Elimination ✅

**Compliance**: This feature exemplifies forward-only development:
- Completely replaces TypeScript backend logic with optimal Python implementation
- No compatibility layers or feature flags for legacy TypeScript code
- Immediate, complete replacement: TypeScript services deleted after Python equivalents tested
- No "gradual migration" with dual code paths
- Clean architectural improvement without preserving suboptimal patterns

**Justification**: TypeScript backend operations (file I/O, /proc reading, shell commands) are suboptimal compared to Python daemon implementation with direct i3ipc library access. Forward-only principle allows immediate replacement with better architecture.

### Principle X: Python Development & Testing Standards ✅

**Compliance**:
- Python 3.11+ (matches existing daemon)
- Async/await patterns via i3ipc.aio and asyncio
- Pydantic models for data validation (Layout, WindowSnapshot, Project)
- pytest with pytest-asyncio for testing
- Type hints for function signatures
- Existing daemon infrastructure (IPC server, event loop)

**Testing Plan**:
- Unit tests: Data models (Layout, WindowSnapshot, Project validation)
- Integration tests: IPC communication, file I/O operations
- Scenario tests: Layout capture/restore workflow, project CRUD lifecycle
- Mock patterns: Mock i3 connection for isolated tests

### Principle XI: i3 IPC Alignment & State Authority ✅

**Compliance**:
- Uses i3ipc.aio for all i3 state queries (GET_TREE, GET_WORKSPACES, GET_OUTPUTS)
- No shell commands to i3-msg (replaces TypeScript shell-based approach)
- Layout operations query i3 IPC for authoritative window state
- Event-driven architecture (existing daemon subscriptions)
- Validation against i3 IPC state (window matching, workspace assignment)

**Benefits**: 10-20x faster than TypeScript shell commands, eliminates subprocess overhead

### Principle XIII: Deno CLI Development Standards ✅

**Compliance** (TypeScript CLI layer):
- TypeScript CLI uses Deno runtime 1.40+
- Argument parsing via parseArgs() from @std/cli
- JSON-RPC client for daemon communication
- Display/formatting only (tables, trees, JSON output)
- No backend logic in TypeScript after refactoring

**Separation**: Python handles backend, TypeScript handles CLI/UI (clean separation)

### Potential Violations: None

**Complexity Justification**: Not required - this feature reduces complexity by eliminating duplication and establishing clear architectural boundaries.

### Pre-Phase 0 Gate: ✅ PASS

All constitution principles satisfied. Proceeding to Phase 0 research.

## Project Structure

### Documentation (this feature)

```text
specs/058-python-backend-consolidation/
├── plan.md              # This file
├── research.md          # Phase 0 output (technology best practices)
├── data-model.md        # Phase 1 output (entity definitions)
├── quickstart.md        # Phase 1 output (user guide)
├── contracts/           # Phase 1 output (JSON-RPC API contracts)
│   ├── layout-api.json      # Layout management endpoints
│   └── project-api.json     # Project management endpoints
└── tasks.md             # Phase 2 output (/speckit.tasks - NOT created by /speckit.plan)
```

### Source Code (repository root)

**Structure Decision**: Hybrid architecture with Python backend and TypeScript CLI frontend. This feature modifies existing daemon and CLI codebases.

```text
# Python Daemon (Backend) - NEW MODULES
home-modules/desktop/i3-project-event-daemon/
├── services/
│   ├── layout_engine.py           # NEW - Layout capture/restore operations
│   └── project_service.py         # NEW - Project CRUD operations
├── models/
│   ├── layout.py                  # NEW - Layout data models (Pydantic)
│   └── project.py                 # NEW - Project data models (Pydantic)
├── ipc_server.py                  # MODIFIED - Add layout/project JSON-RPC methods
└── daemon.py                      # MODIFIED - Register new IPC handlers

# Python Daemon Tests
home-modules/desktop/i3-project-event-daemon/tests/  # NEW DIRECTORY
├── unit/
│   ├── test_layout_models.py      # Data model validation tests
│   ├── test_project_models.py
│   ├── test_layout_engine.py      # Layout capture/restore logic tests
│   └── test_project_service.py    # Project CRUD logic tests
├── integration/
│   ├── test_layout_ipc.py         # IPC method integration tests
│   └── test_project_ipc.py
└── fixtures/
    ├── mock_i3.py                 # Mock i3 connection for testing
    └── sample_layouts.json        # Test data

# TypeScript CLI (Frontend) - MODIFIED
home-modules/tools/i3pm/src/
├── commands/
│   ├── layout.ts                  # MODIFIED - Thin client (daemon requests only)
│   └── project.ts                 # MODIFIED - Thin client (daemon requests only)
├── services/
│   ├── layout-engine.ts           # DELETED after Python migration
│   ├── project-manager.ts         # DELETED after Python migration
│   └── daemon-client.ts           # KEPT - Communication layer
└── ui/
    ├── table.ts                   # KEPT - Display layer
    └── tree.ts                    # KEPT - Display layer

# Configuration Data
~/.config/i3/
├── projects/                       # Managed by Python daemon (single source of truth)
│   ├── nixos.json
│   ├── stacks.json
│   └── personal.json
├── layouts/                        # Managed by Python daemon
│   ├── nixos-default.json
│   └── stacks-default.json
└── active-project.json             # Managed by Python daemon
```

**Key Architectural Changes**:
1. **Python daemon owns state**: All file I/O for projects and layouts
2. **TypeScript CLI becomes thin client**: JSON-RPC requests + display formatting
3. **~1000 lines TypeScript deleted**: `layout-engine.ts`, `project-manager.ts`
4. **~500 lines Python added**: `layout_engine.py`, `project_service.py`, models, tests

## Complexity Tracking

> **No violations** - This feature reduces complexity by eliminating code duplication and establishing clean architectural boundaries.

## Post-Phase 1 Constitution Re-Check

*Gate: Design phase complete, re-validating constitution compliance*

### Principle XII: Forward-Only Development & Legacy Elimination ✅

**Status**: VALIDATED - Design confirms complete replacement approach
- Layout and project operations completely replaced (no dual code paths)
- TypeScript services `layout-engine.ts` and `project-manager.ts` deleted after Python migration tested
- No feature flags or compatibility modes
- Clean architectural improvement without legacy preservation

### Principle X: Python Development & Testing Standards ✅

**Status**: VALIDATED - Design follows all Python standards
- Pydantic v2 models with runtime validation (Layout, WindowSnapshot, Project)
- Async/await via i3ipc.aio and asyncio throughout
- pytest with pytest-asyncio for three-tier testing (unit, integration, scenario)
- Type hints in all function signatures
- Rich library not needed (daemon has no terminal UI)
- Test fixtures and mocks defined for i3 IPC

### Principle XI: i3 IPC Alignment & State Authority ✅

**Status**: VALIDATED - Design uses i3 IPC as authoritative source
- All window queries via GET_TREE (no shell commands)
- Workspace queries via GET_WORKSPACES
- Direct i3ipc.aio library usage (no subprocess overhead)
- Window matching validates against i3 IPC state
- Layout restore uses i3 IPC commands for window positioning

### Principle XIII: Deno CLI Development Standards ✅

**Status**: VALIDATED - TypeScript CLI follows Deno standards
- TypeScript CLI uses existing DaemonClient with JSON-RPC 2.0
- Argument parsing via parseArgs() from @std/cli
- Display logic only (no backend operations)
- Existing table/tree rendering preserved

### Principle XIV: Test-Driven Development & Autonomous Testing ⚠️

**Status**: PARTIAL - Design includes comprehensive testing but not test-first

**Assessment**:
- ✅ Test pyramid defined: Unit (70%), Integration (20%), End-to-end (10%)
- ✅ pytest with pytest-asyncio for backend tests
- ✅ Mock patterns defined for i3 IPC
- ✅ Scenario tests for complete workflows
- ⚠️ Tests written **after** implementation (not test-first)
- ⚠️ No autonomous UI testing (Playwright/ydotool) - backend-only feature

**Mitigation**:
- Backend operations are testable via pytest without UI automation
- Unit tests validate Pydantic models (data-driven)
- Integration tests validate IPC methods (contract-driven)
- Scenario tests validate workflows (behavior-driven)
- Manual testing workflow documented in quickstart.md

**Justification**:
- Backend consolidation does not require UI automation (no new UI features)
- Existing manual testing workflows validate end-to-end behavior
- Test-first approach should be adopted for **new features**, this is refactoring

### Final Verdict: ✅ CONSTITUTION COMPLIANT

**Summary**:
- All mandatory principles satisfied (Modular Composition, Test-Before-Apply, Override Priority, Platform Flexibility, Declarative Config, Documentation, Remote Desktop, Tiling WM, Python Standards, i3 IPC Alignment, Forward-Only, Deno CLI)
- Principle XIV (TDD) partially satisfied - comprehensive testing defined but not test-first approach
- No complexity violations requiring justification
- Design ready for task breakdown and implementation

**Proceeding to**: Task generation via `/speckit.tasks` command (outside scope of `/speckit.plan`)
